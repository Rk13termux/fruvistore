name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create environment file with all secrets
        run: |
          echo "# Fruvi Store - Production Environment Variables" > .env
          echo "# Generated automatically by GitHub Actions with secrets" >> .env
          echo "" >> .env
          echo "# Supabase Users Database (Original)" >> .env
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL || 'https://your-users-project.supabase.co' }}" >> .env
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY || 'your-users-anon-key' }}" >> .env
          echo "VITE_SUPABASE_SERVICE_ROLE_KEY=${{ secrets.VITE_SUPABASE_SERVICE_ROLE_KEY || 'your-users-service-key' }}" >> .env
          echo "" >> .env
          echo "# Supabase Products Database (New)" >> .env
          echo "VITE_SUPABASE_PRODUCTS_URL=${{ secrets.VITE_SUPABASE_PRODUCTS_URL || 'https://your-products-project.supabase.co' }}" >> .env
          echo "VITE_SUPABASE_PRODUCTS_ANON_KEY=${{ secrets.VITE_SUPABASE_PRODUCTS_ANON_KEY || 'your-products-anon-key' }}" >> .env
          echo "VITE_SUPABASE_PRODUCTS_SERVICE_ROLE_KEY=${{ secrets.VITE_SUPABASE_PRODUCTS_SERVICE_ROLE_KEY || 'your-products-service-key' }}" >> .env
          echo "" >> .env
          echo "# AI Services Configuration" >> .env
          echo "VITE_GROQ_API_KEY=${{ secrets.VITE_GROQ_API_KEY || 'placeholder-groq-key' }}" >> .env
          echo "VITE_GROQ_MODEL=${{ secrets.VITE_GROQ_MODEL || 'llama3-8b-8192' }}" >> .env
          echo "" >> .env
          echo "# Telegram Integration" >> .env
          echo "VITE_TELEGRAM_BOT_TOKEN=${{ secrets.VITE_TELEGRAM_BOT_TOKEN || 'placeholder-telegram-bot-token' }}" >> .env
          echo "VITE_TELEGRAM_CHAT_ID=${{ secrets.VITE_TELEGRAM_CHAT_ID || 'placeholder-telegram-chat-id' }}" >> .env
          echo "" >> .env
          echo "# Admin Panel Security" >> .env
          echo "VITE_ADMIN_USER=${{ secrets.VITE_ADMIN_USER || 'admin' }}" >> .env
          echo "VITE_ADMIN_PASSWORD=${{ secrets.VITE_ADMIN_PASSWORD || 'password' }}" >> .env
          echo "VITE_ADMIN_API_KEY=${{ secrets.VITE_ADMIN_API_KEY || 'placeholder-admin-key' }}" >> .env
          echo "VITE_ADMIN_PASSWORD_HASH=${{ secrets.VITE_ADMIN_PASSWORD_HASH || 'placeholder-hash' }}" >> .env
          echo "VITE_ENABLE_ADMIN_PANEL=${{ secrets.VITE_ENABLE_ADMIN_PANEL || 'true' }}" >> .env

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

# ============================================================================
# INSTRUCCIONES PARA CONFIGURAR GITHUB SECRETS
# ============================================================================
# 
# Para que tu web funcione correctamente en GitHub Pages, necesitas configurar
# estos secrets en tu repositorio:
#
# 1. Ve a: https://github.com/tu-usuario/tu-repo/settings/secrets/actions
# 2. Click "New repository secret" para cada variable:
#
# üîß SUPABASE (Base de datos - REQUERIDO):
#    VITE_SUPABASE_URL = https://tu-proyecto.supabase.co
#    VITE_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
#
# ü§ñ GROQ AI (Asistente inteligente - REQUERIDO):
#    VITE_GROQ_API_KEY = gsk_xxxxxxxxxxxxxxxxxxxx
#
# üì± TELEGRAM (Notificaciones - OPCIONAL):
#    VITE_TELEGRAM_BOT_TOKEN = 1234567890:AAAA-BBBBccccDDDDeeeeFFFfgggHHH
#    VITE_TELEGRAM_CHAT_ID = -1001234567890
#
# üîê ADMIN (Panel administrativo - OPCIONAL):
#    VITE_ADMIN_API_KEY = tu_clave_secreta_para_admin
#
# 3. Activa GitHub Pages:
#    Settings ‚Üí Pages ‚Üí Source: GitHub Actions
#
# 4. Push a main branch para desplegar autom√°ticamente
# ============================================================================
