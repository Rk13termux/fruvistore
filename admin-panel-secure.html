<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - FruviStore</title>
    <link rel="stylesheet" href="../styles/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-store"></i>
                <span>FruviStore Admin</span>
            </div>
            <nav class="main-nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-btn" onclick="showSection('store')">
                    <i class="fas fa-store"></i> Tienda
                </button>
                <button class="nav-btn" onclick="showSection('boxes')">
                    <i class="fas fa-box"></i> Cajas
                </button>
                <button class="nav-btn" onclick="showSection('credits')">
                    <i class="fas fa-coins"></i> Créditos
                </button>
            </nav>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="content-section active">
            <div id="dashboard-content">
                <!-- Dashboard will be loaded here -->
            </div>
        </section>

        <!-- Store Management Section -->
        <section id="store-section" class="content-section">
            <div id="store-management-content">
                <!-- Store management will be loaded here -->
            </div>
        </section>

        <!-- Boxes Management Section -->
        <section id="boxes-section" class="content-section">
            <div id="boxes-management-content">
                <!-- Boxes management will be loaded here -->
            </div>
        </section>

        <!-- Credits Management Section -->
        <section id="credits-section" class="content-section">
            <div id="credits-management-content">
                <!-- Credits management will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script type="module">
        // Authentication check
        function checkAdminAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTimeRaw = localStorage.getItem('adminLoginTime');
            const loginTime = loginTimeRaw ? parseInt(loginTimeRaw, 10) : 0;

            if (!isLoggedIn || !loginTime || Number.isNaN(loginTime)) {
                window.location.replace('./secure-access.html');
                return false;
            }

            // Check if session expired (1 hour)
            if (Date.now() - loginTime > 60 * 60 * 1000) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminUser');
                window.location.replace('./secure-access.html');
                return false;
            }

            return true;
        }

        // Section navigation
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            const targetButton = document.querySelector(`[onclick="showSection('${sectionName}')"]`);

            if (targetSection) {
                targetSection.classList.add('active');
            }
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // Load section content dynamically
            loadSectionContent(sectionName);
        };

        // Load section content
        async function loadSectionContent(sectionName) {
            try {
                switch(sectionName) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'store':
                        await loadStoreManagement();
                        break;
                    case 'boxes':
                        await loadBoxesManagement();
                        break;
                    case 'credits':
                        await loadCreditsManagement();
                        break;
                }
            } catch (error) {
                console.error('Error loading section:', sectionName, error);
            }
        }

        // Load dashboard
        async function loadDashboard() {
            const container = document.getElementById('dashboard-content');
            if (!container) return;

            try {
                // Import and initialize dashboard
                const { default: adminDashboard } = await import('./adminDashboard.js');
                await adminDashboard.initialize('dashboard-content');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error cargando dashboard</div>';
            }
        }

        // Load store management
        async function loadStoreManagement() {
            const container = document.getElementById('store-management-content');
            if (!container) return;

            try {
                // Import and initialize store management
                const { default: storeManagement } = await import('./storeManagement.js');
                await storeManagement.initialize('store-management-content');
            } catch (error) {
                console.error('Error loading store management:', error);
                container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error cargando gestión de tienda</div>';
            }
        }

        // Load boxes management
        async function loadBoxesManagement() {
            const container = document.getElementById('boxes-management-content');
            if (!container) return;

            try {
                // Import and initialize boxes management
                const { default: boxesManagement } = await import('./boxesManagement.js');
                await boxesManagement.initialize('boxes-management-content');
            } catch (error) {
                console.error('Error loading boxes management:', error);
                container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error cargando gestión de cajas</div>';
            }
        }

        // Load credits management
        async function loadCreditsManagement() {
            const container = document.getElementById('credits-management-content');
            if (!container) return;

            try {
                // Import and initialize credits management
                const { default: creditsManagement } = await import('./creditsManagement.js');
                await creditsManagement.initialize('credits-management-content');
            } catch (error) {
                console.error('Error loading credits management:', error);
                container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error cargando gestión de créditos</div>';
            }
        }

        // Logout function
        window.logout = function() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminLoginTime');
            localStorage.removeItem('adminUser');
            window.location.replace('./secure-access.html');
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAdminAuth()) {
                return; // Will redirect if not authenticated
            }

            // Load dashboard by default
            showSection('dashboard');
        });
    </script>
</body>
</html>