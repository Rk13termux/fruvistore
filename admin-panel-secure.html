<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Fruvi Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script>
        // Verificar autenticación de admin (SISTEMA SEGURO)
        function checkAdminAuth() {
            const isAuthenticated = localStorage.getItem('adminAuthenticated');
            const authTime = localStorage.getItem('adminAuthTime');
            const adminUser = localStorage.getItem('adminUser') || 'Admin';
            const now = Date.now();
            const sessionDuration = 30 * 60 * 1000; // 30 minutos de sesión
            
            // Verificación múltiple de seguridad
            if (!isAuthenticated || 
                isAuthenticated !== 'true' ||
                !authTime || 
                (now - parseInt(authTime)) > sessionDuration) {
                
                // Limpiar cualquier dato de sesión
                localStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('adminAuthTime');
                localStorage.removeItem('adminUser');
                
                // Redirigir al acceso seguro
                window.location.href = './secure-access.html';
                return false;
            }
            
            // Renovar sesión si queda menos de 5 minutos
            if ((now - parseInt(authTime)) > (25 * 60 * 1000)) {
                localStorage.setItem('adminAuthTime', now.toString());
            }
            
            // Mostrar información del usuario en el header
            setTimeout(() => {
                updateHeaderUserInfo(adminUser);
            }, 100);
            
            return true;
        }
        
        // Actualizar información del usuario en el header
        function updateHeaderUserInfo(username) {
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement) {
                const loginTimeStamp = localStorage.getItem('adminLoginTime');
                let timeString = 'Ahora';
                
                if (loginTimeStamp) {
                    const loginTime = new Date(parseInt(loginTimeStamp));
                    timeString = loginTime.toLocaleTimeString();
                } else {
                    // Si no hay timestamp guardado, usar el actual
                    const now = Date.now();
                    localStorage.setItem('adminLoginTime', now.toString());
                    timeString = new Date(now).toLocaleTimeString();
                }
                
                userInfoElement.innerHTML = `
                    <span class="user-welcome">
                        <i class="fas fa-user-shield"></i>
                        Bienvenido, <strong>${username}</strong>
                    </span>
                    <span class="login-time">Sesión iniciada: ${timeString}</span>
                `;
            }
        }
        
        // Verificar auth al cargar la página
        if (!checkAdminAuth()) {
            // Si no está autenticado, detener la carga
            document.body.style.display = 'none';
        }
        
        // Función para cerrar sesión (SISTEMA SEGURO)
        function logout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                // Limpiar TODA la información de sesión
                localStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('adminAuthTime');
                localStorage.removeItem('adminUser');
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                
                // Limpiar también sessionStorage por seguridad
                sessionStorage.clear();
                
                // Animación de salida
                document.body.style.opacity = '0';
                document.body.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    window.location.href = './secure-access.html';
                }, 300);
            }
        }

        // 🔔 SISTEMA DE NOTIFICACIONES PUSH
        let notificationQueue = [];
        let notificationId = 0;

        // Función principal para mostrar notificaciones
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = createNotificationElement(type, title, message, duration);
            container.appendChild(notification);

            // Mostrar con animación
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto-cerrar
            if (duration > 0) {
                notification.classList.add('auto-close');
                notification.style.setProperty('--duration', `${duration}ms`);
                
                setTimeout(() => {
                    closeNotification(notification);
                }, duration);
            }

            return notification;
        }

        // Crear elemento de notificación
        function createNotificationElement(type, title, message, duration) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.setAttribute('data-id', ++notificationId);

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="${icons[type] || icons.info}"></i>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="closeNotification(this.parentElement)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Auto-cerrar con progreso
            if (duration > 0) {
                notification.style.setProperty('--duration', `${duration}ms`);
            }

            return notification;
        }

        // Cerrar notificación
        function closeNotification(notification) {
            notification.classList.add('hide');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 400);
        }

        // Métodos de conveniencia
        function showSuccess(title, message, duration = 4000) {
            return showNotification('success', title, message, duration);
        }

        function showError(title, message, duration = 6000) {
            return showNotification('error', title, message, duration);
        }

        function showWarning(title, message, duration = 5000) {
            return showNotification('warning', title, message, duration);
        }

        function showInfo(title, message, duration = 4000) {
            return showNotification('info', title, message, duration);
        }

        // Limpiar todas las notificaciones
        function clearAllNotifications() {
            const container = document.getElementById('notificationContainer');
            if (container) {
                container.innerHTML = '';
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@500;600;700&display=swap');

        :root {
            --bg: #0b0f14;
            --surface: rgba(255,255,255,0.06);
            --surface-strong: rgba(255,255,255,0.12);
            --border: rgba(255,255,255,0.14);
            --txt: #e9eef5;
            --muted: #9aa6b2;
            --brand: #ff9b40; /* vibrant orange */
            --brand-2: #8bda01; /* vibrant green */
            --accent: #ff8bd3; /* pink */
            --warn: #f39c12;
            --glass-bg: rgba(255,255,255,0.04);
            --glass-border: rgba(255,255,255,0.08);
            --font-body: 'Inter', 'Segoe UI', sans-serif;
            --font-heading: 'Inter', 'Segoe UI', sans-serif;
            --font-menu: 'Montserrat', 'Inter', 'Segoe UI', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: #000000 !important;
            min-height: 100vh;
            color: var(--txt);
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-header {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--brand), transparent);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left h1 {
            color: var(--txt);
            font-family: var(--font-heading);
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 0.5rem 0;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-left h1 i {
            margin-right: 0.75rem;
            color: var(--brand);
        }

        .header-left p {
            color: var(--muted);
            margin: 0;
            font-size: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-direction: column;
            text-align: right;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 0.5rem;
        }

        .user-welcome {
            color: var(--txt);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .user-welcome i {
            color: var(--brand);
            margin-right: 0.5rem;
        }

        .login-time {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .logout-btn {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff6b6b;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.2);
            border-color: rgba(255, 59, 48, 0.5);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-right {
                flex-direction: row;
                justify-content: center;
                text-align: center;
            }
            
            .user-info {
                align-items: center;
                margin-bottom: 0;
                margin-right: 1rem;
            }
        }

        .admin-header h1 i {
            color: var(--brand);
        }

        .admin-header p {
            color: var(--muted);
            font-size: 1.1rem;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .admin-card {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            border-color: var(--brand);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .card-header i {
            font-size: 1.5rem;
            color: var(--brand);
        }

        .card-header h3 {
            color: var(--txt);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: #ffffff;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-menu);
            letter-spacing: 0.04em;
            transition: all 0.3s ease;
            margin: 0.25rem;
            box-shadow: 0 4px 20px rgba(255, 155, 64, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 155, 64, 0.4);
        }

        .btn-secondary {
            background: var(--surface-strong);
            color: var(--txt);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 30px rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #c44569);
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 30px rgba(255, 71, 87, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--brand-2), #20c997);
            box-shadow: 0 4px 20px rgba(139, 218, 1, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 8px 30px rgba(139, 218, 1, 0.4);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--txt);
            font-family: var(--font-body);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--glass-bg);
            color: var(--txt);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(255, 155, 64, 0.2);
            transform: translateY(-1px);
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: var(--muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            color: var(--txt);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--brand), var(--brand-2));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--brand);
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .label {
            font-size: 0.95rem;
            color: var(--muted);
            font-weight: 500;
        }

        /* Elegant Product Tables - Similar to Registration Style */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            margin: 1rem 0;
        }

        .table-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: transparent;
            border-radius: 15px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        thead th {
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th:first-child {
            border-top-left-radius: 15px;
        }

        thead th:last-child {
            border-top-right-radius: 15px;
        }

        tbody tr {
            background: white;
            transition: all 0.3s ease;
        }

        tbody tr:nth-child(even) {
            background: rgba(248, 249, 250, 0.5);
        }

        tbody tr:hover {
            background: linear-gradient(135deg, rgba(139, 218, 1, 0.1) 0%, rgba(255, 155, 64, 0.1) 100%);
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        tbody td {
            padding: 1rem;
            text-align: left;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            color: #333;
        }

        tbody td:first-child {
            font-weight: 600;
            color: #1e3c72;
        }

        /* Product Table Specific Styles */
        .product-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #1e3c72;
        }

        .product-category {
            background: linear-gradient(45deg, #8bda01, #7bc200);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .stock-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-low {
            color: #dc3545;
            font-weight: bold;
            background: rgba(220, 53, 69, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .stock-good {
            color: #28a745;
            font-weight: bold;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .price-display {
            font-weight: 600;
            color: #2a5298;
            font-size: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-sm.btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-sm.btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff9b40);
            color: white;
        }

        .btn-sm.btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn-sm.btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        /* Supabase Configuration Elegant Styles - Similar to Registration */
        .supabase-config-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .supabase-config-shell {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .supabase-config-shell:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
        }

        .supabase-config-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .config-eyebrow {
            color: #8bda01;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .supabase-config-header h3 {
            color: #1e3c72;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .supabase-config-header p {
            color: #666;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .config-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .config-status-badge.connected {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .supabase-config-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .supabase-config-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(to right, #e0e0e0, #e0e0e0);
            z-index: 1;
        }

        .config-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .config-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-step.is-active .config-badge {
            background: linear-gradient(45deg, #ff9b40, #8bda01);
            color: white;
            transform: scale(1.1);
        }

        .config-step.is-completed .config-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .config-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #666;
        }

        .config-step.is-active .config-label {
            color: #1e3c72;
        }

        .config-section-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .config-section-title h4 {
            color: #1e3c72;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .config-section-title p {
            color: #666;
            font-size: 0.9rem;
        }

        .config-form-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-form-group {
            position: relative;
        }

        .config-form-group label {
            display: block;
            color: #1e3c72;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .config-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .config-form-group input:focus {
            outline: none;
            border-color: #8bda01;
            box-shadow: 0 0 0 3px rgba(139, 218, 1, 0.1);
            transform: translateY(-1px);
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper button {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .password-wrapper button:hover {
            color: #1e3c72;
            background: rgba(139, 218, 1, 0.1);
        }

        .field-hint {
            display: block;
            color: #666;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .field-hint i {
            margin-right: 0.25rem;
            opacity: 0.7;
        }

        .config-form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        }

        .config-info-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .info-panel-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1e3c72;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .info-panel-header i {
            color: #8bda01;
        }

        .info-steps {
            display: grid;
            gap: 1rem;
        }

        .info-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9b40, #8bda01);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content strong {
            color: #1e3c72;
            display: block;
            margin-bottom: 0.25rem;
        }

        .step-content p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .step-content a {
            color: #8bda01;
            text-decoration: none;
            font-weight: 600;
        }

        .step-content a:hover {
            color: #7bc200;
            text-decoration: underline;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            color: var(--txt);
        }

        .alert-success {
            border-left-color: var(--brand-2);
            background: rgba(139, 218, 1, 0.1);
        }

        .alert-warning {
            border-left-color: var(--warn);
            background: rgba(243, 156, 18, 0.1);
        }

        .alert-danger {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .loading i {
            margin-right: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Professional Dashboard Analytics */
        .dashboard-analytics {
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .charts-section {
            margin-bottom: 2rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }

        .chart-card {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .chart-header h3 {
            color: var(--txt);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-header h3 i {
            color: var(--brand);
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--txt);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .btn-chart {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--brand);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-chart:hover {
            background: var(--brand);
            color: #ffffff;
            transform: rotate(180deg);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        /* Responsive Charts */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        /* Product Management Section */
        .product-management {
            margin-bottom: 2rem;
        }

        .management-header {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .management-header h2 {
            color: var(--txt);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .management-header h2 i {
            color: var(--brand);
        }

        .management-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .management-header {
                flex-direction: column;
                text-align: center;
            }
            
            .management-actions {
                justify-content: center;
            }
        }

        /* Add Product Modal */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            color: var(--txt);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .modal-header h3 i {
            color: var(--brand);
        }

        .modal-close {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--txt);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--brand);
            color: #ffffff;
        }

        .product-form {
            color: var(--txt);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            color: var(--txt);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--glass-bg);
            border: 2px solid var(--border);
            color: var(--txt);
            padding: 0.875rem 1rem;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(255, 155, 64, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--muted);
        }

        /* 🎨 MEJORAS: Estilos para dropdowns/selects - MEJORADO */
        .form-group select,
        .input-group select,
        select {
            background: #1a1f2e !important;
            border: 2px solid rgba(255,255,255,0.14) !important;
            color: #e9eef5 !important;
            backdrop-filter: blur(10px);
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }

        /* Estilos FORZADOS para las opciones del select */
        .form-group select option,
        .input-group select option,
        select option {
            background-color: #0b0f14 !important;
            background: #0b0f14 !important;
            color: #e9eef5 !important;
            padding: 8px 12px !important;
            border: none !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        }

        /* Estados de las opciones */
        .form-group select option:checked,
        .input-group select option:checked,
        select option:checked {
            background-color: #ff9b40 !important;
            background: #ff9b40 !important;
            color: #000000 !important;
        }

        .form-group select option:hover,
        .input-group select option:hover,
        select option:hover {
            background-color: #333333 !important;
            background: #333333 !important;
            color: #ffffff !important;
        }

        /* Select específicos para productos - FORZADO */
        #priceProductSelect,
        #stockProductSelect,
        #manageProductSelect,
        .chart-select {
            background: #000000 !important;
            border: 2px solid rgba(255,155,64,0.3) !important;
            color: #ffffff !important;
            backdrop-filter: blur(10px);
        }

        #priceProductSelect option,
        #stockProductSelect option,
        #manageProductSelect option,
        .chart-select option {
            background-color: #000000 !important;
            background: #000000 !important;
            color: #ffffff !important;
            padding: 10px 15px !important;
            font-weight: 500 !important;
        }

        /* Webkit específico para dropdowns */
        select::-webkit-scrollbar {
            width: 8px;
        }

        select::-webkit-scrollbar-track {
            background: #000000;
        }

        select::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }

        select::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        #priceProductSelect option,
        #stockProductSelect option,
        #manageProductSelect option {
            background: #000000 !important;
            color: #ffffff !important;
            padding: 0.75rem 1rem !important;
        }

        /* 🔔 SISTEMA DE NOTIFICACIONES PUSH */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .notification {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            cursor: pointer;
            max-width: 380px;
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--brand);
        }

        .notification.success::before {
            background: var(--brand-2);
        }

        .notification.error::before {
            background: var(--danger);
        }

        .notification.warning::before {
            background: var(--warn);
        }

        .notification.info::before {
            background: var(--accent);
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification.success .notification-icon {
            color: var(--brand-2);
        }

        .notification.error .notification-icon {
            color: var(--danger);
        }

        .notification.warning .notification-icon {
            color: var(--warn);
        }

        .notification.info .notification-icon {
            color: var(--accent);
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            color: var(--txt);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .notification-message {
            color: var(--muted);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
            margin-left: 8px;
            transition: color 0.2s ease;
        }

        .notification-close:hover {
            color: var(--txt);
        }

        /* Progreso de auto-cierre */
        .notification::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            width: 100%;
            transform-origin: left;
            transform: scaleX(0);
            transition: transform linear;
        }

        .notification.auto-close::after {
            transform: scaleX(1);
        }

        .checkbox-group {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--txt);
            font-weight: 500;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 95vh;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-actions {
                justify-content: center;
            }
        }

        #modal.hidden {
            display: none !important;
            visibility: hidden;
            opacity: 0;
        }

        .flex {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        /* 🔧 ESTILOS ADICIONALES PARA DROPDOWNS - ULTRA FORZADO */
        * select {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        * select option {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
            padding: 8px !important;
        }

        /* Para navegadores Webkit */
        select option {
            background: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        /* Para Firefox */
        @-moz-document url-prefix() {
            select option {
                background-color: #0b0f14 !important;
                color: #e9eef5 !important;
            }
        }

        /* Para Edge/IE */
        select option {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        /* Estilos globales específicos */
        select[id*="Select"],
        select[id*="product"],
        select[id*="stock"],
        select[id*="price"],
        select[id*="manage"] {
            background: #000000 !important;
            color: #ffffff !important;
        }

        select[id*="Select"] option,
        select[id*="product"] option,
        select[id*="stock"] option,
        select[id*="price"] option,
        select[id*="manage"] option {
            background-color: #000000 !important;
            background: #000000 !important;
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <!-- 🔔 Contenedor de Notificaciones Push -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-store"></i>
                        Panel de Administración - Fruvi Store
                    </h1>
                    <p>Gestión completa de productos, precios e inventario</p>
                </div>
                <div class="header-right">
                    <div class="user-info" id="userInfo">
                        <!-- Se llena dinámicamente con JavaScript -->
                    </div>
                    <button class="logout-btn" onclick="logout()" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Verificando conexión con Supabase...
        </div>



        <!-- Professional Dashboard Analytics -->
        <div class="dashboard-analytics">
            <!-- Main Stats Overview -->
            <div id="statsContainer" class="stats-grid">
                <!-- Stats will be populated here -->
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="charts-grid">
                    <!-- Categories Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Distribución por Categorías</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshCategoriesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoriesChart"></canvas>
                        </div>
                    </div>

                    <!-- Prices Trend Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Tendencia de Precios</h3>
                            <div class="chart-controls">
                                <select id="pricesPeriod" class="chart-select">
                                    <option value="week">Última Semana</option>
                                    <option value="month" selected>Último Mes</option>
                                    <option value="quarter">Último Trimestre</option>
                                </select>
                                <button class="btn-chart" onclick="refreshPricesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="pricesChart"></canvas>
                        </div>
                    </div>

                    <!-- Stock Levels Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Niveles de Stock</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshStockChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-dollar-sign"></i> Valor de Inventario</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshRevenueChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Management Section -->
        <div class="product-management">
            <div class="management-header">
                <h2><i class="fas fa-cogs"></i> Gestión de Productos</h2>
                <div class="management-actions">
                    <button class="btn btn-success" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                    <button class="btn" onclick="showAllProducts()">
                        <i class="fas fa-list"></i> Ver Todos
                    </button>
                    <button class="btn btn-secondary" onclick="exportProducts()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="admin-grid">
            <!-- Price Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-dollar-sign"></i>
                    <h3>Gestión de Precios</h3>
                </div>
                
                <div class="input-group">
                    <label for="priceProductSelect">Producto:</label>
                    <select id="priceProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="newPrice">Nuevo Precio (COP):</label>
                    <input type="number" id="newPrice" step="100" min="0" placeholder="5000">
                </div>
                
                <div class="input-group">
                    <label for="priceReason">Razón del cambio:</label>
                    <input type="text" id="priceReason" placeholder="Actualización de mercado">
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn" onclick="updateSinglePrice()">
                        <i class="fas fa-edit"></i> Actualizar Precio
                    </button>
                    <button class="btn btn-secondary" onclick="viewPriceHistory()">
                        <i class="fas fa-history"></i> Ver Historial
                    </button>
                </div>

                <!-- Bulk Price Updates -->
                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">
                
                <div class="input-group">
                    <label for="categorySelect">Categoría para aumento masivo:</label>
                    <select id="categorySelect">
                        <option value="">Todas las categorías</option>
                        <option value="Bayas">Bayas</option>
                        <option value="Bananos">Bananos</option>
                        <option value="Cítricas">Cítricas</option>
                        <option value="Exóticas">Exóticas</option>
                        <option value="Frutas Dulces">Frutas Dulces</option>
                        <option value="Tropicales">Tropicales</option>
                        <option value="Uvas">Uvas</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="increasePercent">Porcentaje de aumento:</label>
                    <input type="number" id="increasePercent" step="0.1" min="0" max="50" placeholder="5.0">
                </div>
                
                <button class="btn btn-danger" onclick="applyBulkIncrease()">
                    <i class="fas fa-percentage"></i> Aplicar Aumento
                </button>
            </div>

            <!-- Inventory Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-boxes"></i>
                    <h3>Gestión de Inventario</h3>
                </div>
                
                <div class="input-group">
                    <label for="stockProductSelect">Producto:</label>
                    <select id="stockProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="stockChange">Cambio en stock (kg):</label>
                    <input type="number" id="stockChange" step="1" placeholder="+50 o -25">
                </div>
                
                <div class="input-group">
                    <label for="stockReason">Razón del cambio:</label>
                    <input type="text" id="stockReason" placeholder="Reposición de inventario">
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn btn-success" onclick="updateStock()">
                        <i class="fas fa-plus"></i> Actualizar Stock
                    </button>
                    <button class="btn btn-secondary" onclick="showLowStock()">
                        <i class="fas fa-exclamation-triangle"></i> Stock Bajo
                    </button>
                    <button class="btn" onclick="showAllProducts()">
                        <i class="fas fa-list"></i> Ver Todos los Productos
                    </button>
                </div>

                <div id="currentStock" class="mt-2">
                    <!-- Current stock info will appear here -->
                </div>
            </div>

            <!-- Product Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-cogs"></i>
                    <h3>Gestión de Productos</h3>
                </div>
                
                <div class="input-group">
                    <label for="manageProductSelect">Producto:</label>
                    <select id="manageProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn btn-success" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                    <button class="btn" onclick="editSelectedProduct()">
                        <i class="fas fa-edit"></i> Editar Producto
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedProduct()">
                        <i class="fas fa-trash"></i> Eliminar Producto
                    </button>
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                <div class="input-group">
                    <label for="productStatus">Cambiar estado:</label>
                    <select id="productStatus">
                        <option value="">Seleccionar estado...</option>
                        <option value="active">Activar Producto</option>
                        <option value="inactive">Desactivar Producto</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="updateProductStatus()">
                    <i class="fas fa-toggle-on"></i> Cambiar Estado
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-lightning-bolt"></i>
                    <h3>Acciones Rápidas</h3>
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn" onclick="loadInventoryReport()">
                        <i class="fas fa-chart-bar"></i> Reporte Inventario
                    </button>
                    <button class="btn btn-secondary" onclick="loadDailyReport()">
                        <i class="fas fa-calendar-day"></i> Reporte Diario
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Exportar Datos
                    </button>
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                <!-- CSV Import -->
                <div class="input-group">
                    <label for="csvFile">Importar precios desde CSV:</label>
                    <input type="file" id="csvFile" accept=".csv">
                    <small style="color: #666; font-size: 0.85rem;">
                        Formato: product_id, new_price, reason
                    </small>
                </div>
                
                <button class="btn btn-secondary" onclick="importPricesFromCSV()">
                    <i class="fas fa-upload"></i> Importar CSV
                </button>
            </div>

            <!-- Reports and Analytics -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    <h3>Reportes y Análisis</h3>
                </div>
                
                <div id="reportContainer">
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        <i class="fas fa-info-circle"></i>
                        Selecciona una acción para ver reportes
                    </p>
                </div>
            </div>
        </div>

        <!-- Modal for detailed views -->
        <div id="modal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        ">
            <div style="
                background: var(--glass-bg);
                backdrop-filter: saturate(140%) blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                padding: 2rem;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
                color: var(--txt);
            ">
                <button onclick="closeModal()" style="
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: var(--surface);
                    border: 1px solid var(--border);
                    font-size: 1.2rem;
                    cursor: pointer;
                    color: var(--txt);
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                ">
                    <i class="fas fa-times"></i>
                </button>
                <div id="modalContent">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="addProductModal" class="product-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeAddProductModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h3>
                    <button onclick="closeAddProductModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addProductForm" class="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productName">Nombre del Producto *</label>
                            <input type="text" id="productName" name="name" required 
                                   placeholder="Ej: Mango Tommy">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Categoría *</label>
                            <select id="productCategory" name="category" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="Cítricas">Cítricas</option>
                                <option value="Tropicales">Tropicales</option>
                                <option value="Bayas">Bayas</option>
                                <option value="Bananos">Bananos</option>
                                <option value="Exóticas">Exóticas</option>
                                <option value="Frutas Dulces">Frutas Dulces</option>
                                <option value="Uvas">Uvas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Precio por Kg (COP) *</label>
                            <input type="number" id="productPrice" name="price" required 
                                   min="100" step="100" placeholder="5000">
                        </div>
                        <div class="form-group">
                            <label for="productCost">Costo por Kg (COP)</label>
                            <input type="number" id="productCost" name="cost" 
                                   min="0" step="100" placeholder="3000">
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Inicial (Kg)</label>
                            <input type="number" id="productStock" name="stock" 
                                   min="0" step="1" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="productMinStock">Stock Mínimo (Kg)</label>
                            <input type="number" id="productMinStock" name="minStock" 
                                   min="0" step="1" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label for="productOrigin">Origen</label>
                            <input type="text" id="productOrigin" name="origin" 
                                   placeholder="Colombia" value="Colombia">
                        </div>
                        <div class="form-group">
                            <label for="productSupplier">Proveedor</label>
                            <input type="text" id="productSupplier" name="supplier" 
                                   placeholder="Nombre del proveedor">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productRating">Calificación</label>
                            <select id="productRating" name="rating">
                                <option value="5">⭐⭐⭐⭐⭐ (5.0)</option>
                                <option value="4.5">⭐⭐⭐⭐⭐ (4.5)</option>
                                <option value="4" selected>⭐⭐⭐⭐ (4.0)</option>
                                <option value="3.5">⭐⭐⭐⭐ (3.5)</option>
                                <option value="3">⭐⭐⭐ (3.0)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" name="description" rows="3" 
                                  placeholder="Descripción del producto..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="productImage">URL de la Imagen</label>
                        <input type="url" id="productImage" name="image" 
                               placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productOrganic" name="organic">
                            <span class="checkmark"></span>
                            Producto Orgánico
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="productActive" name="active" checked>
                            <span class="checkmark"></span>
                            Producto Activo
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddProductModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crear Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="./scripts/services/storeService.js"></script>
    <script src="./scripts/services/productManager.js"></script>
    <script>
        let productManager;
        let allProducts = [];

        // Auto-initialize using store service
        async function initializeFromEnv() {
            try {
                console.log('🔧 Inicializando panel de administración con storeService...');
                
                // Wait a bit for services to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check if store service is loaded and initialized
                if (typeof window.checkProductsConfig !== 'function') {
                    console.warn('⚠️ StoreService no está cargado, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                // Check products configuration
                const productsConfig = window.checkProductsConfig();
                console.log('📋 Configuración de productos:', productsConfig);
                
                if (!productsConfig.configured) {
                    console.warn('⚠️ Configuración automática falló, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                if (!productsConfig.initialized) {
                    console.warn('⚠️ Inicialización automática falló, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                // Test products database connection
                const productsConnected = await window.testProductsConnection();
                
                if (productsConnected) {
                    updateConnectionStatus(true, '✅ Conectado a base de datos de productos');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                } else {
                    updateConnectionStatus('warning', '⚠️ Cliente inicializado, verificando tablas...');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-exclamation-triangle"></i> Verificando', '#ffc107');
                }
                
                // Check users database (using original supabase service)
                try {
                    if (window.checkSupabaseConfig && typeof window.checkSupabaseConfig === 'function') {
                        const usersConfig = window.checkSupabaseConfig();
                        if (usersConfig.valid) {
                            updateElementSafely('usersDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                        } else {
                            updateElementSafely('usersDbStatus', '<i class="fas fa-exclamation-triangle"></i> Revisar', '#ffc107');
                        }
                    } else {
                        updateElementSafely('usersDbStatus', '<i class="fas fa-info-circle"></i> No cargado', '#6c757d');
                    }
                } catch (userDbError) {
                    updateElementSafely('usersDbStatus', '<i class="fas fa-exclamation-triangle"></i> Error', '#ffc107');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Error inicializando desde storeService:', error);
                console.log('🔄 Intentando modo manual...');
                return await initializeManualMode();
            }
        }

        // Manual initialization mode with hardcoded values
        async function initializeManualMode() {
            try {
                console.log('🔧 Inicializando en modo manual...');
                
                // Check if Supabase library is available
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Biblioteca Supabase no está cargada');
                }
                
                // Hardcoded values from .env file
                const productsUrl = 'https://xujenwuefrgxfsiqjqhl.supabase.co';
                const productsKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1amVud3VlZnJneGZzaXFqcWhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTExNTYsImV4cCI6MjA3NjU2NzE1Nn0.89UAEW8CVBkz8lEAdnJzt0XJNo0C4lCrZMBBcRYKmMs';
                
                // Create products client manually
                window.productsClient = window.supabase.createClient(productsUrl, productsKey, {
                    auth: {
                        storageKey: 'fruvi-admin-products-auth',
                        autoRefreshToken: false,
                        persistSession: false
                    }
                });
                window.supabaseClient = window.productsClient; // For backward compatibility
                
                console.log('✅ Cliente de productos creado manualmente');
                
                // Test connection
                const { data, error } = await window.productsClient
                    .from('management_products')
                    .select('id')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "management_products" does not exist')) {
                        updateConnectionStatus('warning', '⚠️ Conexión exitosa, pero falta ejecutar los scripts SQL de productos');
                        updateElementSafely('productsDbStatus', '<i class="fas fa-exclamation-triangle"></i> Tablas pendientes', '#ffc107');
                    } else {
                        throw new Error('Error conectando a base de productos: ' + error.message);
                    }
                } else {
                    updateConnectionStatus(true, '✅ Conectado a base de datos de productos (modo manual)');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                }
                
                // Set users status as separate
                updateElementSafely('usersDbStatus', '<i class="fas fa-info-circle"></i> Separado', '#17a2b8');
                
                return true;
                
            } catch (error) {
                console.error('❌ Error en modo manual:', error);
                updateConnectionStatus(false, 'Error en inicialización manual: ' + error.message);
                updateElementSafely('productsDbStatus', '<i class="fas fa-times-circle"></i> Error', '#dc3545');
                return false;
            }
        }

        // Initialize
        async function init() {
            console.log('🚀 Iniciando panel de administración...');
            
            try {
                // Initialize from environment variables
                const envInitialized = await initializeFromEnv();
                
                if (!envInitialized) {
                    throw new Error('No se pudo inicializar desde variables de entorno');
                }
                
                // Wait for storeService to be ready, then initialize product manager
                await waitForStoreService();
                
                if (window.initProductManager && typeof window.initProductManager === 'function') {
                    productManager = window.initProductManager();
                    if (!productManager) {
                        console.warn('⚠️ ProductManager initialization failed, using store service directly');
                    }
                } else {
                    console.warn('⚠️ ProductManager not available, using store service directly');
                }
                
                await loadInitialData();
                
                console.log('✅ Panel de administración inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando panel:', error);
                updateConnectionStatus(false, error.message);
            }
        }

        // Product manager using store service functions
        // Wait for storeService to be loaded
        async function waitForStoreService() {
            console.log('⏳ Esperando a que storeService esté listo...');
            
            let attempts = 0;
            const maxAttempts = 50; // 5 segundos máximo
            
            while (attempts < maxAttempts) {
                if (window.productsClient && typeof window.getStoreProducts === 'function') {
                    console.log('✅ StoreService está listo');
                    return true;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.warn('⚠️ StoreService no se cargó completamente');
            return false;
        }

        function createStoreProductManager() {
            return {
                getAllProducts: async () => {
                    if (typeof window.getAllProducts === 'function') {
                        return await window.getAllProducts();
                    } else {
                        throw new Error('Función getAllProducts no disponible en storeService');
                    }
                },
                
                updateProductPrice: async (productId, newPrice, reason, updatedBy = 'admin') => {
                    if (typeof window.updateProductPrice === 'function') {
                        return await window.updateProductPrice(productId, newPrice, reason, updatedBy);
                    } else {
                        return { success: false, error: 'Función updateProductPrice no disponible' };
                    }
                },
                
                updateStock: async (productId, quantityChange, reason) => {
                    if (typeof window.updateStock === 'function') {
                        return await window.updateStock(productId, quantityChange, reason);
                    } else {
                        return { success: false, error: 'Función updateStock no disponible' };
                    }
                },
                
                getInventoryReport: async () => {
                    if (typeof window.getInventoryReport === 'function') {
                        return await window.getInventoryReport();
                    } else {
                        return { report: null, products: [] };
                    }
                },
                
                getLowStockProducts: async () => {
                    if (typeof window.getLowStockProducts === 'function') {
                        return await window.getLowStockProducts();
                    } else {
                        return [];
                    }
                },

                applyPriceIncrease: async (category, percent, reason) => {
                    try {
                        const products = await this.getAllProducts();
                        const categoryProducts = category ? 
                            products.filter(p => p.category === category) : 
                            products;

                        let updatedCount = 0;
                        const errors = [];

                        for (const product of categoryProducts) {
                            const newPrice = Math.round(product.price_per_kg * (1 + percent / 100));
                            const result = await this.updateProductPrice(product.id, newPrice, reason);
                            
                            if (result.success) {
                                updatedCount++;
                            } else {
                                errors.push(`${product.name}: ${result.error}`);
                            }
                        }

                        return {
                            success: updatedCount > 0,
                            updatedCount,
                            totalProducts: categoryProducts.length,
                            errors
                        };
                    } catch (error) {
                        return {
                            success: false,
                            error: error.message,
                            updatedCount: 0,
                            totalProducts: 0,
                            errors: []
                        };
                    }
                }
            };
        }

        async function waitForSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const check = () => {
                    console.log(`🔄 Checking Supabase... Attempt ${attempts + 1}`);
                    
                    // Check if Supabase library is loaded
                    if (window.supabase) {
                        console.log('✅ Supabase library loaded');
                        
                        // Check if functions are available
                        if (window.setupSupabase && window.initializeSupabase) {
                            console.log('✅ Supabase functions available');
                            
                            // Check if client is initialized
                            if (window.supabaseClient) {
                                console.log('✅ Supabase client initialized');
                                resolve();
                            } else {
                                console.log('⚠️ Supabase client not initialized');
                                if (attempts < maxAttempts) {
                                    attempts++;
                                    setTimeout(check, 300);
                                } else {
                                    reject(new Error('Supabase client not initialized. Please run setupSupabase("URL", "KEY") in console first.'));
                                }
                            }
                        } else {
                            console.log('⚠️ Supabase functions not available yet');
                            if (attempts < maxAttempts) {
                                attempts++;
                                setTimeout(check, 300);
                            } else {
                                reject(new Error('Supabase service functions not loaded.'));
                            }
                        }
                    } else {
                        console.log('⚠️ Supabase library not loaded yet');
                        if (attempts < maxAttempts) {
                            attempts++;
                            setTimeout(check, 200);
                        } else {
                            reject(new Error('Supabase library not loaded. Please check your internet connection.'));
                        }
                    }
                };
                
                check();
            });
        }

        // Safe element update function
        function updateElementSafely(elementId, content, color = null) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = content;
                if (color) {
                    element.style.color = color;
                }
            } else {
                console.log(`ℹ️ Element '${elementId}' not found, skipping update: ${content}`);
            }
        }

        function updateConnectionStatus(connected, message = null) {
            const statusEl = document.getElementById('connectionStatus');
            
            if (connected === true) {
                statusEl.className = 'alert alert-success';
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message || 'Conectado a Supabase correctamente'}`;
                if (!message || !message.includes('Probando')) {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            } else if (connected === false) {
                statusEl.className = 'alert alert-danger';
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message || 'Error de conexión'}`;
                statusEl.style.display = 'block';
            } else {
                // Neutral/warning status
                statusEl.className = 'alert alert-warning';
                statusEl.innerHTML = `<i class="fas fa-info-circle"></i> ${message || 'Verificando conexión...'}`;
                statusEl.style.display = 'block';
            }
        }

        async function loadInitialData() {
            try {
                console.log('🔄 Cargando datos iniciales del admin panel...');
                
                // Load products for dropdowns using storeService directly
                if (typeof window.getAllProducts === 'function') {
                    allProducts = await window.getAllProducts();
                } else if (typeof window.getStoreProducts === 'function') {
                    allProducts = await window.getStoreProducts();
                } else {
                    console.warn('⚠️ Using fallback method to get products');
                    allProducts = [];
                }
                
                populateProductSelects();
                
                // Load stats
                await loadStats();
                
                console.log(`📊 Loaded ${allProducts.length} products`);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Error cargando datos iniciales: ' + error.message, 'danger');
            }
        }

        function populateProductSelects() {
            const priceSelect = document.getElementById('priceProductSelect');
            const stockSelect = document.getElementById('stockProductSelect');
            const manageSelect = document.getElementById('manageProductSelect');
            
            // Clear existing options
            priceSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            stockSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            manageSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            allProducts.forEach(product => {
                const option1 = new Option(`${product.name} (${product.category})`, product.id);
                const option2 = new Option(`${product.name} (${product.stock_kg}kg)`, product.id);
                const option3 = new Option(`${product.name} - ${product.available ? 'Activo' : 'Inactivo'}`, product.id);
                
                priceSelect.appendChild(option1);
                stockSelect.appendChild(option2);
                manageSelect.appendChild(option3);
            });
        }

        async function loadStats() {
            try {
                // Use storeService directly instead of productManager
                let report, products;
                
                if (typeof window.getInventoryReport === 'function') {
                    const result = await window.getInventoryReport();
                    report = result.report || result;
                    products = result.products || allProducts;
                } else {
                    // Fallback: calculate stats from allProducts
                    products = allProducts;
                    const lowStockProducts = products.filter(p => (p.stock || 0) <= (p.min_stock || 0));
                    const categories = {};
                    products.forEach(p => {
                        if (p.category) {
                            categories[p.category] = (categories[p.category] || 0) + 1;
                        }
                    });
                    
                    report = {
                        totalProducts: products.length,
                        totalStock: products.reduce((sum, p) => sum + (p.stock || 0), 0),
                        lowStockProducts: lowStockProducts,
                        lowStockCount: lowStockProducts.length,
                        outOfStockProducts: products.filter(p => (p.stock || 0) === 0),
                        totalValue: products.reduce((sum, p) => sum + ((p.stock || 0) * (p.priceKg || p.price_per_kg || 0)), 0),
                        categories: categories
                    };
                }
                
                if (report) {
                    const statsContainer = document.getElementById('statsContainer');
                    if (!statsContainer) {
                        console.warn('Stats container not found');
                        return;
                    }
                    
                    const activeProducts = products.filter(p => p.available);
                    const avgPrice = products.length > 0 ? products.reduce((sum, p) => sum + p.price_per_kg, 0) / products.length : 0;
                    
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <i class="fas fa-boxes"></i>
                            <div class="value">${report.totalProducts}</div>
                            <div class="label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle"></i>
                            <div class="value">${activeProducts.length}</div>
                            <div class="label">Productos Activos</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="value">${report.lowStockCount || 0}</div>
                            <div class="label">Stock Bajo</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-dollar-sign"></i>
                            <div class="value">${formatPrice(report.totalValue || 0)}</div>
                            <div class="label">Valor Total</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-tag"></i>
                            <div class="value">${formatPrice(avgPrice)}</div>
                            <div class="label">Precio Promedio</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-layer-group"></i>
                            <div class="value">${report.categories ? Object.keys(report.categories).length : 0}</div>
                            <div class="label">Categorías</div>
                        </div>
                    `;
                    statsContainer.classList.remove('hidden');
                    
                    // Load charts after stats
                    await loadCharts(report, products);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load all charts
        async function loadCharts(report, products) {
            try {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded yet, retrying in 1 second...');
                    setTimeout(() => loadCharts(report, products), 1000);
                    return;
                }
                
                loadCategoriesChart(report.categories);
                loadPricesChart(products);
                loadStockChart(products);
                loadRevenueChart(report.categories);
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        // Global functions for buttons
        window.updateSinglePrice = async function() {
            const productId = document.getElementById('priceProductSelect').value;
            const newPrice = parseFloat(document.getElementById('newPrice').value);
            const reason = document.getElementById('priceReason').value || 'Manual update';
            
            if (!productId || !newPrice || newPrice <= 0) {
                showWarning('Campos incompletos', 'Por favor completa todos los campos con valores válidos');
                return;
            }
            
            try {
                showLoading('Actualizando precio...');
                
                // Obtener nombre del producto para el mensaje
                const productSelect = document.getElementById('priceProductSelect');
                const productName = productSelect.options[productSelect.selectedIndex].text;
                
                const result = await productManager.updateProductPrice(productId, newPrice, reason, 'admin');
                
                if (result.success) {
                    showSuccess(
                        '💰 Precio actualizado',
                        `${productName} ahora cuesta $${newPrice.toLocaleString('es-CO')}`
                    );
                    await loadInitialData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('newPrice').value = '';
                    document.getElementById('priceReason').value = '';
                } else {
                    showError(
                        '❌ Error al cambiar precio',
                        result.error || 'No se pudo actualizar el precio del producto'
                    );
                }
            } catch (error) {
                showError(
                    '💥 Error del sistema',
                    `Error inesperado: ${error.message}`
                );
            } finally {
                hideLoading();
            }
        };

        window.applyBulkIncrease = async function() {
            const category = document.getElementById('categorySelect').value;
            const percent = parseFloat(document.getElementById('increasePercent').value);
            
            if (!percent) {
                showAlert('Por favor ingresa el porcentaje de aumento', 'warning');
                return;
            }
            
            const confirmMsg = category 
                ? `¿Aplicar ${percent}% de aumento a la categoría "${category}"?`
                : `¿Aplicar ${percent}% de aumento a TODOS los productos?`;
                
            if (!confirm(confirmMsg)) return;
            
            try {
                showLoading('Aplicando aumento masivo...');
                
                let result;
                if (category) {
                    result = await productManager.applyPriceIncrease(
                        category, 
                        percent, 
                        `Bulk increase ${percent}% - ${category}`
                    );
                } else {
                    result = await window.applyInflationIncrease(percent);
                }
                
                showAlert(`Aumento aplicado correctamente`, 'success');
                await loadInitialData(); // Refresh data
                
                // Clear form
                document.getElementById('increasePercent').value = '';
            } catch (error) {
                showAlert('Error aplicando aumento: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        window.updateStock = async function() {
            const productId = document.getElementById('stockProductSelect').value;
            const stockChange = parseInt(document.getElementById('stockChange').value);
            const reason = document.getElementById('stockReason').value || 'Manual adjustment';
            
            // Validaciones mejoradas
            if (!productId || productId === '' || productId === 'undefined') {
                showWarning('Producto no seleccionado', 'Por favor selecciona un producto válido');
                return;
            }
            
            if (isNaN(stockChange) || stockChange === 0) {
                showWarning('Cantidad inválida', 'Por favor ingresa una cantidad válida diferente de cero');
                return;
            }
            
            try {
                showLoading('Actualizando inventario...');
                
                // Obtener nombre del producto para el mensaje
                const productSelect = document.getElementById('stockProductSelect');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const productName = selectedOption ? selectedOption.text : 'Producto desconocido';
                
                const result = await productManager.updateStock(productId, stockChange, reason);
                
                if (result.success) {
                    const actionText = stockChange > 0 ? 'agregado' : 'reducido';
                    showSuccess(
                        '✅ Inventario actualizado', 
                        `Se ha ${actionText} ${Math.abs(stockChange)} unidades de ${productName}`
                    );
                    await loadInitialData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('stockChange').value = '';
                    document.getElementById('stockReason').value = '';
                } else {
                    showError(
                        '❌ Error en inventario', 
                        result.error || 'No se pudo actualizar el inventario'
                    );
                }
            } catch (error) {
                showError(
                    '💥 Error del sistema', 
                    `Error inesperado: ${error.message}`
                );
            } finally {
                hideLoading();
            }
        };

        // Función para abrir el modal de stock con un producto preseleccionado
        window.openStockModal = function(productId) {
            if (!productId) {
                showWarning('Error', 'ID de producto no válido');
                return;
            }
            
            // Pre-seleccionar el producto en el dropdown
            const stockSelect = document.getElementById('stockProductSelect');
            if (stockSelect) {
                stockSelect.value = productId;
                
                // Scroll a la sección de stock
                const stockSection = document.querySelector('[id*="stock"]').closest('.admin-card');
                if (stockSection) {
                    stockSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Focus en el campo de cantidad
                const stockChangeInput = document.getElementById('stockChange');
                if (stockChangeInput) {
                    setTimeout(() => {
                        stockChangeInput.focus();
                    }, 500);
                }
            }
        };

        window.showLowStock = async function() {
            try {
                showLoading('Cargando productos con stock bajo...');
                const lowStockProducts = await productManager.getLowStockProducts();
                
                if (lowStockProducts.length === 0) {
                    showAlert('¡Excelente! No hay productos con stock bajo', 'success');
                    return;
                }
                
                let html = `
                    <h3>Productos con Stock Bajo (${lowStockProducts.length})</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Stock Actual</th>
                                    <th>Stock Mínimo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lowStockProducts.forEach(product => {
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-apple-alt" style="color: #8bda01;"></i>
                                    ${product.name}
                                </div>
                            </td>
                            <td>
                                <span class="product-category">${product.category}</span>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-low">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${product.stock_kg}kg
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span style="color: #666; font-weight: 500;">${product.min_stock_kg}kg</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-success" onclick="restockProduct(${product.id}, ${product.min_stock_kg * 2})">
                                        <i class="fas fa-plus"></i> Reabastecer
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                showModal(html);
            } catch (error) {
                showAlert('Error cargando productos con stock bajo: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        window.loadInventoryReport = async function() {
            try {
                showLoading('Generando reporte de inventario...');
                const { report, products } = await productManager.getInventoryReport();
                
                let html = `
                    <h3>Reporte Completo de Inventario</h3>
                    <div class="stats-grid mb-2">
                        <div class="stat-card">
                            <div class="value">${report.totalProducts}</div>
                            <div class="label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${formatPrice(report.totalValue)}</div>
                            <div class="label">Valor Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${report.lowStockCount}</div>
                            <div class="label">Stock Bajo</div>
                        </div>
                    </div>
                    
                    <h4>Por Categoría</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th>Productos</th>
                                    <th>Stock Total</th>
                                    <th>Valor</th>
                                    <th>Stock Bajo</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(report.categories).forEach(([category, data]) => {
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-tags" style="color: #2a5298;"></i>
                                    <strong>${category}</strong>
                                </div>
                            </td>
                            <td>
                                <span style="background: rgba(42, 82, 152, 0.1); color: #2a5298; padding: 0.25rem 0.5rem; border-radius: 8px; font-weight: 600;">
                                    ${data.count} productos
                                </span>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-good">
                                        <i class="fas fa-weight"></i>
                                        ${data.totalStock}kg
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="price-display">
                                    <i class="fas fa-dollar-sign"></i>
                                    ${formatPrice(data.totalValue)}
                                </span>
                            </td>
                            <td>
                                ${data.lowStock > 0 ? 
                                    `<span class="stock-low">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${data.lowStock}
                                    </span>` : 
                                    `<span class="stock-good">
                                        <i class="fas fa-check-circle"></i>
                                        0
                                    </span>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                showModal(html);
            } catch (error) {
                showAlert('Error generando reporte: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Show All Products in Elegant Table
        window.showAllProducts = async function() {
            try {
                showLoading('Cargando todos los productos...');
                const products = await productManager.getAllProducts();
                
                if (products.length === 0) {
                    showAlert('No hay productos en la base de datos', 'warning');
                    return;
                }
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Catálogo Completo de Productos (${products.length})</h3>
                        <div class="action-buttons">
                            <button class="btn-sm btn-success" onclick="addNewProduct()">
                                <i class="fas fa-plus"></i> Nuevo Producto
                            </button>
                            <button class="btn-sm btn-info" onclick="exportProducts()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="table-container" style="max-height: 600px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Precio Actual</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                products.forEach(product => {
                    const stockStatus = product.stock_kg <= product.min_stock_kg ? 'low' : 'good';
                    const isOrganic = product.organic ? '<i class="fas fa-leaf" style="color: #28a745; margin-left: 0.5rem;" title="Orgánico"></i>' : '';
                    
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-apple-alt" style="color: #8bda01;"></i>
                                    ${product.name}
                                    ${isOrganic}
                                </div>
                                <small style="color: #666; margin-left: 1.5rem;">
                                    ${product.origin || 'Colombia'}
                                </small>
                            </td>
                            <td>
                                <span class="product-category">${product.category}</span>
                            </td>
                            <td>
                                <span class="price-display">
                                    <i class="fas fa-dollar-sign"></i>
                                    ${formatPrice(product.price_per_kg)}/kg
                                </span>
                                <br>
                                <small style="color: #666;">
                                    Costo: ${formatPrice(product.cost_per_kg)}/kg
                                </small>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-${stockStatus}">
                                        <i class="fas fa-${stockStatus === 'low' ? 'exclamation-triangle' : 'check-circle'}"></i>
                                        ${product.stock_kg}kg
                                    </span>
                                </div>
                                <small style="color: #666;">
                                    Mín: ${product.min_stock_kg}kg
                                </small>
                            </td>
                            <td>
                                <span style="
                                    background: ${product.available ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'};
                                    color: ${product.available ? '#28a745' : '#dc3545'};
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 8px;
                                    font-size: 0.8rem;
                                    font-weight: 600;
                                ">
                                    <i class="fas fa-${product.available ? 'check' : 'times'}"></i>
                                    ${product.available ? 'Disponible' : 'No disponible'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-info" onclick="editProduct(${product.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-sm btn-warning" onclick="updatePrice(${product.id})" title="Cambiar precio">
                                        <i class="fas fa-tag"></i>
                                    </button>
                                    <button class="btn-sm btn-success" onclick="openStockModal(${product.id})" title="Actualizar stock">
                                        <i class="fas fa-boxes"></i>
                                    </button>
                                    <button class="btn-sm btn-danger" onclick="deleteProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')" title="Eliminar producto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                // Add summary stats at the bottom
                const totalValue = products.reduce((sum, p) => sum + (p.stock_kg * p.price_per_kg), 0);
                const lowStockCount = products.filter(p => p.stock_kg <= p.min_stock_kg).length;
                const availableCount = products.filter(p => p.available).length;
                
                html += `
                    <div class="stats-grid" style="margin-top: 1.5rem;">
                        <div class="stat-card">
                            <i class="fas fa-box"></i>
                            <div class="value">${products.length}</div>
                            <div class="label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle"></i>
                            <div class="value">${availableCount}</div>
                            <div class="label">Disponibles</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="value">${lowStockCount}</div>
                            <div class="label">Stock Bajo</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-dollar-sign"></i>
                            <div class="value">${formatPrice(totalValue)}</div>
                            <div class="label">Valor Total</div>
                        </div>
                    </div>
                `;
                
                showModal(html);
            } catch (error) {
                showAlert('Error cargando productos: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Utility functions
        function showAlert(message, type = 'info') {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                `;
            } else {
                console.log(`Alert (${type}): ${message}`);
            }
        }

        function showLoading(message = 'Cargando...') {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        ${message}
                    </div>
                `;
            } else {
                console.log(`Loading: ${message}`);
            }
        }

        function hideLoading() {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        <i class="fas fa-info-circle"></i>
                        Selecciona una acción para ver reportes
                    </p>
                `;
            }
        }

        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            if (modal && modalContent) {
                modalContent.innerHTML = content;
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
            } else {
                console.warn('⚠️ Modal elements not found');
            }
        }

        window.closeModal = function() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
        };

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Función de emergencia para forzar cierre
        window.forceCloseModal = function() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.classList.add('hidden');
                console.log('✅ Modal forzado a cerrarse');
            }
        };

        // Environment configuration info
        window.showEnvironmentInfo = function() {
            const instructions = `
                <h3>� Configuración del Sistema</h3>
                
                <div style="text-align: left; line-height: 1.6;">
                    <div style="background: rgba(139, 218, 1, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h4 style="color: #1e3c72; margin-bottom: 1rem;">
                            <i class="fas fa-info-circle"></i> Sistema de Doble Base de Datos
                        </h4>
                        <p style="color: #666; margin-bottom: 1rem;">
                            El panel de administración utiliza un sistema dual de bases de datos para mejor organización:
                        </p>
                        <ul style="color: #666; margin-left: 1rem;">
                            <li><strong>Base de Usuarios:</strong> Maneja registros, login y perfiles</li>
                            <li><strong>Base de Productos:</strong> Maneja inventario, precios y administración</li>
                        </ul>
                    </div>
                    
                    <h4 style="color: #1e3c72;">📋 Variables de Entorno Configuradas</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.85rem;">
                        • VITE_SUPABASE_PRODUCTS_URL<br>
                        • VITE_SUPABASE_PRODUCTS_ANON_KEY<br>
                        • VITE_SUPABASE_URL (usuarios)<br>
                        • VITE_SUPABASE_ANON_KEY (usuarios)
                    </div>
                    
                    <h4 style="color: #1e3c72;">🚀 Para GitHub Pages</h4>
                    <ol style="color: #666;">
                        <li>Las variables están configuradas en el archivo <code>.env</code></li>
                        <li>GitHub Actions las utiliza automáticamente durante el build</li>
                        <li>El archivo <code>GITHUB-SECRETS.md</code> tiene instrucciones completas</li>
                                <li><strong>Database Password:</strong> Una contraseña segura</li>
                                <li><strong>Region:</strong> South America (más cerca de Colombia)</li>
                            </ul>
                        </li>
                        <li>Haz clic en <strong>"Create new project"</strong></li>
                        <li>⏳ Espera 2-3 minutos mientras se crea</li>
                    </ol>
                    
                    <h4>🔑 Paso 2: Obtener credenciales</h4>
                    <ol>
                        <li>Una vez creado el proyecto, ve a <strong>Settings → API</strong></li>
                        <li>Busca la sección <strong>"Project API keys"</strong></li>
                        <li>Copia estos dos valores:
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace;">
                                <strong>Project URL:</strong> https://tu-proyecto.supabase.co<br>
                                <strong>anon public:</strong> eyJhbGciOiJIUzI1NiIs...
                            </div>
                        </li>
                        <li>Pega estos valores en el formulario de arriba</li>
                    </ol>
                    
                    <h4>🗃️ Paso 3: Crear tablas (ejecutar SQL)</h4>
                    <ol>
                        <li>En tu proyecto de Supabase, ve a <strong>SQL Editor</strong></li>
                        <li>Ejecuta estos scripts en orden:
                            <div style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;">
                                -- 1. Primero ejecutar: setup-supabase-products.sql<br>
                                -- 2. Después ejecutar: insert-colombian-fruits.sql
                            </div>
                        </li>
                        <li>Los archivos SQL están en la carpeta <code>scripts/database/</code></li>
                    </ol>
                    
                    <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 1rem; border-radius: 8px; margin-top: 2rem;">
                        <strong>✅ ¡Listo!</strong> Una vez completados estos pasos, tu panel de administración podrá gestionar los precios e inventario de las 67 frutas colombianas.
                    </div>
                </div>
            `;
            
            showModal(instructions);
        };

        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(price);
        }

        // Chart instances
        let categoriesChart, pricesChart, stockChart, revenueChart;

        // Categories Distribution Chart
        function loadCategoriesChart(categories) {
            const ctx = document.getElementById('categoriesChart');
            if (!ctx) {
                console.warn('Categories chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (categoriesChart) {
                categoriesChart.destroy();
            }

            const labels = Object.keys(categories);
            const data = Object.values(categories).map(cat => cat.count);
            const colors = [
                'rgba(255, 155, 64, 0.8)',   // brand
                'rgba(139, 218, 1, 0.8)',    // brand-2
                'rgba(255, 139, 211, 0.8)',  // accent
                'rgba(243, 156, 18, 0.8)',   // warn
                'rgba(64, 196, 255, 0.8)',   // blue
                'rgba(255, 99, 132, 0.8)',   // red
                'rgba(75, 192, 192, 0.8)'    // teal
            ];

            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e9eef5',
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // Prices Trend Chart
        function loadPricesChart(products) {
            const ctx = document.getElementById('pricesChart');
            if (!ctx) {
                console.warn('Prices chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (pricesChart) {
                pricesChart.destroy();
            }

            // Group products by category and calculate average prices
            const categoryPrices = {};
            products.forEach(product => {
                if (!categoryPrices[product.category]) {
                    categoryPrices[product.category] = [];
                }
                categoryPrices[product.category].push(product.price_per_kg);
            });

            const labels = Object.keys(categoryPrices);
            const avgPrices = labels.map(category => {
                const prices = categoryPrices[category];
                return prices.reduce((sum, price) => sum + price, 0) / prices.length;
            });

            pricesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precio Promedio (COP/kg)',
                        data: avgPrices,
                        borderColor: '#ff9b40',
                        backgroundColor: 'rgba(255, 155, 64, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ff9b40',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Precio: ${formatPrice(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Stock Levels Chart
        function loadStockChart(products) {
            const ctx = document.getElementById('stockChart');
            if (!ctx) {
                console.warn('Stock chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (stockChart) {
                stockChart.destroy();
            }

            // Sort products by stock level and take top 10
            const sortedProducts = products
                .sort((a, b) => b.stock_kg - a.stock_kg)
                .slice(0, 10);

            const labels = sortedProducts.map(p => p.name);
            const stockData = sortedProducts.map(p => p.stock_kg);
            const minStockData = sortedProducts.map(p => p.min_stock_kg);

            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Actual (kg)',
                        data: stockData,
                        backgroundColor: 'rgba(139, 218, 1, 0.8)',
                        borderColor: '#8bda01',
                        borderWidth: 1
                    }, {
                        label: 'Stock Mínimo (kg)',
                        data: minStockData,
                        backgroundColor: 'rgba(255, 71, 87, 0.8)',
                        borderColor: '#ff4757',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Revenue by Category Chart
        function loadRevenueChart(categories) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) {
                console.warn('Revenue chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (revenueChart) {
                revenueChart.destroy();
            }

            const labels = Object.keys(categories);
            const values = Object.values(categories).map(cat => cat.totalValue);

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor de Inventario (COP)',
                        data: values,
                        backgroundColor: 'rgba(255, 155, 64, 0.8)',
                        borderColor: '#ff9b40',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Valor: ${formatPrice(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Chart refresh functions
        window.refreshCategoriesChart = async function() {
            try {
                const { report } = await productManager.getInventoryReport();
                if (report) {
                    loadCategoriesChart(report.categories);
                }
            } catch (error) {
                console.error('Error refreshing categories chart:', error);
            }
        };

        window.refreshPricesChart = async function() {
            try {
                const { products } = await productManager.getInventoryReport();
                if (products) {
                    loadPricesChart(products);
                }
            } catch (error) {
                console.error('Error refreshing prices chart:', error);
            }
        };

        window.refreshStockChart = async function() {
            try {
                const { products } = await productManager.getInventoryReport();
                if (products) {
                    loadStockChart(products);
                }
            } catch (error) {
                console.error('Error refreshing stock chart:', error);
            }
        };

        window.refreshRevenueChart = async function() {
            try {
                const { report } = await productManager.getInventoryReport();
                if (report) {
                    loadRevenueChart(report.categories);
                }
            } catch (error) {
                console.error('Error refreshing revenue chart:', error);
            }
        };

        // Product Management Functions
        window.showAddProductModal = function() {
            document.getElementById('addProductModal').style.display = 'block';
        };

        window.closeAddProductModal = function() {
            const modal = document.getElementById('addProductModal');
            const form = document.getElementById('addProductForm');
            
            modal.style.display = 'none';
            form.reset();
            
            // Reset modal to add mode
            delete form.dataset.editingId;
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Nuevo Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-plus"></i> Crear Producto';
        };

        // Handle add product form submission
        function setupFormHandlers() {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleAddProduct();
                });
                console.log('✅ Form handlers setup');
            } else {
                console.warn('⚠️ Add product form not found');
            }
        }

        async function handleAddProduct() {
            try {
                const form = document.getElementById('addProductForm');
                const formData = new FormData(form);
                const isEditing = form.dataset.editingId;
                
                const productData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    description: formData.get('description') || '',
                    image_url: formData.get('image') || '/images/products/placeholder.jpg',
                    price: parseFloat(formData.get('price')),
                    price_per_kg: parseFloat(formData.get('price')),
                    cost_per_kg: parseFloat(formData.get('cost')) || 0,
                    stock: parseFloat(formData.get('stock')) || 0,
                    stock_kg: parseFloat(formData.get('stock')) || 0,
                    min_stock: parseFloat(formData.get('minStock')) || 0,
                    min_stock_kg: parseFloat(formData.get('minStock')) || 0,
                    origin: formData.get('origin') || 'Colombia',
                    supplier: formData.get('supplier') || null,
                    rating: parseFloat(formData.get('rating')) || 4.0,
                    organic: formData.get('organic') === 'on',
                    available: formData.get('active') === 'on'
                };

                if (isEditing) {
                    console.log('Updating product:', productData);
                    showLoading('Actualizando producto...');
                    
                    // Usar la función global updateCompleteProduct del storeService
                    const result = await window.updateCompleteProduct(isEditing, {
                        name: productData.name,
                        category: productData.category,
                        description: productData.description,
                        image_url: productData.image_url,
                        price_per_kg: productData.price_per_kg,
                        cost_per_kg: productData.cost_per_kg,
                        stock_kg: productData.stock_kg,
                        min_stock_kg: productData.min_stock_kg,
                        origin: productData.origin,
                        supplier: productData.supplier,
                        rating: productData.rating,
                        is_organic: productData.organic,
                        is_active: productData.available
                    });
                    
                    if (result.success) {
                        showSuccess('✏️ Producto actualizado', `${productData.name} se actualizó correctamente`);
                        closeAddProductModal();
                        await loadInitialData(); // Refresh all data
                    } else {
                        showError('❌ Error al actualizar', result.error || 'No se pudo actualizar el producto');
                    }
                } else {
                    console.log('Creating product:', productData);
                    showLoading('Creando producto...');

                    // Usar la función global createProduct del storeService
                    const result = await window.createProduct({
                        name: productData.name,
                        category: productData.category,
                        description: productData.description,
                        image_url: productData.image_url,
                        price_per_kg: productData.price_per_kg,
                        cost_per_kg: productData.cost_per_kg,
                        stock_kg: productData.stock_kg,
                        min_stock_kg: productData.min_stock_kg,
                        origin: productData.origin,
                        supplier: productData.supplier,
                        rating: productData.rating,
                        is_organic: productData.organic,
                        is_active: productData.available
                    });
                    
                    if (result.success) {
                        showSuccess('🎉 Producto creado', `${productData.name} se agregó al catálogo exitosamente`);
                        closeAddProductModal();
                        await loadInitialData(); // Refresh all data
                    } else {
                        showError('❌ Error al crear producto', result.error || 'No se pudo crear el producto');
                    }
                }
            } catch (error) {
                console.error('Error in handleAddProduct:', error);
                showError('💥 Error del sistema', `Error inesperado: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Las funciones createProduct, updateCompleteProduct y deleteProduct 
        // ahora están disponibles globalmente desde storeService.js

        // Product management functions
        window.editSelectedProduct = function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showAlert('Por favor selecciona un producto para editar', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            // Pre-fill the modal with current product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price_per_kg;
            document.getElementById('productCost').value = product.cost_per_kg || '';
            document.getElementById('productStock').value = product.stock_kg || '';
            document.getElementById('productMinStock').value = product.min_stock_kg || '';
            document.getElementById('productOrigin').value = product.origin || 'Colombia';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productRating').value = product.rating || '4';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImage').value = product.image_url || '';
            document.getElementById('productOrganic').checked = product.organic || false;
            document.getElementById('productActive').checked = product.available;
            
            // Change modal title and button
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            
            // Store the product ID for updating
            document.getElementById('addProductForm').dataset.editingId = productId;
            
            showAddProductModal();
        };

        window.deleteSelectedProduct = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showAlert('Por favor selecciona un producto para eliminar', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            if (!confirm(`¿Estás seguro de que quieres eliminar "${product.name}"? Esta acción no se puede deshacer.`)) {
                return;
            }

            try {
                showLoading('Eliminando producto...');

                // Usar la función global deleteProduct del storeService
                const result = await window.deleteProduct(productId);

                if (result.success) {
                    showAlert('Producto eliminado exitosamente', 'success');
                    await loadInitialData(); // Refresh all data
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Error eliminando producto: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        window.updateProductStatus = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            const newStatus = document.getElementById('productStatus').value;
            
            if (!productId || !newStatus) {
                showAlert('Por favor selecciona un producto y un estado', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            const isActive = newStatus === 'active';
            const statusText = isActive ? 'activar' : 'desactivar';
            
            if (!confirm(`¿Estás seguro de que quieres ${statusText} "${product.name}"?`)) {
                return;
            }

            try {
                showLoading(`${statusText === 'activar' ? 'Activando' : 'Desactivando'} producto...`);

                if (!window.productsClient) {
                    throw new Error('Cliente de productos no inicializado');
                }

                const { error } = await window.productsClient
                    .from('products')
                    .update({ 
                        available: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showAlert(`Producto ${statusText === 'activar' ? 'activado' : 'desactivado'} exitosamente`, 'success');
                
                // Clear selections
                document.getElementById('manageProductSelect').value = '';
                document.getElementById('productStatus').value = '';
                
                await loadInitialData(); // Refresh all data
            } catch (error) {
                console.error('Error updating product status:', error);
                showAlert('Error actualizando estado del producto: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Delete product function (legacy - for compatibility)
        window.deleteProduct = async function(productId, productName) {
            if (!confirm(`🗑️ ¿Estás seguro de que quieres eliminar "${productName}"?\n\nEsta acción desactivará el producto pero mantendrá los datos históricos.`)) {
                return;
            }

            try {
                showLoading('Eliminando producto...');

                if (!window.productsClient) {
                    throw new Error('Cliente de productos no inicializado');
                }

                const { error } = await window.productsClient
                    .from('products')
                    .update({ 
                        available: false,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showSuccess('🗑️ Producto eliminado', `${productName} se desactivó correctamente`);
                await loadInitialData(); // Refresh all data
            } catch (error) {
                console.error('Error deleting product:', error);
                showError('❌ Error al eliminar', `No se pudo eliminar ${productName}: ${error.message}`);
            } finally {
                hideLoading();
            }
        };

        // Export products function
        window.exportProducts = async function() {
            try {
                showLoading('Generando archivo de exportación...');
                
                const products = await productManager.getAllProducts();
                const csvContent = generateProductsCSV(products);
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `productos_fruvi_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('📊 Exportación completada', `Archivo CSV descargado con ${products.length} productos`);
            } catch (error) {
                console.error('Error exporting products:', error);
                showError('❌ Error en exportación', `No se pudo generar el archivo: ${error.message}`);
            } finally {
                hideLoading();
            }
        };

        function generateProductsCSV(products) {
            const headers = [
                'ID', 'Nombre', 'Categoría', 'Precio (COP/kg)', 'Costo (COP/kg)', 
                'Stock (kg)', 'Stock Mínimo (kg)', 'Orgánico', 'Calificación', 
                'Origen', 'Activo'
            ];
            
            const rows = products.map(product => [
                product.id,
                `"${product.name}"`,
                `"${product.category}"`,
                product.price_per_kg,
                product.cost_per_kg || 0,
                product.stock_kg || 0,
                product.min_stock_kg || 0,
                product.organic ? 'Sí' : 'No',
                product.rating || 4.0,
                `"${product.origin || 'Colombia'}"`,
                product.available ? 'Sí' : 'No'
            ]);
            
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }



        // Initialize when page loads
        window.addEventListener('load', function() {
            // Ensure modal is hidden on load
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
            
            const addModal = document.getElementById('addProductModal');
            if (addModal) {
                addModal.style.display = 'none';
            }
            
            console.log('🔄 Página de administración cargada, inicializando...');
            
            // Check Chart.js availability
            if (typeof Chart !== 'undefined') {
                console.log('✅ Chart.js loaded successfully:', Chart.version || 'unknown version');
            } else {
                console.warn('⚠️ Chart.js not loaded');
            }
            
            // Setup form handlers
            setupFormHandlers();
            
            // Check if Supabase library is loaded
            if (!window.supabase) {
                updateConnectionStatus(false, 'Cargando biblioteca de Supabase...');
                // Wait a bit for Supabase to load
                setTimeout(() => {
                    if (window.supabase) {
                        init();
                    } else {
                        updateConnectionStatus(false, 'Error cargando Supabase. Verifica tu conexión a internet.');
                    }
                }, 2000);
            } else {
                // Initialize immediately
                init();
            }
        });
    </script>
</body>
</html>