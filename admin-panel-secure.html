<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Fruvi Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <!-- Production Configuration -->
    <style>
        .btn {
            font-weight: 600;
            font-family: var(--font-menu);
            letter-spacing: 0.04em;
            transition: all 0.3s ease;
            margin: 0.25rem;
            box-shadow: 0 4px 20px rgba(255, 155, 64, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 155, 64, 0.4);
        }

        .btn-secondary {
            background: var(--surface-strong);
            color: var(--txt);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 30px rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #c44569);
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 30px rgba(255, 71, 87, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--brand-2), #20c997);
            box-shadow: 0 4px 20px rgba(139, 218, 1, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 8px 30px rgba(139, 218, 1, 0.4);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--txt);
            font-family: var(--font-body);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--glass-bg);
            color: var(--txt);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(255, 155, 64, 0.2);
            transform: translateY(-1px);
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: var(--muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* Make the subtitle span the full width of the stats grid so it doesn't create an empty grid cell */
        .stat-subtitle {
            grid-column: 1 / -1;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        .admin-section {
            margin-top: 2.5rem;
        }

        .admin-section:first-of-type {
            margin-top: 0;
        }

        .admin-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--txt);
            margin-bottom: 1.5rem;
        }

        .admin-section-title i {
            color: var(--brand);
        }

        .admin-section-title span {
            flex: 1;
        }

        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 3000;
        }

        .admin-toast {
            min-width: 280px;
            max-width: 360px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 1rem 1.25rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            color: var(--txt);
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto auto;
            column-gap: 0.75rem;
            row-gap: 0.35rem;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .admin-toast.is-visible {
            opacity: 1;
            transform: translateX(0);
        }

        .admin-toast i {
            grid-row: 1 / span 2;
            font-size: 1.4rem;
            align-self: center;
        }

        .admin-toast .toast-title {
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .admin-toast .toast-message {
            font-size: 0.9rem;
            color: var(--muted);
            grid-column: 1 / -1;
        }

        .admin-toast button.toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            align-self: start;
            transition: opacity 0.2s ease;
        }

        .admin-toast button.toast-close:hover {
            opacity: 0.7;
        }

        .admin-toast-success {
            border-left: 4px solid #28a745;
        }

        .admin-toast-error {
            border-left: 4px solid #dc3545;
        }

        .admin-toast-warning {
            border-left: 4px solid #ffc107;
        }

        .admin-toast-info {
            border-left: 4px solid #17a2b8;
        }

        @media (max-width: 600px) {
            .toast-container {
                left: 0.75rem;
                right: 0.75rem;
                align-items: stretch;
            }

            .admin-toast {
                max-width: none;
                width: 100%;
            }
        }

        .config-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .config-status-badge.connected {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .supabase-config-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .supabase-config-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(to right, #e0e0e0, #e0e0e0);
            z-index: 1;
        }

        .config-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .config-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-step.is-active .config-badge {
            background: linear-gradient(45deg, #ff9b40, #8bda01);
            color: white;
            transform: scale(1.1);
        }

        .config-step.is-completed .config-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .config-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #666;
        }

        .config-step.is-active .config-label {
            color: #1e3c72;
        }

        .config-section-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .config-section-title h4 {
            color: #1e3c72;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .config-section-title p {
            color: #666;
            font-size: 0.9rem;
        }

        .config-form-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-form-group {
            position: relative;
        }

        .config-form-group label {
            display: block;
            color: #1e3c72;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .config-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .config-form-group input:focus {
            outline: none;
            border-color: #8bda01;
            box-shadow: 0 0 0 3px rgba(139, 218, 1, 0.1);
            transform: translateY(-1px);
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper button {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .password-wrapper button:hover {
            color: #1e3c72;
            background: rgba(139, 218, 1, 0.1);
        }

        .field-hint {
            display: block;
            color: #666;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .field-hint i {
            margin-right: 0.25rem;
            opacity: 0.7;
        }

        .config-form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        }

        .config-info-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .info-panel-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1e3c72;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .info-panel-header i {
            color: #8bda01;
        }

        .info-steps {
            display: grid;
            gap: 1rem;
        }

        .info-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9b40, #8bda01);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content strong {
            color: #1e3c72;
            display: block;
            margin-bottom: 0.25rem;
        }

        .step-content p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .step-content a {
            color: #8bda01;
            text-decoration: none;
            font-weight: 600;
        }

        .step-content a:hover {
            color: #7bc200;
            text-decoration: underline;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            color: var(--txt);
        }

        .alert-success {
            border-left-color: var(--brand-2);
            background: rgba(139, 218, 1, 0.1);
        }

        .alert-warning {
            border-left-color: var(--warn);
            background: rgba(243, 156, 18, 0.1);
        }

        .alert-danger {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .loading i {
            margin-right: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Professional Dashboard Analytics */
        .dashboard-analytics {
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .charts-section {
            margin-bottom: 2rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }

        .chart-card {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .chart-header h3 {
            color: var(--txt);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-header h3 i {
            color: var(--brand);
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--txt);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .btn-chart {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--brand);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-chart:hover {
            background: var(--brand);
            color: #ffffff;
            transform: rotate(180deg);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        /* Responsive Charts */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        /* Product Management Section */
        .product-management {
            margin-bottom: 2rem;
        }

        .management-header {
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .management-header h2 {
            color: var(--txt);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .management-header h2 i {
            color: var(--brand);
        }

        .management-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .management-header {
                flex-direction: column;
                text-align: center;
            }
            
            .management-actions {
                justify-content: center;
            }
        }

        /* Add Product Modal */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: saturate(140%) blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            color: var(--txt);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .modal-header h3 i {
            color: var(--brand);
        }

        .modal-close {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--txt);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--brand);
            color: #ffffff;
        }

        .product-form {
            color: var(--txt);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            color: var(--txt);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--glass-bg);
            border: 2px solid var(--border);
            color: var(--txt);
            padding: 0.875rem 1rem;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(255, 155, 64, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--muted);
        }

        /* 🎨 MEJORAS: Estilos para dropdowns/selects - MEJORADO */
        .form-group select,
        .input-group select,
        select {
            background: #1a1f2e !important;
            border: 2px solid rgba(255,255,255,0.14) !important;
            color: #e9eef5 !important;
            backdrop-filter: blur(10px);
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }

        /* Estilos FORZADOS para las opciones del select */
        .form-group select option,
        .input-group select option,
        select option {
            background-color: #0b0f14 !important;
            background: #0b0f14 !important;
            color: #e9eef5 !important;
            padding: 8px 12px !important;
            border: none !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        }

        /* Estados de las opciones */
        .form-group select option:checked,
        .input-group select option:checked,
        select option:checked {
            background-color: #ff9b40 !important;
            background: #ff9b40 !important;
            color: #000000 !important;
        }

        .form-group select option:hover,
        .input-group select option:hover,
        select option:hover {
            background-color: #333333 !important;
            background: #333333 !important;
            color: #ffffff !important;
        }

        /* Select específicos para productos - FORZADO */
        #priceProductSelect,
        #stockProductSelect,
        #manageProductSelect,
        .chart-select {
            background: #000000 !important;
            border: 2px solid rgba(255,155,64,0.3) !important;
            color: #ffffff !important;
            backdrop-filter: blur(10px);
        }

        #priceProductSelect option,
        #stockProductSelect option,
        #manageProductSelect option,
        .chart-select option {
            background-color: #000000 !important;
            background: #000000 !important;
            color: #ffffff !important;
            padding: 10px 15px !important;
            font-weight: 500 !important;
        }

        /* Webkit específico para dropdowns */
        select::-webkit-scrollbar {
            width: 8px;
        }

        select::-webkit-scrollbar-track {
            background: #000000;
        }

        select::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }

        select::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        #priceProductSelect option,
        #stockProductSelect option,
        #manageProductSelect option {
            background: #000000 !important;
            color: #ffffff !important;
            padding: 0.75rem 1rem !important;
        }

        /* 🔔 SISTEMA DE NOTIFICACIONES PUSH */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .notification {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            cursor: pointer;
            max-width: 380px;
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--brand);
        }

        .notification.success::before {
            background: var(--brand-2);
        }

        .notification.error::before {
            background: var(--danger);
        }

        .notification.warning::before {
            background: var(--warn);
        }

        .notification.info::before {
            background: var(--accent);
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification.success .notification-icon {
            color: var(--brand-2);
        }

        .notification.error .notification-icon {
            color: var(--danger);
        }

        .notification.warning .notification-icon {
            color: var(--warn);
        }

        .notification.info .notification-icon {
            color: var(--accent);
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            color: var(--txt);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .notification-message {
            color: var(--muted);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
            margin-left: 8px;
            transition: color 0.2s ease;
        }

        .notification-close:hover {
            color: var(--txt);
        }

        /* Progreso de auto-cierre */
        .notification::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            width: 100%;
            transform-origin: left;
            transform: scaleX(0);
            transition: transform linear;
        }

        .notification.auto-close::after {
            transform: scaleX(1);
        }

        .checkbox-group {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--txt);
            font-weight: 500;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 95vh;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-actions {
                justify-content: center;
            }
        }

        #modal.hidden {
            display: none !important;
            visibility: hidden;
            opacity: 0;
        }

        .flex {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        /* 🔧 ESTILOS ADICIONALES PARA DROPDOWNS - ULTRA FORZADO */
        * select {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        * select option {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
            padding: 8px !important;
        }

        /* Para navegadores Webkit */
        select option {
            background: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        /* Para Firefox */
        @-moz-document url-prefix() {
            select option {
                background-color: #0b0f14 !important;
                color: #e9eef5 !important;
            }
        }

        /* Para Edge/IE */
        select option {
            background-color: #0b0f14 !important;
            color: #e9eef5 !important;
        }

        /* Estilos globales específicos */
        select[id*="Select"],
        select[id*="product"],
        select[id*="stock"],
        select[id*="price"],
        select[id*="manage"] {
            background: #000000 !important;
            color: #ffffff !important;
        }

        select[id*="Select"] option,
        select[id*="product"] option,
        select[id*="stock"] option,
        select[id*="price"] option,
        select[id*="manage"] option {
            background-color: #000000 !important;
            background: #000000 !important;
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <!-- 🔔 Contenedor de Notificaciones Push -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-store"></i>
                        Panel de Administración - Fruvi Store
                    </h1>
                    <p>Gestión completa de productos, precios e inventario</p>
                </div>
                <div class="header-right">
                    <div class="user-info" id="userInfo">
                        <!-- Se llena dinámicamente con JavaScript -->
                    </div>
                    <button class="logout-btn" onclick="logout()" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Verificando conexión con Supabase...
        </div>



        <!-- Professional Dashboard Analytics -->
        <div class="dashboard-analytics">
            <!-- Main Stats Overview -->
            <div id="statsContainer" class="stats-grid">
                <!-- Stats will be populated here -->
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="charts-grid">
                    <!-- Categories Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Distribución por Categorías</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshCategoriesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoriesChart"></canvas>
                        </div>
                    </div>

                    <!-- Prices Trend Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Tendencia de Precios</h3>
                            <div class="chart-controls">
                                <select id="pricesPeriod" class="chart-select">
                                    <option value="week">Última Semana</option>
                                    <option value="month" selected>Último Mes</option>
                                    <option value="quarter">Último Trimestre</option>
                                </select>
                                <button class="btn-chart" onclick="refreshPricesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="pricesChart"></canvas>
                        </div>
                    </div>

                    <!-- Stock Levels Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Niveles de Stock</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshStockChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-dollar-sign"></i> Valor de Inventario</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshRevenueChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Box Categories Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-box-open"></i> Distribución de Cajas</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshBoxCategoryChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="boxCategoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Box Status Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-toggle-on"></i> Estado de las Cajas</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshBoxStatusChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="boxStatusChart"></canvas>
                        </div>
                    </div>

                    <!-- Box Value Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-cubes"></i> Top Cajas por Valor</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshBoxValueChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="boxValueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Herramientas de la Tienda -->
        <section class="admin-section">
            <div class="admin-section-title">
                <i class="fas fa-store"></i>
                <span>Gestión de Tienda</span>
            </div>
            <div class="admin-grid">
                <!-- Product Price Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>Gestión de Precios</h3>
                    </div>
                    
                    <div class="input-group">
                        <label for="priceProductSelect">Producto:</label>
                        <select id="priceProductSelect">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="newPrice">Nuevo Precio (COP):</label>
                        <input type="number" id="newPrice" step="100" min="0" placeholder="5000">
                    </div>
                    
                    <div class="input-group">
                        <label for="priceReason">Razón del cambio:</label>
                        <input type="text" id="priceReason" placeholder="Actualización de mercado">
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn" onclick="updateSinglePrice()">
                            <i class="fas fa-edit"></i> Actualizar Precio
                        </button>
                        <button class="btn btn-secondary" onclick="viewPriceHistory()">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>

                    <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">
                    
                    <div class="input-group">
                        <label for="categorySelect">Categoría para aumento masivo:</label>
                        <select id="categorySelect">
                            <option value="">Todas las categorías</option>
                            <option value="Bayas">Bayas</option>
                            <option value="Bananos">Bananos</option>
                            <option value="Cítricas">Cítricas</option>
                            <option value="Exóticas">Exóticas</option>
                            <option value="Frutas Dulces">Frutas Dulces</option>
                            <option value="Tropicales">Tropicales</option>
                            <option value="Uvas">Uvas</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="increasePercent">Porcentaje de aumento:</label>
                        <input type="number" id="increasePercent" step="0.1" min="0" max="50" placeholder="5.0">
                    </div>
                    
                    <button class="btn btn-danger" onclick="applyBulkIncrease()">
                        <i class="fas fa-percentage"></i> Aplicar Aumento
                    </button>
                </div>

                <!-- Product Inventory Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-boxes"></i>
                        <h3>Gestión de Inventario</h3>
                    </div>
                    
                    <div class="input-group">
                        <label for="stockProductSelect">Producto:</label>
                        <select id="stockProductSelect">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="stockChange">Cambio en stock (kg):</label>
                        <input type="number" id="stockChange" step="1" placeholder="+50 o -25">
                    </div>
                    
                    <div class="input-group">
                        <label for="stockReason">Razón del cambio:</label>
                        <input type="text" id="stockReason" placeholder="Reposición de inventario">
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn btn-success" onclick="updateStock()">
                            <i class="fas fa-plus"></i> Actualizar Stock
                        </button>
                        <button class="btn btn-secondary" onclick="showLowStock()">
                            <i class="fas fa-exclamation-triangle"></i> Stock Bajo
                        </button>
                        <button class="btn" onclick="showAllProducts()">
                            <i class="fas fa-list"></i> Ver Todos los Productos
                        </button>
                    </div>

                    <div id="currentStock" class="mt-2">
                        <!-- Current stock info will appear here -->
                    </div>
                </div>

                <!-- Product Catalog Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i>
                        <h3>Gestión de Productos</h3>
                    </div>
                    
                    <div class="input-group">
                        <label for="manageProductSelect">Producto:</label>
                        <select id="manageProductSelect">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn btn-success" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                        <button class="btn" onclick="editSelectedProduct()">
                            <i class="fas fa-edit"></i> Editar Producto
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedProduct()">
                            <i class="fas fa-trash"></i> Eliminar Producto
                        </button>
                    </div>

                    <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">
                    
                    <div class="input-group">
                        <label for="productStatus">Cambiar estado:</label>
                        <select id="productStatus">
                            <option value="">Seleccionar estado...</option>
                            <option value="active">Activar Producto</option>
                            <option value="inactive">Desactivar Producto</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="updateProductStatus()">
                        <i class="fas fa-toggle-on"></i> Cambiar Estado
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-lightning-bolt"></i>
                        <h3>Acciones Rápidas</h3>
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn" onclick="loadInventoryReport()">
                            <i class="fas fa-chart-bar"></i> Reporte Inventario
                        </button>
                        <button class="btn btn-secondary" onclick="loadDailyReport()">
                            <i class="fas fa-calendar-day"></i> Reporte Diario
                        </button>
                        <button class="btn btn-success" onclick="exportData()">
                            <i class="fas fa-download"></i> Exportar Datos
                        </button>
                    </div>

                    <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                    <div class="input-group">
                        <label for="csvFile">Importar precios desde CSV:</label>
                        <input type="file" id="csvFile" accept=".csv">
                        <small style="color: #666; font-size: 0.85rem;">
                            Formato: product_id, new_price, reason
                        </small>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="importPricesFromCSV()">
                        <i class="fas fa-upload"></i> Importar CSV
                    </button>
                </div>

                <!-- Reports and Analytics -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>Reportes y Análisis</h3>
                    </div>
                    
                    <div id="reportContainer">
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            <i class="fas fa-info-circle"></i>
                            Selecciona una acción para ver reportes
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Herramientas para Cajas -->
        <section class="admin-section">
            <div class="admin-section-title">
                <i class="fas fa-boxes-stacked"></i>
                <span>Gestión de Cajas</span>
            </div>
            <div class="admin-grid">
                <!-- Box Price Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-boxes-stacked"></i>
                        <h3>Gestión de Precios de Cajas</h3>
                    </div>
                    
                    <div class="input-group">
                        <label for="boxPriceSelect">Caja:</label>
                        <select id="boxPriceSelect">
                            <option value="">Seleccionar caja...</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="boxNewPrice">Nuevo Precio (COP):</label>
                        <input type="number" id="boxNewPrice" step="1000" min="0" placeholder="75000">
                    </div>
                    
                    <div class="input-group">
                        <label for="boxNewPriceUSD">Nuevo Precio (USD) (opcional):</label>
                        <input type="number" id="boxNewPriceUSD" step="0.01" min="0" placeholder="18.50">
                    </div>
                    
                    <div class="input-group">
                        <label for="boxPriceReason">Razón del cambio:</label>
                        <input type="text" id="boxPriceReason" placeholder="Ajuste de temporada">
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn" onclick="updateBoxPriceSingle()">
                            <i class="fas fa-edit"></i> Actualizar Precio
                        </button>
                        <button class="btn btn-secondary" onclick="viewBoxPriceHistory()">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>

                    <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                    <div class="input-group">
                        <label for="boxCategorySelect">Categoría para aumento masivo:</label>
                        <select id="boxCategorySelect">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="boxIncreasePercent">Porcentaje de aumento:</label>
                        <input type="number" id="boxIncreasePercent" step="0.1" placeholder="5.0">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="applyBoxPriceIncrease()">
                        <i class="fas fa-percentage"></i> Aplicar Aumento
                    </button>
                </div>

                <!-- Box Inventory Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-warehouse"></i>
                        <h3>Gestión de Inventario de Cajas</h3>
                    </div>

                    <div class="input-group">
                        <label for="boxStockSelect">Caja:</label>
                        <select id="boxStockSelect">
                            <option value="">Seleccionar caja...</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="boxStockChange">Cambio en stock (unidades):</label>
                        <input type="number" id="boxStockChange" placeholder="+20 o -5">
                    </div>

                    <div class="input-group">
                        <label for="boxStockReason">Razón del cambio:</label>
                        <input type="text" id="boxStockReason" placeholder="Reposición de inventario">
                    </div>

                    <div class="flex flex-wrap">
                        <button class="btn" onclick="updateBoxStock()">
                            <i class="fas fa-box-open"></i> Actualizar Stock
                        </button>
                        <button class="btn btn-secondary" onclick="showAllBoxes()">
                            <i class="fas fa-layer-group"></i> Ver Todas las Cajas
                        </button>
                    </div>
                </div>

                <!-- Box Catalog Management -->
                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-box"></i>
                        <h3>Gestión de Cajas</h3>
                    </div>
                    
                    <div class="input-group">
                        <label for="manageBoxSelect">Caja:</label>
                        <select id="manageBoxSelect">
                            <option value="">Seleccionar caja...</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-wrap">
                        <button class="btn btn-success" onclick="showAddBoxModal()">
                            <i class="fas fa-plus"></i> Agregar Caja
                        </button>
                        <button class="btn" onclick="editSelectedBox()">
                            <i class="fas fa-edit"></i> Editar Caja
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedBox()">
                            <i class="fas fa-trash"></i> Eliminar Caja
                        </button>
                        <button class="btn btn-info" onclick="showAllBoxes()">
                            <i class="fas fa-list"></i> Ver Todas las Cajas
                        </button>
                    </div>

                    <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                    <div class="input-group">
                        <label for="boxStatus">Cambiar estado:</label>
                        <select id="boxStatus">
                            <option value="">Seleccionar estado...</option>
                            <option value="active">Activar Caja</option>
                            <option value="inactive">Desactivar Caja</option>
                            <option value="featured">Marcar como Destacada</option>
                            <option value="unfeatured">Quitar Destacada</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="updateBoxStatus()">
                        <i class="fas fa-toggle-on"></i> Cambiar Estado
                    </button>
                </div>
            </div>
        </section>

        <!-- Modal for detailed views -->
        <div id="modal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        ">
            <div style="
                background: var(--glass-bg);
                backdrop-filter: saturate(140%) blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                padding: 2rem;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
                color: var(--txt);
            ">
                <button onclick="closeModal()" style="
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: var(--surface);
                    border: 1px solid var(--border);
                    font-size: 1.2rem;
                    cursor: pointer;
                    color: var(--txt);
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                ">
                    <i class="fas fa-times"></i>
                </button>
                <div id="modalContent">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="addProductModal" class="product-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeAddProductModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h3>
                    <button onclick="closeAddProductModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addProductForm" class="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productName">Nombre del Producto *</label>
                            <input type="text" id="productName" name="name" required 
                                   placeholder="Ej: Mango Tommy">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Categoría *</label>
                            <select id="productCategory" name="category" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="Cítricas">Cítricas</option>
                                <option value="Tropicales">Tropicales</option>
                                <option value="Bayas">Bayas</option>
                                <option value="Bananos">Bananos</option>
                                <option value="Exóticas">Exóticas</option>
                                <option value="Frutas Dulces">Frutas Dulces</option>
                                <option value="Uvas">Uvas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Precio por Kg (COP) *</label>
                            <input type="number" id="productPrice" name="price" required 
                                   min="100" step="100" placeholder="5000">
                        </div>
                        <div class="form-group">
                            <label for="productCost">Costo por Kg (COP)</label>
                            <input type="number" id="productCost" name="cost" 
                                   min="0" step="100" placeholder="3000">
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Inicial (Kg)</label>
                            <input type="number" id="productStock" name="stock" 
                                   min="0" step="1" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="productMinStock">Stock Mínimo (Kg)</label>
                            <input type="number" id="productMinStock" name="minStock" 
                                   min="0" step="1" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label for="productOrigin">Origen</label>
                            <input type="text" id="productOrigin" name="origin" 
                                   placeholder="Colombia" value="Colombia">
                        </div>
                        <div class="form-group">
                            <label for="productSupplier">Proveedor</label>
                            <input type="text" id="productSupplier" name="supplier" 
                                   placeholder="Nombre del proveedor">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productRating">Calificación</label>
                            <select id="productRating" name="rating">
                                <option value="5">⭐⭐⭐⭐⭐ (5.0)</option>
                                <option value="4.5">⭐⭐⭐⭐⭐ (4.5)</option>
                                <option value="4" selected>⭐⭐⭐⭐ (4.0)</option>
                                <option value="3.5">⭐⭐⭐⭐ (3.5)</option>
                                <option value="3">⭐⭐⭐ (3.0)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" name="description" rows="3" 
                                  placeholder="Descripción del producto..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="productImage">URL de la Imagen</label>
                        <input type="url" id="productImage" name="image" 
                               placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productOrganic" name="organic">
                            <span class="checkmark"></span>
                            Producto Orgánico
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="productActive" name="active" checked>
                            <span class="checkmark"></span>
                            Producto Activo
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddProductModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crear Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="./scripts/services/storeService.js"></script>
    <script src="./scripts/services/productManager.js"></script>
    <script>
        let productManager;
        let boxManager;
        let allProducts = [];
    let cachedBoxes = [];
    let allBoxes = [];

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function slugify(value = '') {
            return value
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)+/g, '')
                .substring(0, 100);
        }

        async function refreshBoxesSelector(selectedId = null, presetBoxes = null) {
            if (!boxManager) {
                return;
            }

            try {
                const boxes = presetBoxes || await boxManager.getAllBoxes();
                cachedBoxes = Array.isArray(boxes) ? boxes : [];
                allBoxes = cachedBoxes.slice();

                const manageBoxSelect = document.getElementById('manageBoxSelect');
                if (manageBoxSelect) {
                    manageBoxSelect.innerHTML = '<option value="">Seleccionar caja...</option>';
                    cachedBoxes.forEach(box => {
                        manageBoxSelect.innerHTML += `<option value="${box.id}">${escapeHtml(box.name)} (${escapeHtml(box.category || 'Caja')})</option>`;
                    });

                    if (selectedId !== null) {
                        manageBoxSelect.value = String(selectedId);
                    }
                }

                populateBoxSelects();
            } catch (error) {
                console.error('Error actualizando selector de cajas:', error);
            }
        }

        function getCachedBox(boxId) {
            return cachedBoxes.find(box => String(box.id) === String(boxId)) || null;
        }

        // Auto-initialize using store service
        async function initializeFromEnv() {
            try {
                console.log('🔧 Inicializando panel de administración con storeService...');
                
                // Wait a bit for services to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check if store service is loaded and initialized
                if (typeof window.checkProductsConfig !== 'function') {
                    console.warn('⚠️ StoreService no está cargado, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                // Check products configuration
                const productsConfig = window.checkProductsConfig();
                console.log('📋 Configuración de productos:', productsConfig);
                
                if (!productsConfig.configured) {
                    console.warn('⚠️ Configuración automática falló, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                if (!productsConfig.initialized) {
                    console.warn('⚠️ Inicialización automática falló, intentando modo manual...');
                    return await initializeManualMode();
                }
                
                // Test products database connection
                const productsConnected = await window.testProductsConnection();
                
                if (productsConnected) {
                    updateConnectionStatus(true, '✅ Conectado a base de datos de productos');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                } else {
                    updateConnectionStatus('warning', '⚠️ Cliente inicializado, verificando tablas...');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-exclamation-triangle"></i> Verificando', '#ffc107');
                }
                
                // Check users database (using original supabase service)
                try {
                    if (window.checkSupabaseConfig && typeof window.checkSupabaseConfig === 'function') {
                        const usersConfig = window.checkSupabaseConfig();
                        if (usersConfig.valid) {
                            updateElementSafely('usersDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                        } else {
                            updateElementSafely('usersDbStatus', '<i class="fas fa-exclamation-triangle"></i> Revisar', '#ffc107');
                        }
                    } else {
                        updateElementSafely('usersDbStatus', '<i class="fas fa-info-circle"></i> No cargado', '#6c757d');
                    }
                } catch (userDbError) {
                    updateElementSafely('usersDbStatus', '<i class="fas fa-exclamation-triangle"></i> Error', '#ffc107');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Error inicializando desde storeService:', error);
                console.log('🔄 Intentando modo manual...');
                return await initializeManualMode();
            }
        }

        // Manual initialization mode with hardcoded values
        async function initializeManualMode() {
            try {
                console.log('🔧 Inicializando en modo manual...');
                
                // Check if Supabase library is available
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Biblioteca Supabase no está cargada');
                }
                
                // Get credentials from config.js (production configuration)
                const productsUrl = window.FRUVI_CONFIG?.PRODUCTS?.URL || 'https://xujenwuefrgxfsiqjqhl.supabase.co';
                const productsKey = window.FRUVI_CONFIG?.PRODUCTS?.ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1amVud3VlZnJneGZzaXFqcWhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTExNTYsImV4cCI6MjA3NjU2NzE1Nn0.89UAEW8CVBkz8lEAdnJzt0XJNo0C4lCrZMBBcRYKmMs';
                
                console.log('🔑 Using config credentials:', { 
                    url: productsUrl, 
                    hasKey: !!productsKey,
                    fromConfig: !!window.FRUVI_CONFIG 
                });
                
                // Create products client manually
                window.productsClient = window.supabase.createClient(productsUrl, productsKey, {
                    auth: {
                        storageKey: 'fruvi-admin-products-auth',
                        autoRefreshToken: false,
                        persistSession: false
                    }
                });
                window.supabaseClient = window.productsClient; // For backward compatibility
                
                console.log('✅ Cliente de productos creado manualmente');
                
                // Test connection
                const { data, error } = await window.productsClient
                    .from('management_products')
                    .select('id')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "management_products" does not exist')) {
                        updateConnectionStatus('warning', '⚠️ Conexión exitosa, pero falta ejecutar los scripts SQL de productos');
                        updateElementSafely('productsDbStatus', '<i class="fas fa-exclamation-triangle"></i> Tablas pendientes', '#ffc107');
                    } else {
                        throw new Error('Error conectando a base de productos: ' + error.message);
                    }
                } else {
                    updateConnectionStatus(true, '✅ Conectado a base de datos de productos (modo manual)');
                    updateElementSafely('productsDbStatus', '<i class="fas fa-check-circle"></i> Conectado', '#28a745');
                }
                
                // Set users status as separate
                updateElementSafely('usersDbStatus', '<i class="fas fa-info-circle"></i> Separado', '#17a2b8');
                
                return true;
                
            } catch (error) {
                console.error('❌ Error en modo manual:', error);
                updateConnectionStatus(false, 'Error en inicialización manual: ' + error.message);
                updateElementSafely('productsDbStatus', '<i class="fas fa-times-circle"></i> Error', '#dc3545');
                return false;
            }
        }

        // Initialize
        async function init() {
            console.log('🚀 Iniciando panel de administración...');
            
            try {
                // Initialize from environment variables
                const envInitialized = await initializeFromEnv();
                
                if (!envInitialized) {
                    throw new Error('No se pudo inicializar desde variables de entorno');
                }
                
                // Wait for storeService to be ready, then initialize product manager
                await waitForStoreService();
                
                if (window.initProductManager && typeof window.initProductManager === 'function') {
                    productManager = window.initProductManager();
                    if (!productManager) {
                        console.warn('⚠️ ProductManager initialization failed, using store service directly');
                    }
                } else {
                    console.warn('⚠️ ProductManager not available, using store service directly');
                }
                
                // Initialize Box Manager
                boxManager = createBoxManager();
                console.log('✅ Box Manager initialized');
                
                await loadInitialData();
                
                console.log('✅ Panel de administración inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando panel:', error);
                updateConnectionStatus(false, error.message);
            }
        }

        // Product manager using store service functions
        // Wait for storeService to be loaded
        async function waitForStoreService() {
            console.log('⏳ Esperando a que storeService esté listo...');
            
            let attempts = 0;
            const maxAttempts = 50; // 5 segundos máximo
            
            while (attempts < maxAttempts) {
                if (window.productsClient && typeof window.getStoreProducts === 'function') {
                    console.log('✅ StoreService está listo');
                    return true;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.warn('⚠️ StoreService no se cargó completamente');
            return false;
        }

        function createStoreProductManager() {
            return {
                getAllProducts: async () => {
                    try {
                        console.log('📦 Consultando productos desde current_products...');
                        const { data: products, error } = await window.productsClient
                            .from('current_products')
                            .select('*')
                            .order('name');
                        
                        if (error) {
                            console.error('❌ Error consultando productos:', error);
                            throw error;
                        }
                        
                        console.log('✅ Productos obtenidos:', products?.length || 0);
                        return products || [];
                    } catch (error) {
                        console.error('❌ Error en getAllProducts:', error);
                        throw new Error('Error cargando productos: ' + error.message);
                    }
                },
                
                updateProductPrice: async (productId, newPrice, reason, updatedBy = 'admin') => {
                    if (typeof window.updateProductPrice === 'function') {
                        return await window.updateProductPrice(productId, newPrice, reason, updatedBy);
                    } else {
                        return { success: false, error: 'Función updateProductPrice no disponible' };
                    }
                },
                
                updateStock: async (productId, quantityChange, reason) => {
                    if (typeof window.updateStock === 'function') {
                        return await window.updateStock(productId, quantityChange, reason);
                    } else {
                        return { success: false, error: 'Función updateStock no disponible' };
                    }
                },
                
                getInventoryReport: async () => {
                    if (typeof window.getInventoryReport === 'function') {
                        return await window.getInventoryReport();
                    } else {
                        return { report: null, products: [] };
                    }
                },
                
                getLowStockProducts: async () => {
                    if (typeof window.getLowStockProducts === 'function') {
                        return await window.getLowStockProducts();
                    } else {
                        return [];
                    }
                },

                applyPriceIncrease: async (category, percent, reason) => {
                    try {
                        const products = await this.getAllProducts();
                        const categoryProducts = category ? 
                            products.filter(p => p.category === category) : 
                            products;

                        let updatedCount = 0;
                        const errors = [];

                        for (const product of categoryProducts) {
                            const newPrice = Math.round(product.price_per_kg * (1 + percent / 100));
                            const result = await this.updateProductPrice(product.id, newPrice, reason);
                            
                            if (result.success) {
                                updatedCount++;
                            } else {
                                errors.push(`${product.name}: ${result.error}`);
                            }
                        }

                        return {
                            success: updatedCount > 0,
                            updatedCount,
                            totalProducts: categoryProducts.length,
                            errors
                        };
                    } catch (error) {
                        return {
                            success: false,
                            error: error.message,
                            updatedCount: 0,
                            totalProducts: 0,
                            errors: []
                        };
                    }
                }
            };
        }

        // Box Manager - Gestión completa de cajas
        function createBoxManager() {
            return {
                getAllBoxes: async () => {
                    try {
                        console.log('📦 Consultando cajas desde current_boxes...');
                        const { data: boxes, error } = await window.productsClient
                            .from('current_boxes')
                            .select('*')
                            .order('featured', { ascending: false })
                            .order('name');
                        
                        if (error) {
                            console.error('❌ Error consultando cajas:', error);
                            throw error;
                        }
                        
                        console.log('✅ Cajas obtenidas:', boxes?.length || 0);
                        return boxes || [];
                    } catch (error) {
                        console.error('❌ Error en getAllBoxes:', error);
                        throw new Error('Error cargando cajas: ' + error.message);
                    }
                },

                getBoxWithContents: async (boxId) => {
                    try {
                        // Obtener información de la caja
                        const { data: box, error: boxError } = await window.productsClient
                            .from('current_boxes')
                            .select('*')
                            .eq('id', boxId)
                            .single();

                        if (boxError) throw boxError;

                        // Obtener contenido de la caja
                        const { data: contents, error: contentsError } = await window.productsClient
                            .from('box_contents')
                            .select('*')
                            .eq('box_id', boxId)
                            .order('display_order');

                        if (contentsError) throw contentsError;

                        return { ...box, contents: contents || [] };
                    } catch (error) {
                        console.error('❌ Error obteniendo caja con contenido:', error);
                        throw error;
                    }
                },

                addBox: async (boxData) => {
                    try {
                        const { data, error } = await window.productsClient
                            .from('current_boxes')
                            .insert([boxData])
                            .select()
                            .single();

                        if (error) throw error;
                        
                        console.log('✅ Caja agregada exitosamente:', data);
                        return data;
                    } catch (error) {
                        console.error('❌ Error agregando caja:', error);
                        throw error;
                    }
                },

                updateBox: async (boxId, updates) => {
                    try {
                        const { data, error } = await window.productsClient
                            .from('current_boxes')
                            .update(updates)
                            .eq('id', boxId)
                            .select()
                            .single();

                        if (error) throw error;
                        
                        console.log('✅ Caja actualizada exitosamente:', data);
                        return data;
                    } catch (error) {
                        console.error('❌ Error actualizando caja:', error);
                        throw error;
                    }
                },

                deleteBox: async (boxId) => {
                    try {
                        const { error } = await window.productsClient
                            .from('current_boxes')
                            .delete()
                            .eq('id', boxId);

                        if (error) throw error;
                        
                        console.log('✅ Caja eliminada exitosamente');
                        return true;
                    } catch (error) {
                        console.error('❌ Error eliminando caja:', error);
                        throw error;
                    }
                },

                updateBoxPrice: async (boxId, newPriceCOP, newPriceUSD, reason) => {
                    try {
                        // Obtener precio actual
                        const { data: currentBox } = await window.productsClient
                            .from('current_boxes')
                            .select('price_cop, price_usd')
                            .eq('id', boxId)
                            .single();

                        // Registrar en historial
                        await window.productsClient
                            .from('box_price_history')
                            .insert([{
                                box_id: boxId,
                                old_price_cop: currentBox.price_cop,
                                new_price_cop: newPriceCOP,
                                old_price_usd: currentBox.price_usd,
                                new_price_usd: newPriceUSD,
                                change_reason: reason,
                                updated_by: 'admin'
                            }]);

                        // Actualizar precio
                        const { data, error } = await window.productsClient
                            .from('current_boxes')
                            .update({ 
                                price_cop: newPriceCOP, 
                                price_usd: newPriceUSD,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', boxId)
                            .select()
                            .single();

                        if (error) throw error;
                        
                        console.log('✅ Precio de caja actualizado exitosamente');
                        return data;
                    } catch (error) {
                        console.error('❌ Error actualizando precio de caja:', error);
                        throw error;
                    }
                },

                getBoxPriceHistory: async (boxId = null, limit = 25) => {
                    try {
                        let query = window.productsClient
                            .from('box_price_history')
                            .select(`
                                *,
                                current_boxes(name, category)
                            `)
                            .order('created_at', { ascending: false });

                        if (boxId) {
                            query = query.eq('box_id', boxId);
                        }

                        if (Number.isFinite(limit) && limit > 0) {
                            query = query.limit(limit);
                        }

                        const { data, error } = await query;

                        if (error) throw error;

                        return data || [];
                    } catch (error) {
                        console.error('❌ Error obteniendo historial de precios de cajas:', error);
                        throw error;
                    }
                },

                adjustBoxStock: async (boxId, change) => {
                    try {
                        const { data: current, error: fetchError } = await window.productsClient
                            .from('current_boxes')
                            .select('stock_quantity, available')
                            .eq('id', boxId)
                            .single();

                        if (fetchError) throw fetchError;

                        const delta = Number(change || 0);
                        const previousStock = Number(current?.stock_quantity || 0);
                        const newStock = Math.max(0, previousStock + delta);

                        const updates = {
                            stock_quantity: newStock,
                            in_stock: newStock > 0,
                            updated_at: new Date().toISOString()
                        };

                        if (newStock <= 0) {
                            updates.available = false;
                        }

                        const { data, error } = await window.productsClient
                            .from('current_boxes')
                            .update(updates)
                            .eq('id', boxId)
                            .select('id, name, category, stock_quantity, available')
                            .single();

                        if (error) throw error;

                        return {
                            box: data,
                            previousStock,
                            newStock,
                            change: delta
                        };
                    } catch (error) {
                        console.error('❌ Error ajustando stock de caja:', error);
                        throw error;
                    }
                },

                updateBoxStatus: async (boxId, status) => {
                    try {
                        let updates = {};
                        
                        switch(status) {
                            case 'active':
                                updates = { available: true, in_stock: true };
                                break;
                            case 'inactive':
                                updates = { available: false };
                                break;
                            case 'featured':
                                updates = { featured: true };
                                break;
                            case 'unfeatured':
                                updates = { featured: false };
                                break;
                        }

                        const { data, error } = await window.productsClient
                            .from('current_boxes')
                            .update(updates)
                            .eq('id', boxId)
                            .select()
                            .single();

                        if (error) throw error;
                        
                        console.log('✅ Estado de caja actualizado exitosamente');
                        return data;
                    } catch (error) {
                        console.error('❌ Error actualizando estado de caja:', error);
                        throw error;
                    }
                },

                updateBoxContents: async (boxId, items) => {
                    try {
                        const entries = Array.isArray(items) ? items : [];
                        const sanitized = entries
                            .map((item, index) => {
                                const name = typeof item === 'string'
                                    ? item.trim()
                                    : (item && item.product_name ? String(item.product_name).trim() : '');
                                if (!name) {
                                    return null;
                                }
                                return {
                                    box_id: boxId,
                                    product_name: name,
                                    display_order: index + 1
                                };
                            })
                            .filter(Boolean);

                        await window.productsClient
                            .from('box_contents')
                            .delete()
                            .eq('box_id', boxId);

                        if (!sanitized.length) {
                            return [];
                        }

                        const { data, error } = await window.productsClient
                            .from('box_contents')
                            .insert(sanitized)
                            .select();

                        if (error) {
                            throw error;
                        }

                        return data || [];
                    } catch (error) {
                        console.error('❌ Error actualizando contenido de la caja:', error);
                        throw error;
                    }
                },

                getBoxAnalytics: async () => {
                    try {
                        const { data, error } = await window.productsClient
                            .from('box_analytics')
                            .select(`
                                *,
                                current_boxes!inner(name, category)
                            `)
                            .order('revenue_cop', { ascending: false });

                        if (error) throw error;
                        
                        return data || [];
                    } catch (error) {
                        console.error('❌ Error obteniendo analytics de cajas:', error);
                        return [];
                    }
                }
            };
        }

        async function waitForSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const check = () => {
                    console.log(`🔄 Checking Supabase... Attempt ${attempts + 1}`);
                    
                    // Check if Supabase library is loaded
                    if (window.supabase) {
                        console.log('✅ Supabase library loaded');
                        
                        // Check if functions are available
                        if (window.setupSupabase && window.initializeSupabase) {
                            console.log('✅ Supabase functions available');
                            
                            // Check if client is initialized
                            if (window.supabaseClient) {
                                console.log('✅ Supabase client initialized');
                                resolve();
                            } else {
                                console.log('⚠️ Supabase client not initialized');
                                if (attempts < maxAttempts) {
                                    attempts++;
                                    setTimeout(check, 300);
                                } else {
                                    reject(new Error('Supabase client not initialized. Please run setupSupabase("URL", "KEY") in console first.'));
                                }
                            }
                        } else {
                            console.log('⚠️ Supabase functions not available yet');
                            if (attempts < maxAttempts) {
                                attempts++;
                                setTimeout(check, 300);
                            } else {
                                reject(new Error('Supabase service functions not loaded.'));
                            }
                        }
                    } else {
                        console.log('⚠️ Supabase library not loaded yet');
                        if (attempts < maxAttempts) {
                            attempts++;
                            setTimeout(check, 200);
                        } else {
                            reject(new Error('Supabase library not loaded. Please check your internet connection.'));
                        }
                    }
                };
                
                check();
            });
        }

        // Safe element update function
        function updateElementSafely(elementId, content, color = null) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = content;
                if (color) {
                    element.style.color = color;
                }
            } else {
                console.log(`ℹ️ Element '${elementId}' not found, skipping update: ${content}`);
            }
        }

        function updateConnectionStatus(connected, message = null) {
            const statusEl = document.getElementById('connectionStatus');
            
            if (connected === true) {
                statusEl.className = 'alert alert-success';
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message || 'Conectado a Supabase correctamente'}`;
                if (!message || !message.includes('Probando')) {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            } else if (connected === false) {
                statusEl.className = 'alert alert-danger';
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message || 'Error de conexión'}`;
                statusEl.style.display = 'block';
            } else {
                // Neutral/warning status
                statusEl.className = 'alert alert-warning';
                statusEl.innerHTML = `<i class="fas fa-info-circle"></i> ${message || 'Verificando conexión...'}`;
                statusEl.style.display = 'block';
            }
        }

        async function loadInitialData() {
            try {
                console.log('🔄 Cargando datos iniciales del admin panel...');
                
                // Load products for dropdowns using storeService directly
                if (typeof window.getAllProducts === 'function') {
                    allProducts = await window.getAllProducts();
                } else if (typeof window.getStoreProducts === 'function') {
                    allProducts = await window.getStoreProducts();
                } else {
                    console.warn('⚠️ Using fallback method to get products');
                    allProducts = [];
                }
                
                populateProductSelects();
                
                // Load boxes for selectors
                try {
                    const boxes = await boxManager.getAllBoxes();
                    console.log(`📦 Loaded ${boxes.length} boxes`);
                    await refreshBoxesSelector(null, boxes);
                } catch (error) {
                    console.warn('⚠️ Error loading boxes:', error);
                }
                
                // Load stats
                await loadStats();
                
                console.log(`📊 Loaded ${allProducts.length} products`);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Error cargando datos iniciales: ' + error.message, 'danger');
            }
        }

        function populateProductSelects() {
            const priceSelect = document.getElementById('priceProductSelect');
            const stockSelect = document.getElementById('stockProductSelect');
            const manageSelect = document.getElementById('manageProductSelect');
            
            // Clear existing options
            priceSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            stockSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            manageSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            allProducts.forEach(product => {
                const option1 = new Option(`${product.name} (${product.category})`, product.id);
                const option2 = new Option(`${product.name} (${product.stock_kg}kg)`, product.id);
                const option3 = new Option(`${product.name} - ${product.available ? 'Activo' : 'Inactivo'}`, product.id);
                
                priceSelect.appendChild(option1);
                stockSelect.appendChild(option2);
                manageSelect.appendChild(option3);
            });
        }

        function populateBoxSelects() {
            const priceSelect = document.getElementById('boxPriceSelect');
            const stockSelect = document.getElementById('boxStockSelect');
            const categorySelect = document.getElementById('boxCategorySelect');

            if (priceSelect) {
                priceSelect.innerHTML = '<option value="">Seleccionar caja...</option>';
                allBoxes.forEach(box => {
                    priceSelect.innerHTML += `<option value="${box.id}">${escapeHtml(box.name)} (${formatPrice(box.price_cop || 0)})</option>`;
                });
            }

            if (stockSelect) {
                stockSelect.innerHTML = '<option value="">Seleccionar caja...</option>';
                allBoxes.forEach(box => {
                    const stockLabel = typeof box.stock_quantity === 'number' ? `${formatNumber(box.stock_quantity)} uds` : 'Sin stock';
                    stockSelect.innerHTML += `<option value="${box.id}">${escapeHtml(box.name)} (${stockLabel})</option>`;
                });
            }

            if (categorySelect) {
                const categories = new Set();
                allBoxes.forEach(box => {
                    if (box?.category) {
                        categories.add(box.category);
                    }
                });

                const currentValue = categorySelect.value;
                categorySelect.innerHTML = '<option value="">Todas las categorías</option>';
                Array.from(categories).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })).forEach(category => {
                    categorySelect.innerHTML += `<option value="${escapeHtml(category)}">${escapeHtml(category)}</option>`;
                });

                if (currentValue) {
                    categorySelect.value = currentValue;
                }
            }
        }

        function buildBoxReport(boxes) {
            const list = Array.isArray(boxes) ? boxes : [];

            if (!list.length) {
                return {
                    totalBoxes: 0,
                    activeBoxes: 0,
                    inactiveBoxes: 0,
                    featuredBoxes: 0,
                    featuredActive: 0,
                    totalStock: 0,
                    totalValue: 0,
                    avgPrice: 0,
                    categories: {},
                    hasData: false
                };
            }

            let totalStock = 0;
            let totalValue = 0;
            let totalPrice = 0;
            const categories = {};

            const totalBoxes = list.length;
            const activeBoxes = list.filter(box => box?.available !== false).length;
            const featuredBoxes = list.filter(box => box?.featured).length;
            const featuredActive = list.filter(box => box?.featured && box?.available !== false).length;

            list.forEach(box => {
                const stock = parseInt(box.stock_quantity ?? box.stock ?? 0, 10) || 0;
                const price = parseFloat(box.price_cop ?? 0) || 0;
                const category = box.category || 'Sin categoría';

                totalStock += stock;
                totalValue += stock * price;
                totalPrice += price;

                if (!categories[category]) {
                    categories[category] = {
                        count: 0,
                        active: 0,
                        featured: 0,
                        totalValue: 0,
                        totalStock: 0
                    };
                }

                categories[category].count += 1;
                categories[category].totalStock += stock;
                categories[category].totalValue += stock * price;

                if (box?.available !== false) {
                    categories[category].active += 1;
                }

                if (box?.featured) {
                    categories[category].featured += 1;
                }
            });

            const inactiveBoxes = totalBoxes - activeBoxes;
            const avgPrice = totalBoxes > 0 ? totalPrice / totalBoxes : 0;

            return {
                totalBoxes,
                activeBoxes,
                inactiveBoxes,
                featuredBoxes,
                featuredActive,
                totalStock,
                totalValue,
                avgPrice,
                categories,
                hasData: true
            };
        }

        async function loadStats() {
            try {
                let report = null;
                let products = Array.isArray(allProducts) ? allProducts : [];

                if (typeof window.getInventoryReport === 'function') {
                    try {
                        const result = await window.getInventoryReport();
                        report = result?.report || result || null;
                        if (Array.isArray(result?.products)) {
                            products = result.products;
                        }
                    } catch (inventoryError) {
                        console.warn('⚠️ Error obteniendo inventario, usando datos en memoria:', inventoryError);
                    }
                }

                if (!report) {
                    const lowStockProducts = products.filter(product => {
                        const stock = parseFloat(product.stock ?? product.stock_kg ?? 0);
                        const minStock = parseFloat(product.min_stock ?? product.min_stock_kg ?? 0);
                        return stock <= minStock;
                    });

                    const categories = {};
                    products.forEach(product => {
                        const category = product.category || 'Sin categoría';
                        if (!categories[category]) {
                            categories[category] = {
                                count: 0,
                                totalValue: 0,
                                totalStock: 0,
                                lowStock: 0
                            };
                        }

                        const stock = parseFloat(product.stock ?? product.stock_kg ?? 0) || 0;
                        const price = parseFloat(product.price_per_kg ?? product.priceKg ?? 0) || 0;
                        const minStock = parseFloat(product.min_stock ?? product.min_stock_kg ?? 0) || 0;
                        categories[category].count += 1;
                        categories[category].totalValue += stock * price;
                        categories[category].totalStock += stock;
                        if (stock <= minStock) {
                            categories[category].lowStock += 1;
                        }
                    });

                    report = {
                        totalProducts: products.length,
                        totalStock: products.reduce((sum, product) => {
                            const stock = parseFloat(product.stock ?? product.stock_kg ?? 0) || 0;
                            return sum + stock;
                        }, 0),
                        lowStockProducts,
                        lowStockCount: lowStockProducts.length,
                        outOfStockProducts: products.filter(product => {
                            const stock = parseFloat(product.stock ?? product.stock_kg ?? 0) || 0;
                            return stock === 0;
                        }),
                        totalValue: products.reduce((sum, product) => {
                            const stock = parseFloat(product.stock ?? product.stock_kg ?? 0) || 0;
                            const price = parseFloat(product.price_per_kg ?? product.priceKg ?? 0) || 0;
                            return sum + stock * price;
                        }, 0),
                        categories
                    };
                }

                const statsContainer = document.getElementById('statsContainer');
                if (!statsContainer) {
                    console.warn('Stats container not found');
                    return;
                }

                const boxes = Array.isArray(allBoxes) ? allBoxes : [];
                const boxReport = buildBoxReport(boxes);

                const activeProducts = products.filter(product => product?.available !== false);
                const avgPrice = products.length > 0
                    ? products.reduce((sum, product) => {
                        const price = parseFloat(product.price_per_kg ?? product.priceKg ?? 0) || 0;
                        return sum + price;
                    }, 0) / products.length
                    : 0;

                const productCards = `
                    <div class="stat-subtitle">Productos</div>
                    <div class="stat-card">
                        <i class="fas fa-boxes"></i>
                        <div class="value">${formatNumber(report?.totalProducts ?? products.length ?? 0)}</div>
                        <div class="label">Total Productos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <div class="value">${formatNumber(activeProducts.length)}</div>
                        <div class="label">Productos Activos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="value">${formatNumber(report?.lowStockCount || 0)}</div>
                        <div class="label">Stock Bajo</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <div class="value">${formatPrice(report?.totalValue || 0)}</div>
                        <div class="label">Valor Total</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tag"></i>
                        <div class="value">${formatPrice(avgPrice)}</div>
                        <div class="label">Precio Promedio</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group"></i>
                        <div class="value">${formatNumber(report?.categories ? Object.keys(report.categories).length : 0)}</div>
                        <div class="label">Categorías</div>
                    </div>
                `;

                const boxCategoryCount = boxReport?.categories ? Object.keys(boxReport.categories).length : 0;
                const boxCards = `
                    <div class="stat-subtitle">Cajas</div>
                    <div class="stat-card">
                        <i class="fas fa-box-open"></i>
                        <div class="value">${formatNumber(boxReport.totalBoxes)}</div>
                        <div class="label">Total Cajas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check"></i>
                        <div class="value">${formatNumber(boxReport.activeBoxes)}</div>
                        <div class="label">Cajas Activas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-star"></i>
                        <div class="value">${formatNumber(boxReport.featuredBoxes)}</div>
                        <div class="label">Cajas Destacadas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <div class="value">${formatPrice(boxReport.totalValue)}</div>
                        <div class="label">Valor Inventario Cajas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-balance-scale"></i>
                        <div class="value">${formatPrice(boxReport.avgPrice)}</div>
                        <div class="label">Precio Promedio Caja</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-th-large"></i>
                        <div class="value">${formatNumber(boxCategoryCount)}</div>
                        <div class="label">Categorías de Cajas</div>
                    </div>
                `;

                statsContainer.innerHTML = productCards + boxCards;
                statsContainer.classList.remove('hidden');

                await loadCharts(report, products, boxReport);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load all charts
        async function loadCharts(report, products, boxReport) {
            try {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded yet, retrying in 1 second...');
                    setTimeout(() => loadCharts(report, products, boxReport), 1000);
                    return;
                }
                
                loadCategoriesChart(report?.categories || {});
                loadPricesChart(Array.isArray(products) ? products : []);
                loadStockChart(Array.isArray(products) ? products : []);
                loadRevenueChart(report?.categories || {});

                if (boxReport) {
                    loadBoxCategoryChart(boxReport.categories || {});
                    loadBoxStatusChart(boxReport);
                    loadBoxValueChart(Array.isArray(allBoxes) ? allBoxes : []);
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

    // ===== FUNCIONES DE GESTIÓN DE LA TIENDA =====

    // --- Precios de productos ---
        window.updateSinglePrice = async function() {
            const productId = document.getElementById('priceProductSelect').value;
            const newPrice = parseFloat(document.getElementById('newPrice').value);
            const reason = document.getElementById('priceReason').value || 'Manual update';
            
            if (!productId || !newPrice || newPrice <= 0) {
                showWarning('Campos incompletos', 'Por favor completa todos los campos con valores válidos');
                return;
            }
            
            try {
                showLoading('Actualizando precio...');
                
                // Obtener nombre del producto para el mensaje
                const productSelect = document.getElementById('priceProductSelect');
                const productName = productSelect.options[productSelect.selectedIndex].text;
                
                const result = await productManager.updateProductPrice(productId, newPrice, reason, 'admin');
                
                if (result.success) {
                    showSuccess(
                        '💰 Precio actualizado',
                        `${productName} ahora cuesta $${newPrice.toLocaleString('es-CO')}`
                    );
                    await loadInitialData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('newPrice').value = '';
                    document.getElementById('priceReason').value = '';
                } else {
                    showError(
                        '❌ Error al cambiar precio',
                        result.error || 'No se pudo actualizar el precio del producto'
                    );
                }
            } catch (error) {
                showError(
                    '💥 Error del sistema',
                    `Error inesperado: ${error.message}`
                );
            } finally {
                hideLoading();
            }
        };

        window.applyBulkIncrease = async function() {
            const category = document.getElementById('categorySelect').value;
            const percent = parseFloat(document.getElementById('increasePercent').value);
            
            if (!percent) {
                showAlert('Por favor ingresa el porcentaje de aumento', 'warning');
                return;
            }
            
            const confirmMsg = category 
                ? `¿Aplicar ${percent}% de aumento a la categoría "${category}"?`
                : `¿Aplicar ${percent}% de aumento a TODOS los productos?`;
                
            if (!confirm(confirmMsg)) return;
            
            try {
                showLoading('Aplicando aumento masivo...');
                
                let result;
                if (category) {
                    result = await productManager.applyPriceIncrease(
                        category, 
                        percent, 
                        `Bulk increase ${percent}% - ${category}`
                    );
                } else {
                    result = await window.applyInflationIncrease(percent);
                }
                
                showAlert(`Aumento aplicado correctamente`, 'success');
                await loadInitialData(); // Refresh data
                
                // Clear form
                document.getElementById('increasePercent').value = '';
            } catch (error) {
                showAlert('Error aplicando aumento: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

    // --- Inventario de productos ---
    window.updateStock = async function() {
            const productId = document.getElementById('stockProductSelect').value;
            const stockChange = parseInt(document.getElementById('stockChange').value);
            const reason = document.getElementById('stockReason').value || 'Manual adjustment';
            
            // Validaciones mejoradas
            if (!productId || productId === '' || productId === 'undefined') {
                showWarning('Producto no seleccionado', 'Por favor selecciona un producto válido');
                return;
            }
            
            if (isNaN(stockChange) || stockChange === 0) {
                showWarning('Cantidad inválida', 'Por favor ingresa una cantidad válida diferente de cero');
                return;
            }
            
            try {
                showLoading('Actualizando inventario...');
                
                // Obtener nombre del producto para el mensaje
                const productSelect = document.getElementById('stockProductSelect');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const productName = selectedOption ? selectedOption.text : 'Producto desconocido';
                
                const result = await productManager.updateStock(productId, stockChange, reason);
                
                if (result.success) {
                    const actionText = stockChange > 0 ? 'agregado' : 'reducido';
                    showSuccess(
                        '✅ Inventario actualizado', 
                        `Se ha ${actionText} ${Math.abs(stockChange)} unidades de ${productName}`
                    );
                    await loadInitialData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('stockChange').value = '';
                    document.getElementById('stockReason').value = '';
                } else {
                    showError(
                        '❌ Error en inventario', 
                        result.error || 'No se pudo actualizar el inventario'
                    );
                }
            } catch (error) {
                showError(
                    '💥 Error del sistema', 
                    `Error inesperado: ${error.message}`
                );
            } finally {
                hideLoading();
            }
        };

        // Función para abrir el modal de stock con un producto preseleccionado
        window.openStockModal = function(productId) {
            if (!productId) {
                showWarning('Error', 'ID de producto no válido');
                return;
            }
            
            // Pre-seleccionar el producto en el dropdown
            const stockSelect = document.getElementById('stockProductSelect');
            if (stockSelect) {
                stockSelect.value = productId;
                
                // Scroll a la sección de stock
                const stockSection = document.querySelector('[id*="stock"]').closest('.admin-card');
                if (stockSection) {
                    stockSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Focus en el campo de cantidad
                const stockChangeInput = document.getElementById('stockChange');
                if (stockChangeInput) {
                    setTimeout(() => {
                        stockChangeInput.focus();
                    }, 500);
                }
            }
        };

    // --- Reportes e inventario general ---
    window.showLowStock = async function() {
            try {
                showLoading('Cargando productos con stock bajo...');
                const lowStockProducts = await productManager.getLowStockProducts();
                
                if (lowStockProducts.length === 0) {
                    showAlert('¡Excelente! No hay productos con stock bajo', 'success');
                    return;
                }
                
                let html = `
                    <h3>Productos con Stock Bajo (${lowStockProducts.length})</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Stock Actual</th>
                                    <th>Stock Mínimo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lowStockProducts.forEach(product => {
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-apple-alt" style="color: #8bda01;"></i>
                                    ${product.name}
                                </div>
                            </td>
                            <td>
                                <span class="product-category">${product.category}</span>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-low">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${product.stock_kg}kg
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span style="color: #666; font-weight: 500;">${product.min_stock_kg}kg</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-success" onclick="restockProduct(${product.id}, ${product.min_stock_kg * 2})">
                                        <i class="fas fa-plus"></i> Reabastecer
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                showModal(html);
            } catch (error) {
                showAlert('Error cargando productos con stock bajo: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        window.loadInventoryReport = async function() {
            try {
                showLoading('Generando reporte de inventario...');
                const { report, products } = await productManager.getInventoryReport();
                
                let html = `
                    <h3>Reporte Completo de Inventario</h3>
                    <div class="stats-grid mb-2">
                        <div class="stat-card">
                            <div class="value">${report.totalProducts}</div>
                            <div class="label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${formatPrice(report.totalValue)}</div>
                            <div class="label">Valor Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${report.lowStockCount}</div>
                            <div class="label">Stock Bajo</div>
                        </div>
                    </div>
                    
                    <h4>Por Categoría</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th>Productos</th>
                                    <th>Stock Total</th>
                                    <th>Valor</th>
                                    <th>Stock Bajo</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(report.categories).forEach(([category, data]) => {
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-tags" style="color: #2a5298;"></i>
                                    <strong>${category}</strong>
                                </div>
                            </td>
                            <td>
                                <span style="background: rgba(42, 82, 152, 0.1); color: #2a5298; padding: 0.25rem 0.5rem; border-radius: 8px; font-weight: 600;">
                                    ${data.count} productos
                                </span>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-good">
                                        <i class="fas fa-weight"></i>
                                        ${data.totalStock}kg
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="price-display">
                                    <i class="fas fa-dollar-sign"></i>
                                    ${formatPrice(data.totalValue)}
                                </span>
                            </td>
                            <td>
                                ${data.lowStock > 0 ? 
                                    `<span class="stock-low">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${data.lowStock}
                                    </span>` : 
                                    `<span class="stock-good">
                                        <i class="fas fa-check-circle"></i>
                                        0
                                    </span>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                showModal(html);
            } catch (error) {
                showAlert('Error generando reporte: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Show All Products in Elegant Table
    // --- Catálogo de productos ---
    window.showAllProducts = async function() {
            try {
                showLoading('Cargando todos los productos...');
                const products = await productManager.getAllProducts();
                
                if (products.length === 0) {
                    showAlert('No hay productos en la base de datos', 'warning');
                    return;
                }
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Catálogo Completo de Productos (${products.length})</h3>
                        <div class="action-buttons">
                            <button class="btn-sm btn-success" onclick="addNewProduct()">
                                <i class="fas fa-plus"></i> Nuevo Producto
                            </button>
                            <button class="btn-sm btn-info" onclick="exportProducts()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="table-container" style="max-height: 600px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Precio Actual</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                products.forEach(product => {
                    const stockStatus = product.stock_kg <= product.min_stock_kg ? 'low' : 'good';
                    const isOrganic = product.organic ? '<i class="fas fa-leaf" style="color: #28a745; margin-left: 0.5rem;" title="Orgánico"></i>' : '';
                    
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-apple-alt" style="color: #8bda01;"></i>
                                    ${product.name}
                                    ${isOrganic}
                                </div>
                                <small style="color: #666; margin-left: 1.5rem;">
                                    ${product.origin || 'Colombia'}
                                </small>
                            </td>
                            <td>
                                <span class="product-category">${product.category}</span>
                            </td>
                            <td>
                                <span class="price-display">
                                    <i class="fas fa-dollar-sign"></i>
                                    ${formatPrice(product.price_per_kg)}/kg
                                </span>
                                <br>
                                <small style="color: #666;">
                                    Costo: ${formatPrice(product.cost_per_kg)}/kg
                                </small>
                            </td>
                            <td>
                                <div class="stock-status">
                                    <span class="stock-${stockStatus}">
                                        <i class="fas fa-${stockStatus === 'low' ? 'exclamation-triangle' : 'check-circle'}"></i>
                                        ${product.stock_kg}kg
                                    </span>
                                </div>
                                <small style="color: #666;">
                                    Mín: ${product.min_stock_kg}kg
                                </small>
                            </td>
                            <td>
                                <span style="
                                    background: ${product.available ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'};
                                    color: ${product.available ? '#28a745' : '#dc3545'};
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 8px;
                                    font-size: 0.8rem;
                                    font-weight: 600;
                                ">
                                    <i class="fas fa-${product.available ? 'check' : 'times'}"></i>
                                    ${product.available ? 'Disponible' : 'No disponible'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-info" onclick="editProduct(${product.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-sm btn-warning" onclick="updatePrice(${product.id})" title="Cambiar precio">
                                        <i class="fas fa-tag"></i>
                                    </button>
                                    <button class="btn-sm btn-success" onclick="openStockModal(${product.id})" title="Actualizar stock">
                                        <i class="fas fa-boxes"></i>
                                    </button>
                                    <button class="btn-sm btn-danger" onclick="deleteProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')" title="Eliminar producto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                // Add summary stats at the bottom
                const totalValue = products.reduce((sum, p) => sum + (p.stock_kg * p.price_per_kg), 0);
                const lowStockCount = products.filter(p => p.stock_kg <= p.min_stock_kg).length;
                const availableCount = products.filter(p => p.available).length;
                
                html += `
                    <div class="stats-grid" style="margin-top: 1.5rem;">
                        <div class="stat-card">
                            <i class="fas fa-box"></i>
                            <div class="value">${products.length}</div>
                            <div class="label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle"></i>
                            <div class="value">${availableCount}</div>
                            <div class="label">Disponibles</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="value">${lowStockCount}</div>
                            <div class="label">Stock Bajo</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-dollar-sign"></i>
                            <div class="value">${formatPrice(totalValue)}</div>
                            <div class="label">Valor Total</div>
                        </div>
                    </div>
                `;
                
                showModal(html);
            } catch (error) {
                showAlert('Error cargando productos: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

    // ===== FUNCIONES DE GESTIÓN DE CAJAS =====

    // --- Precios de cajas ---
        window.updateBoxPriceSingle = async function() {
            const select = document.getElementById('boxPriceSelect');
            const priceInput = document.getElementById('boxNewPrice');
            const usdInput = document.getElementById('boxNewPriceUSD');
            const reasonInput = document.getElementById('boxPriceReason');

            if (!select || !select.value) {
                showWarning('Caja no seleccionada', 'Elige una caja para actualizar su precio');
                return;
            }

            const boxId = Number(select.value);
            const box = getCachedBox(boxId);
            if (!box) {
                showAlert('No se encontró la caja seleccionada. Refresca la lista e inténtalo nuevamente.', 'danger');
                return;
            }

            const rawPrice = parseFloat(priceInput?.value);
            if (!Number.isFinite(rawPrice) || rawPrice <= 0) {
                showWarning('Precio inválido', 'Ingresa un precio COP mayor a 0');
                return;
            }

            const normalizedPrice = Math.round(rawPrice * 100) / 100;
            const rawUsd = parseFloat(usdInput?.value);
            const normalizedUsd = Number.isFinite(rawUsd) && rawUsd > 0
                ? Math.round(rawUsd * 100) / 100
                : Math.round(Number(box.price_usd || 0) * 100) / 100;
            const reason = reasonInput?.value?.trim() || 'Actualización manual de precio';

            const previousPrice = Number(box.price_cop || 0);
            const percentChange = previousPrice > 0
                ? ((normalizedPrice - previousPrice) / previousPrice) * 100
                : 0;

            let confirmMessage = `¿Actualizar el precio de "${box.name}" a ${formatPrice(normalizedPrice)}?`;
            if (previousPrice > 0 && Math.abs(percentChange) >= 15) {
                confirmMessage += `\n\nEl cambio equivale a ${percentChange.toFixed(1)}% respecto al precio actual (${formatPrice(previousPrice)}).`;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoading('Actualizando precio de la caja...');
                await boxManager.updateBoxPrice(boxId, normalizedPrice, normalizedUsd, reason);
                showSuccess('Precio actualizado', `${escapeHtml(box.name)} ahora cuesta ${formatPrice(normalizedPrice)}`);

                if (priceInput) priceInput.value = '';
                if (usdInput) usdInput.value = '';
                if (reasonInput) reasonInput.value = '';

                await refreshBoxesSelector(boxId);
                await loadStats();
            } catch (error) {
                console.error('Error actualizando precio de caja:', error);
                showError('No se pudo actualizar el precio', error.message || String(error));
            } finally {
                hideLoading();
            }
        };

        window.applyBoxPriceIncrease = async function() {
            const percentInput = document.getElementById('boxIncreasePercent');
            const categorySelect = document.getElementById('boxCategorySelect');

            const percent = parseFloat(percentInput?.value);
            if (!Number.isFinite(percent) || percent === 0) {
                showWarning('Porcentaje inválido', 'Ingresa un porcentaje mayor a 0');
                return;
            }

            if (percent > 50 || percent < -50) {
                showWarning('Porcentaje fuera de rango', 'Limita los ajustes masivos a ±50%');
                return;
            }

            const category = categorySelect?.value || '';
            const confirmLabel = category
                ? `las cajas de la categoría "${category}"`
                : 'todas las cajas';

            if (!confirm(`¿Aplicar un ajuste del ${percent}% a ${confirmLabel}?`)) {
                return;
            }

            try {
                showLoading('Aplicando aumento de precios en cajas...');

                const allAvailableBoxes = await boxManager.getAllBoxes();
                const normalizedCategory = category.trim().toLowerCase();
                const targetBoxes = normalizedCategory
                    ? allAvailableBoxes.filter(box => (box.category || '').toLowerCase() === normalizedCategory)
                    : allAvailableBoxes;

                if (!targetBoxes.length) {
                    showWarning('Sin cajas objetivo', 'No se encontraron cajas para actualizar con ese criterio');
                    return;
                }

                let updatedCount = 0;
                const errors = [];

                for (const box of targetBoxes) {
                    const basePrice = Number(box.price_cop || 0);
                    const baseUsd = Number(box.price_usd || 0);
                    const multiplier = 1 + percent / 100;
                    const newPrice = Math.round(basePrice * multiplier * 100) / 100;
                    const newUsd = baseUsd > 0 ? Math.round(baseUsd * multiplier * 100) / 100 : baseUsd;

                    try {
                        await boxManager.updateBoxPrice(
                            box.id,
                            newPrice,
                            newUsd,
                            `Ajuste masivo ${percent}%${category ? ` (${category})` : ''}`.trim()
                        );
                        updatedCount++;
                    } catch (error) {
                        console.error(`Error actualizando ${box.name}:`, error);
                        errors.push(`${box.name}: ${error.message || String(error)}`);
                    }
                }

                if (updatedCount === 0 && errors.length) {
                    const list = `<ul>${errors.map(msg => `<li>${escapeHtml(msg)}</li>`).join('')}</ul>`;
                    showError('No se aplicaron cambios', list);
                } else {
                    const detail = `${updatedCount} de ${targetBoxes.length} cajas actualizadas${errors.length ? ` (errores: ${errors.length})` : ''}.`;
                    if (errors.length) {
                        showWarning('Ajuste parcial aplicado', detail);
                    } else {
                        showSuccess('Ajuste aplicado', detail);
                    }
                }

                await refreshBoxesSelector();
                await loadStats();

                if (percentInput) percentInput.value = '';
            } catch (error) {
                console.error('Error aplicando aumento de cajas:', error);
                showAlert('Error aplicando aumento: ' + (error.message || String(error)), 'danger');
            } finally {
                hideLoading();
            }
        };

        window.viewBoxPriceHistory = async function() {
            const select = document.getElementById('boxPriceSelect');
            const boxId = select && select.value ? Number(select.value) : null;
            const selectedBox = boxId ? getCachedBox(boxId) : null;

            try {
                showLoading('Cargando historial de precios de cajas...');
                const history = await boxManager.getBoxPriceHistory(boxId || undefined, boxId ? 40 : 60);

                if (!history.length) {
                    showAlert('No hay historial de precios registrado para esta selección.', 'info');
                    return;
                }

                let html = `
                    <h3>${selectedBox ? `Historial de precio - ${escapeHtml(selectedBox.name)}` : 'Historial reciente de precios de cajas'}</h3>
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    ${selectedBox ? '' : '<th>Caja</th>'}
                                    <th>Precio anterior</th>
                                    <th>Precio nuevo</th>
                                    <th>Variación</th>
                                    <th>Motivo</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                history.forEach(entry => {
                    const boxInfo = entry.current_boxes || {};
                    const name = selectedBox?.name || boxInfo.name || `Caja #${entry.box_id}`;
                    const oldPrice = Number(entry.old_price_cop || 0);
                    const newPrice = Number(entry.new_price_cop || 0);
                    const diff = newPrice - oldPrice;
                    const percent = oldPrice > 0 ? (diff / oldPrice) * 100 : 0;
                    const sign = diff > 0 ? '+' : diff < 0 ? '-' : '';
                    const changeColor = diff > 0 ? '#28a745' : diff < 0 ? '#dc3545' : '#6c757d';
                    const changeText = diff === 0
                        ? 'Sin cambios'
                        : `${sign}${formatPrice(Math.abs(diff))} (${sign}${Math.abs(percent).toFixed(1)}%)`;
                    const reason = entry.change_reason ? escapeHtml(entry.change_reason) : 'Sin motivo';
                    const timestamp = entry.created_at
                        ? new Date(entry.created_at).toLocaleString('es-CO')
                        : 'Sin fecha';

                    html += `
                        <tr>
                            ${selectedBox ? '' : `<td>${escapeHtml(name)}</td>`}
                            <td>${formatPrice(oldPrice)}</td>
                            <td>${formatPrice(newPrice)}</td>
                            <td><span style="color:${changeColor}; font-weight:600;">${changeText}</span></td>
                            <td>${reason}</td>
                            <td>${escapeHtml(timestamp)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                showModal(html);
            } catch (error) {
                console.error('Error obteniendo historial de precios de cajas:', error);
                showAlert('Error cargando historial: ' + (error.message || String(error)), 'danger');
            } finally {
                hideLoading();
            }
        };

    // --- Inventario de cajas ---
    window.updateBoxStock = async function() {
            const select = document.getElementById('boxStockSelect');
            const changeInput = document.getElementById('boxStockChange');
            const reasonInput = document.getElementById('boxStockReason');

            if (!select || !select.value) {
                showWarning('Caja no seleccionada', 'Elige una caja para ajustar su inventario');
                return;
            }

            const boxId = Number(select.value);
            const box = getCachedBox(boxId);
            if (!box) {
                showAlert('No se encontró la caja seleccionada. Refresca la lista e inténtalo nuevamente.', 'danger');
                return;
            }

            const delta = parseInt(changeInput?.value, 10);
            if (!Number.isFinite(delta) || delta === 0) {
                showWarning('Cantidad inválida', 'Ingresa un valor diferente de cero para ajustar el stock');
                return;
            }

            const currentStock = Number(box.stock_quantity || 0);
            const projectedStock = currentStock + delta;
            if (projectedStock < 0) {
                if (!confirm('El ajuste dejará el stock en 0. ¿Deseas continuar?')) {
                    return;
                }
            }

            const targetStock = Math.max(0, projectedStock);
            const summary = `Stock actual: ${currentStock} → Stock resultante: ${targetStock}`;
            const confirmText = `¿Aplicar un cambio de ${delta > 0 ? '+' : ''}${delta} unidades a "${box.name}"?\n${summary}`;

            if (!confirm(confirmText)) {
                return;
            }

            const reason = reasonInput?.value?.trim() || 'Ajuste manual de inventario';

            try {
                showLoading('Actualizando inventario de la caja...');
                const result = await boxManager.adjustBoxStock(boxId, delta);
                const newStock = Number(result?.newStock ?? targetStock);

                const reasonSuffix = reason
                    ? `<br><small style="color:#9aa6b2;">Motivo: ${escapeHtml(reason)}</small>`
                    : '';
                showSuccess('Inventario actualizado', `${escapeHtml(box.name)} ahora tiene ${newStock} unidades disponibles${reasonSuffix}`);

                if (changeInput) changeInput.value = '';
                if (reasonInput) reasonInput.value = '';

                await refreshBoxesSelector(boxId);
                await loadStats();
            } catch (error) {
                console.error('Error ajustando stock de caja:', error);
                showError('No se pudo actualizar el inventario', error.message || String(error));
            } finally {
                hideLoading();
            }
        };

    // --- Catálogo de cajas ---
    window.showAllBoxes = async function() {
            showLoading('Cargando todas las cajas...');
            try {
                const boxes = await boxManager.getAllBoxes();
                
                if (boxes.length === 0) {
                    showAlert('No hay cajas registradas en el sistema', 'warning');
                    return;
                }
                
                let html = `
                    <h3>Lista Completa de Cajas (${boxes.length})</h3>
                    <div class="table-responsive">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Caja</th>
                                    <th>Categoría</th>
                                    <th>Precio COP</th>
                                    <th>Precio USD</th>
                                    <th>Items</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                boxes.forEach(box => {
                    const isFeatured = box.featured ? '<i class="fas fa-star" style="color: #ffc107; margin-left: 0.5rem;" title="Destacada"></i>' : '';
                    const itemsLabel = Number.isFinite(box.total_items) ? `${box.total_items} items` : `${(box.contents?.length || 0)} items`;
                    
                    html += `
                        <tr>
                            <td>
                                <div class="product-name">
                                    <i class="fas fa-box" style="color: #8bda01;"></i>
                                    ${escapeHtml(box.name)}${isFeatured}
                                </div>
                            </td>
                            <td><span class="category-badge">${escapeHtml(box.category || 'Caja')}</span></td>
                            <td class="price">${formatPrice(box.price_cop)}</td>
                            <td class="price">$${Number(box.price_usd || 0).toFixed(2)}</td>
                            <td>${itemsLabel}</td>
                            <td>
                                <span class="status-badge status-${box.available ? 'active' : 'inactive'}">
                                    ${box.available ? 'Activa' : 'Inactiva'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-info" onclick="viewBoxDetails(${box.id})" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-sm btn-warning" onclick="editBox(${box.id})" title="Editar caja">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-sm btn-success" onclick="toggleBoxAvailability(${box.id}, ${box.available ? 'true' : 'false'})" title="${box.available ? 'Desactivar caja' : 'Activar caja'}">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <button class="btn-sm btn-secondary" onclick="toggleBoxFeatured(${box.id}, ${box.featured ? 'true' : 'false'})" title="${box.featured ? 'Quitar destacada' : 'Marcar como destacada'}">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button class="btn-sm btn-danger" onclick="deleteBoxById(${box.id}, ${JSON.stringify(box.name || '')})" title="Eliminar caja">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                showModal(html);
                
            } catch (error) {
                showAlert('Error cargando cajas: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

    // --- Formularios y acciones avanzadas de cajas ---
    window.showAddBoxModal = function() {
            const html = `
                <h3>Agregar Nueva Caja</h3>
                <form id="addBoxForm" class="box-form">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="boxName">Nombre:</label>
                            <input type="text" id="boxName" required>
                        </div>
                        <div class="input-group">
                            <label for="boxCategory">Categoría:</label>
                            <select id="boxCategory" required>
                                <option value="Caja Premium">Caja Premium</option>
                                <option value="Caja Familiar">Caja Familiar</option>
                                <option value="Caja Exótica">Caja Exótica</option>
                                <option value="Caja Empresarial">Caja Empresarial</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="boxPriceCOP">Precio COP:</label>
                            <input type="number" id="boxPriceCOP" min="0" step="0.01" required>
                        </div>
                        <div class="input-group">
                            <label for="boxPriceUSD">Precio USD:</label>
                            <input type="number" id="boxPriceUSD" min="0" step="0.01" placeholder="Opcional">
                        </div>
                        <div class="input-group">
                            <label for="boxWeight">Peso estimado (kg):</label>
                            <input type="number" id="boxWeight" min="0" step="0.1" value="2.5">
                        </div>
                        <div class="input-group">
                            <label for="boxItems">Total de items:</label>
                            <input type="number" id="boxItems" min="1" value="5">
                        </div>
                        <div class="input-group">
                            <label for="boxStock">Stock disponible:</label>
                            <input type="number" id="boxStock" min="0" value="10">
                        </div>
                        <div class="input-group">
                            <label for="boxImage">Imagen (URL):</label>
                            <input type="url" id="boxImage" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="boxDescription">Descripción:</label>
                        <textarea id="boxDescription" rows="3" placeholder="Descripción breve de la caja"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="boxTags">Tags (separados por coma):</label>
                        <input type="text" id="boxTags" placeholder="orgánica, familiar, temporada">
                    </div>
                    <div class="form-group">
                        <label for="boxContents">Contenido (una fruta por línea):</label>
                        <textarea id="boxContents" rows="4" placeholder="Mango\nBanano\nPiña"></textarea>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="boxAvailable" checked>
                            <span class="checkmark"></span>
                            Disponible
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="boxFeatured">
                            <span class="checkmark"></span>
                            Destacada
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-success">Guardar Caja</button>
                    </div>
                </form>
            `;
            showModal(html);

            const form = document.getElementById('addBoxForm');
            if (!form) {
                return;
            }

            form.addEventListener('submit', async event => {
                event.preventDefault();

                const name = document.getElementById('boxName').value.trim();
                if (!name) {
                    showAlert('Ingresa un nombre válido para la caja.', 'warning');
                    return;
                }

                const priceCOP = parseFloat(document.getElementById('boxPriceCOP').value);
                if (!Number.isFinite(priceCOP) || priceCOP <= 0) {
                    showAlert('El precio en COP debe ser mayor que cero.', 'warning');
                    return;
                }

                const priceUSDInput = document.getElementById('boxPriceUSD').value;
                const priceUSD = priceUSDInput ? parseFloat(priceUSDInput) : 0;
                const weight = parseFloat(document.getElementById('boxWeight').value) || 0;
                const items = parseInt(document.getElementById('boxItems').value, 10) || 0;
                const stock = parseInt(document.getElementById('boxStock').value, 10) || 0;
                const tags = document.getElementById('boxTags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
                const contentsRaw = document.getElementById('boxContents').value
                    .split('\n')
                    .map(item => item.trim())
                    .filter(Boolean);

                const available = document.getElementById('boxAvailable').checked;
                const featured = document.getElementById('boxFeatured').checked;
                const createdBy = typeof window.getAdminUser === 'function' ? window.getAdminUser() : 'admin';

                const payload = {
                    name,
                    category: document.getElementById('boxCategory').value || 'Caja Premium',
                    description: document.getElementById('boxDescription').value.trim() || null,
                    image_url: document.getElementById('boxImage').value.trim() || null,
                    price_cop: Number.isFinite(priceCOP) ? priceCOP : 0,
                    price_usd: Number.isFinite(priceUSD) && priceUSD > 0 ? priceUSD : 0,
                    estimated_weight_kg: Number.isFinite(weight) ? weight : 0,
                    total_items: items > 0 ? items : contentsRaw.length,
                    stock_quantity: stock,
                    available,
                    in_stock: available && stock > 0,
                    featured,
                    tags,
                    slug: slugify(name),
                    created_by: createdBy
                };

                try {
                    showLoading('Guardando nueva caja...');
                    const created = await boxManager.addBox(payload);
                    if (created?.id && contentsRaw.length) {
                        await boxManager.updateBoxContents(created.id, contentsRaw);
                    }
                    showAlert('Caja creada correctamente.', 'success');
                    closeModal();
                    if (created?.id) {
                        await refreshBoxesSelector(created.id);
                    } else {
                        await refreshBoxesSelector();
                    }
                    await loadStats();
                } catch (error) {
                    console.error('Error creando caja:', error);
                    showAlert('Error creando la caja: ' + (error.message || error), 'danger');
                } finally {
                    hideLoading();
                }
            }, { once: true });
        };

        window.editSelectedBox = function() {
            const select = document.getElementById('manageBoxSelect');
            if (!select || !select.value) {
                showAlert('Selecciona una caja para editar.', 'warning');
                return;
            }
            window.editBox(Number(select.value));
        };

        window.deleteSelectedBox = async function() {
            const select = document.getElementById('manageBoxSelect');
            if (!select || !select.value) {
                showAlert('Selecciona una caja para eliminar.', 'warning');
                return;
            }
            const cached = getCachedBox(select.value);
            await window.deleteBoxById(Number(select.value), cached?.name || 'esta caja');
        };

        window.updateBoxStatus = async function() {
            const select = document.getElementById('manageBoxSelect');
            const statusSelect = document.getElementById('boxStatus');

            if (!select || !select.value) {
                showAlert('Selecciona una caja para actualizar.', 'warning');
                return;
            }

            if (!statusSelect || !statusSelect.value) {
                showAlert('Selecciona un estado para aplicar.', 'warning');
                return;
            }

            try {
                showLoading('Actualizando estado de la caja...');
                await boxManager.updateBoxStatus(Number(select.value), statusSelect.value);
                showAlert('Estado de la caja actualizado correctamente.', 'success');
                statusSelect.value = '';
                await refreshBoxesSelector(select.value);
                await loadStats();
            } catch (error) {
                console.error('Error actualizando estado de la caja:', error);
                showAlert('Error actualizando el estado: ' + (error.message || error), 'danger');
            } finally {
                hideLoading();
            }
        };

        window.deleteBoxById = async function(boxId, boxName = '') {
            const numericId = Number(boxId);
            if (!numericId) {
                showAlert('Identificador de caja inválido.', 'danger');
                return;
            }

            const label = boxName || getCachedBox(numericId)?.name || 'esta caja';
            if (!confirm(`¿Eliminar "${label}" de forma permanente?`)) {
                return;
            }

            try {
                showLoading('Eliminando caja...');
                await boxManager.deleteBox(numericId);
                showAlert('Caja eliminada correctamente.', 'success');
                closeModal();
                await refreshBoxesSelector();
                await loadStats();
            } catch (error) {
                console.error('Error eliminando la caja:', error);
                showAlert('Error eliminando la caja: ' + (error.message || error), 'danger');
            } finally {
                hideLoading();
            }
        };

        window.toggleBoxAvailability = async function(boxId, isActive) {
            const numericId = Number(boxId);
            if (!numericId) {
                return;
            }

            const targetStatus = isActive ? 'inactive' : 'active';
            try {
                showLoading('Actualizando disponibilidad...');
                await boxManager.updateBoxStatus(numericId, targetStatus);
                showAlert(`Caja ${isActive ? 'desactivada' : 'activada'} correctamente.`, 'success');
                await refreshBoxesSelector(numericId);
                await loadStats();
                if (document.getElementById('modal')?.style.display === 'flex') {
                    await window.showAllBoxes();
                }
            } catch (error) {
                console.error('Error actualizando disponibilidad:', error);
                showAlert('Error actualizando disponibilidad: ' + (error.message || error), 'danger');
            } finally {
                hideLoading();
            }
        };

        window.toggleBoxFeatured = async function(boxId, isFeatured) {
            const numericId = Number(boxId);
            if (!numericId) {
                return;
            }

            const targetStatus = isFeatured ? 'unfeatured' : 'featured';
            try {
                showLoading('Actualizando destacado...');
                await boxManager.updateBoxStatus(numericId, targetStatus);
                showAlert(`Caja ${isFeatured ? 'sin destaque' : 'marcada como destacada'}.`, 'success');
                await refreshBoxesSelector(numericId);
                await loadStats();
                if (document.getElementById('modal')?.style.display === 'flex') {
                    await window.showAllBoxes();
                }
            } catch (error) {
                console.error('Error actualizando destacado:', error);
                showAlert('Error actualizando destacado: ' + (error.message || error), 'danger');
            } finally {
                hideLoading();
            }
        };

        window.viewBoxDetails = async function(boxId) {
            const numericId = Number(boxId);
            if (!numericId) {
                showAlert('Identificador de caja inválido.', 'danger');
                return;
            }

            try {
                const box = await boxManager.getBoxWithContents(numericId);
                if (!box) {
                    showAlert('No se pudo cargar la caja seleccionada.', 'danger');
                    return;
                }

                const tags = Array.isArray(box.tags) && box.tags.length
                    ? box.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')
                    : '<span class="tag muted">Sin tags</span>';

                const contents = Array.isArray(box.contents) && box.contents.length
                    ? `<ul class="box-contents-list">${box.contents.map(item => `<li>${escapeHtml(item.product_name || item)}</li>`).join('')}</ul>`
                    : '<p style="color: #666;">Sin contenido registrado.</p>';

                const html = `
                    <div class="box-details">
                        <h3>${escapeHtml(box.name)}</h3>
                        <p style="color: #666;">${escapeHtml(box.description || 'Sin descripción')}</p>
                        <div class="box-info-grid">
                            <div><strong>Categoría:</strong> ${escapeHtml(box.category || 'Caja')}</div>
                            <div><strong>Precio COP:</strong> ${formatPrice(box.price_cop)}</div>
                            <div><strong>Precio USD:</strong> $${Number(box.price_usd || 0).toFixed(2)}</div>
                            <div><strong>Peso:</strong> ${Number(box.estimated_weight_kg || 0).toFixed(1)} kg</div>
                            <div><strong>Items:</strong> ${box.total_items || (box.contents?.length || 0)}</div>
                            <div><strong>Stock:</strong> ${box.stock_quantity || 0}</div>
                            <div><strong>Estado:</strong> ${box.available ? 'Activa' : 'Inactiva'}</div>
                            <div><strong>Destacada:</strong> ${box.featured ? 'Sí' : 'No'}</div>
                        </div>
                        <h4>Contenido</h4>
                        ${contents}
                        <h4>Tags</h4>
                        <div class="box-tags">${tags}</div>
                        <div class="form-actions" style="margin-top: 1.5rem; gap: 0.75rem;">
                            <button class="btn btn-warning" onclick="editBox(${box.id})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-success" onclick="toggleBoxAvailability(${box.id}, ${box.available ? 'true' : 'false'})">
                                <i class="fas fa-toggle-on"></i> ${box.available ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-secondary" onclick="toggleBoxFeatured(${box.id}, ${box.featured ? 'true' : 'false'})">
                                <i class="fas fa-star"></i> ${box.featured ? 'Quitar destacada' : 'Destacar'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteBoxById(${box.id}, ${JSON.stringify(box.name || '')})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;

                showModal(html);
            } catch (error) {
                console.error('Error cargando detalles de la caja:', error);
                showAlert('Error cargando detalles de la caja: ' + (error.message || error), 'danger');
            }
        };

        window.editBox = async function(boxId) {
            const numericId = Number(boxId);
            if (!numericId) {
                showAlert('Identificador de caja inválido.', 'danger');
                return;
            }

            try {
                showLoading('Cargando datos de la caja...');
                const box = await boxManager.getBoxWithContents(numericId);
                hideLoading();

                if (!box) {
                    showAlert('No se encontró la caja seleccionada.', 'danger');
                    return;
                }

                const tagsValue = Array.isArray(box.tags) ? box.tags.join(', ') : '';
                const contentsValue = Array.isArray(box.contents)
                    ? box.contents.map(item => item.product_name || '').join('\n')
                    : '';
                const html = `
                    <h3>Editar Caja</h3>
                    <form id="editBoxForm" class="box-form">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="editBoxName">Nombre:</label>
                                <input type="text" id="editBoxName" value="${escapeHtml(box.name || '')}" required>
                            </div>
                            <div class="input-group">
                                <label for="editBoxCategory">Categoría:</label>
                                <select id="editBoxCategory" required>
                                    <option value="Caja Premium"${box.category === 'Caja Premium' ? ' selected' : ''}>Caja Premium</option>
                                    <option value="Caja Familiar"${box.category === 'Caja Familiar' ? ' selected' : ''}>Caja Familiar</option>
                                    <option value="Caja Exótica"${box.category === 'Caja Exótica' ? ' selected' : ''}>Caja Exótica</option>
                                    <option value="Caja Empresarial"${box.category === 'Caja Empresarial' ? ' selected' : ''}>Caja Empresarial</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="editBoxPriceCOP">Precio COP:</label>
                                <input type="number" id="editBoxPriceCOP" min="0" step="0.01" value="${Number(box.price_cop || 0).toFixed(2)}" required>
                            </div>
                            <div class="input-group">
                                <label for="editBoxPriceUSD">Precio USD:</label>
                                <input type="number" id="editBoxPriceUSD" min="0" step="0.01" value="${Number(box.price_usd || 0).toFixed(2)}">
                            </div>
                            <div class="input-group">
                                <label for="editBoxWeight">Peso estimado (kg):</label>
                                <input type="number" id="editBoxWeight" min="0" step="0.1" value="${Number(box.estimated_weight_kg || 0).toFixed(1)}">
                            </div>
                            <div class="input-group">
                                <label for="editBoxItems">Total de items:</label>
                                <input type="number" id="editBoxItems" min="1" value="${box.total_items || (box.contents?.length || 0)}">
                            </div>
                            <div class="input-group">
                                <label for="editBoxStock">Stock disponible:</label>
                                <input type="number" id="editBoxStock" min="0" value="${box.stock_quantity || 0}">
                            </div>
                            <div class="input-group">
                                <label for="editBoxImage">Imagen (URL):</label>
                                <input type="url" id="editBoxImage" value="${escapeHtml(box.image_url || '')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editBoxDescription">Descripción:</label>
                            <textarea id="editBoxDescription" rows="3">${escapeHtml(box.description || '')}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="editBoxTags">Tags (separados por coma):</label>
                            <input type="text" id="editBoxTags" value="${escapeHtml(tagsValue)}">
                        </div>
                        <div class="form-group">
                            <label for="editBoxContents">Contenido (una fruta por línea):</label>
                            <textarea id="editBoxContents" rows="4">${escapeHtml(contentsValue)}</textarea>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editBoxAvailable" ${box.available ? 'checked' : ''}>
                                <span class="checkmark"></span>
                                Disponible
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="editBoxFeatured" ${box.featured ? 'checked' : ''}>
                                <span class="checkmark"></span>
                                Destacada
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Cambios</button>
                        </div>
                    </form>
                `;

                showModal(html);

                const form = document.getElementById('editBoxForm');
                if (!form) {
                    return;
                }

                form.addEventListener('submit', async event => {
                    event.preventDefault();

                    const name = document.getElementById('editBoxName').value.trim();
                    if (!name) {
                        showAlert('Ingresa un nombre válido para la caja.', 'warning');
                        return;
                    }

                    const priceCOP = parseFloat(document.getElementById('editBoxPriceCOP').value);
                    if (!Number.isFinite(priceCOP) || priceCOP <= 0) {
                        showAlert('El precio en COP debe ser mayor que cero.', 'warning');
                        return;
                    }

                    const priceUSDInput = document.getElementById('editBoxPriceUSD').value;
                    const priceUSD = priceUSDInput ? parseFloat(priceUSDInput) : 0;
                    const weight = parseFloat(document.getElementById('editBoxWeight').value) || 0;
                    const items = parseInt(document.getElementById('editBoxItems').value, 10) || 0;
                    const stock = parseInt(document.getElementById('editBoxStock').value, 10) || 0;
                    const tags = document.getElementById('editBoxTags').value
                        .split(',')
                        .map(tag => tag.trim())
                        .filter(Boolean);
                    const contentsRaw = document.getElementById('editBoxContents').value
                        .split('\n')
                        .map(item => item.trim())
                        .filter(Boolean);
                    const available = document.getElementById('editBoxAvailable').checked;
                    const featured = document.getElementById('editBoxFeatured').checked;

                    const payload = {
                        name,
                        category: document.getElementById('editBoxCategory').value || 'Caja Premium',
                        description: document.getElementById('editBoxDescription').value.trim() || null,
                        image_url: document.getElementById('editBoxImage').value.trim() || null,
                        price_cop: Number.isFinite(priceCOP) ? priceCOP : 0,
                        price_usd: Number.isFinite(priceUSD) && priceUSD > 0 ? priceUSD : 0,
                        estimated_weight_kg: Number.isFinite(weight) ? weight : 0,
                        total_items: items > 0 ? items : contentsRaw.length,
                        stock_quantity: stock,
                        available,
                        in_stock: available && stock > 0,
                        featured,
                        tags,
                        slug: box.slug || slugify(name)
                    };

                    try {
                        showLoading('Actualizando caja...');
                        await boxManager.updateBox(numericId, payload);
                        await boxManager.updateBoxContents(numericId, contentsRaw);
                        showAlert('Caja actualizada correctamente.', 'success');
                        closeModal();
                        await refreshBoxesSelector(numericId);
                        await loadStats();
                    } catch (error) {
                        console.error('Error actualizando la caja:', error);
                        showAlert('Error actualizando la caja: ' + (error.message || error), 'danger');
                    } finally {
                        hideLoading();
                    }
                }, { once: true });
            } catch (error) {
                hideLoading();
                console.error('Error cargando la caja:', error);
                showAlert('Error cargando la caja: ' + (error.message || error), 'danger');
            }
        };

        // Utility functions
        function showAlert(message, type = 'info') {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                `;
            } else {
                console.log(`Alert (${type}): ${message}`);
            }
        }

        function showLoading(message = 'Cargando...') {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        ${message}
                    </div>
                `;
            } else {
                console.log(`Loading: ${message}`);
            }
        }

        function hideLoading() {
            const reportContainer = document.getElementById('reportContainer');
            if (reportContainer) {
                reportContainer.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        <i class="fas fa-info-circle"></i>
                        Selecciona una acción para ver reportes
                    </p>
                `;
            }
        }

        const TOAST_ICONS = {
            success: 'fas fa-check-circle',
            error: 'fas fa-times-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };

        function getToastContainer() {
            let container = document.getElementById('adminToastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'adminToastContainer';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            return container;
        }

        // Render dismissible toast notifications for admin actions.
        function createToast(type, title, message) {
            const container = getToastContainer();
            const toast = document.createElement('div');
            toast.className = `admin-toast admin-toast-${type}`;

            const icon = document.createElement('i');
            icon.className = TOAST_ICONS[type] || TOAST_ICONS.info;
            toast.appendChild(icon);

            const titleEl = document.createElement('div');
            titleEl.className = 'toast-title';
            titleEl.textContent = title || '';
            toast.appendChild(titleEl);

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'toast-close';
            closeBtn.setAttribute('aria-label', 'Cerrar notificación');
            closeBtn.textContent = 'x';
            toast.appendChild(closeBtn);

            if (message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'toast-message';
                messageEl.textContent = message;
                toast.appendChild(messageEl);
            }

            const dismiss = () => {
                toast.classList.remove('is-visible');
            };

            let hideTimer = setTimeout(dismiss, 5000);

            closeBtn.addEventListener('click', () => {
                clearTimeout(hideTimer);
                dismiss();
            });

            toast.addEventListener('mouseenter', () => {
                clearTimeout(hideTimer);
            });

            toast.addEventListener('mouseleave', () => {
                hideTimer = setTimeout(dismiss, 2000);
            });

            toast.addEventListener('transitionend', event => {
                if (event.propertyName === 'opacity' && !toast.classList.contains('is-visible')) {
                    toast.remove();
                }
            });

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('is-visible');
            });

            return toast;
        }

        function showSuccess(title, message = '') {
            createToast('success', title, message);
        }

        function showError(title, message = '') {
            createToast('error', title, message);
        }

        function showWarning(title, message = '') {
            createToast('warning', title, message);
        }

        function showInfo(title, message = '') {
            createToast('info', title, message);
        }

        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            if (modal && modalContent) {
                modalContent.innerHTML = content;
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
            } else {
                console.warn('⚠️ Modal elements not found');
            }
        }

        window.closeModal = function() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
        };

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Función de emergencia para forzar cierre
        window.forceCloseModal = function() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.classList.add('hidden');
                console.log('✅ Modal forzado a cerrarse');
            }
        };

        // Environment configuration info
        window.showEnvironmentInfo = function() {
            const instructions = `
                <h3>� Configuración del Sistema</h3>
                
                <div style="text-align: left; line-height: 1.6;">
                    <div style="background: rgba(139, 218, 1, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h4 style="color: #1e3c72; margin-bottom: 1rem;">
                            <i class="fas fa-info-circle"></i> Sistema de Doble Base de Datos
                        </h4>
                        <p style="color: #666; margin-bottom: 1rem;">
                            El panel de administración utiliza un sistema dual de bases de datos para mejor organización:
                        </p>
                        <ul style="color: #666; margin-left: 1rem;">
                            <li><strong>Base de Usuarios:</strong> Maneja registros, login y perfiles</li>
                            <li><strong>Base de Productos:</strong> Maneja inventario, precios y administración</li>
                        </ul>
                    </div>
                    
                    <h4 style="color: #1e3c72;">📋 Variables de Entorno Configuradas</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.85rem;">
                        • VITE_SUPABASE_PRODUCTS_URL<br>
                        • VITE_SUPABASE_PRODUCTS_ANON_KEY<br>
                        • VITE_SUPABASE_URL (usuarios)<br>
                        • VITE_SUPABASE_ANON_KEY (usuarios)
                    </div>
                    
                    <h4 style="color: #1e3c72;">🚀 Para GitHub Pages</h4>
                    <ol style="color: #666;">
                        <li>Las variables están configuradas en el archivo <code>.env</code></li>
                        <li>GitHub Actions las utiliza automáticamente durante el build</li>
                        <li>El archivo <code>GITHUB-SECRETS.md</code> tiene instrucciones completas</li>
                                <li><strong>Database Password:</strong> Una contraseña segura</li>
                                <li><strong>Region:</strong> South America (más cerca de Colombia)</li>
                            </ul>
                        </li>
                        <li>Haz clic en <strong>"Create new project"</strong></li>
                        <li>⏳ Espera 2-3 minutos mientras se crea</li>
                    </ol>
                    
                    <h4>🔑 Paso 2: Obtener credenciales</h4>
                    <ol>
                        <li>Una vez creado el proyecto, ve a <strong>Settings → API</strong></li>
                        <li>Busca la sección <strong>"Project API keys"</strong></li>
                        <li>Copia estos dos valores:
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace;">
                                <strong>Project URL:</strong> https://tu-proyecto.supabase.co<br>
                                <strong>anon public:</strong> eyJhbGciOiJIUzI1NiIs...
                            </div>
                        </li>
                        <li>Pega estos valores en el formulario de arriba</li>
                    </ol>
                    
                    <h4>🗃️ Paso 3: Crear tablas (ejecutar SQL)</h4>
                    <ol>
                        <li>En tu proyecto de Supabase, ve a <strong>SQL Editor</strong></li>
                        <li>Ejecuta estos scripts en orden:
                            <div style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;">
                                -- 1. Primero ejecutar: setup-supabase-products.sql<br>
                                -- 2. Después ejecutar: insert-colombian-fruits.sql
                            </div>
                        </li>
                        <li>Los archivos SQL están en la carpeta <code>scripts/database/</code></li>
                    </ol>
                    
                    <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 1rem; border-radius: 8px; margin-top: 2rem;">
                        <strong>✅ ¡Listo!</strong> Una vez completados estos pasos, tu panel de administración podrá gestionar los precios e inventario de las 67 frutas colombianas.
                    </div>
                </div>
            `;
            
            showModal(instructions);
        };

        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(price);
        }

        function formatNumber(value) {
            const numeric = Number.isFinite(value) ? value : Number(value) || 0;
            return new Intl.NumberFormat('es-CO', {
                maximumFractionDigits: 0
            }).format(numeric);
        }

        // Chart instances
        let categoriesChart, pricesChart, stockChart, revenueChart, boxCategoryChart, boxStatusChart, boxValueChart;

        // Categories Distribution Chart
        function loadCategoriesChart(categories) {
            const ctx = document.getElementById('categoriesChart');
            if (!ctx) {
                console.warn('Categories chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (categoriesChart) {
                categoriesChart.destroy();
            }

            const labels = Object.keys(categories);
            const data = Object.values(categories).map(cat => cat.count);
            const colors = [
                'rgba(255, 155, 64, 0.8)',   // brand
                'rgba(139, 218, 1, 0.8)',    // brand-2
                'rgba(255, 139, 211, 0.8)',  // accent
                'rgba(243, 156, 18, 0.8)',   // warn
                'rgba(64, 196, 255, 0.8)',   // blue
                'rgba(255, 99, 132, 0.8)',   // red
                'rgba(75, 192, 192, 0.8)'    // teal
            ];

            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e9eef5',
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // Prices Trend Chart
        function loadPricesChart(products) {
            const ctx = document.getElementById('pricesChart');
            if (!ctx) {
                console.warn('Prices chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (pricesChart) {
                pricesChart.destroy();
            }

            // Group products by category and calculate average prices
            const categoryPrices = {};
            products.forEach(product => {
                if (!categoryPrices[product.category]) {
                    categoryPrices[product.category] = [];
                }
                categoryPrices[product.category].push(product.price_per_kg);
            });

            const labels = Object.keys(categoryPrices);
            const avgPrices = labels.map(category => {
                const prices = categoryPrices[category];
                return prices.reduce((sum, price) => sum + price, 0) / prices.length;
            });

            pricesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precio Promedio (COP/kg)',
                        data: avgPrices,
                        borderColor: '#ff9b40',
                        backgroundColor: 'rgba(255, 155, 64, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ff9b40',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Precio: ${formatPrice(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Stock Levels Chart
        function loadStockChart(products) {
            const ctx = document.getElementById('stockChart');
            if (!ctx) {
                console.warn('Stock chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (stockChart) {
                stockChart.destroy();
            }

            // Sort products by stock level and take top 10
            const sortedProducts = products
                .sort((a, b) => b.stock_kg - a.stock_kg)
                .slice(0, 10);

            const labels = sortedProducts.map(p => p.name);
            const stockData = sortedProducts.map(p => p.stock_kg);
            const minStockData = sortedProducts.map(p => p.min_stock_kg);

            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Actual (kg)',
                        data: stockData,
                        backgroundColor: 'rgba(139, 218, 1, 0.8)',
                        borderColor: '#8bda01',
                        borderWidth: 1
                    }, {
                        label: 'Stock Mínimo (kg)',
                        data: minStockData,
                        backgroundColor: 'rgba(255, 71, 87, 0.8)',
                        borderColor: '#ff4757',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Revenue by Category Chart
        function loadRevenueChart(categories) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) {
                console.warn('Revenue chart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (revenueChart) {
                revenueChart.destroy();
            }

            const labels = Object.keys(categories);
            const values = Object.values(categories).map(cat => cat?.totalValue || 0);

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor de Inventario (COP)',
                        data: values,
                        backgroundColor: 'rgba(255, 155, 64, 0.8)',
                        borderColor: '#ff9b40',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e9eef5',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            borderColor: '#ff9b40',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Valor: ${formatPrice(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Box Category Distribution
        function loadBoxCategoryChart(categories) {
            const ctx = document.getElementById('boxCategoryChart');
            if (!ctx) {
                console.warn('Box categories chart canvas not found');
                return;
            }

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (boxCategoryChart) {
                boxCategoryChart.destroy();
            }

            const labels = Object.keys(categories);
            const data = labels.map(label => categories[label]?.count || 0);
            const palette = [
                'rgba(139, 218, 1, 0.8)',
                'rgba(255, 155, 64, 0.8)',
                'rgba(255, 139, 211, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(64, 196, 255, 0.8)',
                'rgba(255, 99, 132, 0.8)'
            ];
            const backgroundColors = labels.map((_, index) => palette[index % palette.length]);

            boxCategoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: backgroundColors,
                        borderColor: '#0b0f14',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e9eef5'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5'
                        }
                    }
                }
            });
        }

        // Box Availability / Status Chart
        function loadBoxStatusChart(boxReport) {
            const ctx = document.getElementById('boxStatusChart');
            if (!ctx) {
                console.warn('Box status chart canvas not found');
                return;
            }

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (boxStatusChart) {
                boxStatusChart.destroy();
            }

            const activeNonFeatured = Math.max(0, (boxReport.activeBoxes || 0) - (boxReport.featuredActive || 0));
            const featured = boxReport.featuredActive || 0;
            const inactive = boxReport.inactiveBoxes || 0;

            boxStatusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Activas', 'Destacadas', 'Inactivas'],
                    datasets: [{
                        label: 'Cantidad de cajas',
                        data: [activeNonFeatured, featured, inactive],
                        backgroundColor: [
                            'rgba(139, 218, 1, 0.8)',
                            'rgba(255, 215, 0, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            '#8bda01',
                            '#ffd700',
                            '#ff4757'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9aa6b2'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Box Value Chart (Top boxes by inventory value)
        function loadBoxValueChart(boxes) {
            const ctx = document.getElementById('boxValueChart');
            if (!ctx) {
                console.warn('Box value chart canvas not found');
                return;
            }

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            if (boxValueChart) {
                boxValueChart.destroy();
            }

            const dataSource = (Array.isArray(boxes) ? boxes : []).map(box => {
                const stock = parseInt(box.stock_quantity ?? box.stock ?? 0, 10) || 0;
                const price = parseFloat(box.price_cop ?? 0) || 0;
                return {
                    name: box.name || 'Caja',
                    value: stock * price
                };
            }).filter(item => item.value > 0)
              .sort((a, b) => b.value - a.value)
              .slice(0, 8);

            const labels = dataSource.map(item => item.name);
            const values = dataSource.map(item => item.value);

            boxValueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Valor inventario (COP)',
                        data: values,
                        backgroundColor: 'rgba(255, 155, 64, 0.8)',
                        borderColor: '#ff9b40',
                        borderWidth: 2,
                        borderRadius: 10,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e9eef5',
                            bodyColor: '#e9eef5',
                            callbacks: {
                                label: function(context) {
                                    return ` ${formatPrice(context.parsed.x)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9aa6b2',
                                callback: value => formatPrice(value)
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9aa6b2'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Chart refresh functions
        window.refreshCategoriesChart = async function() {
            try {
                const { report } = await productManager.getInventoryReport();
                if (report) {
                    loadCategoriesChart(report.categories);
                }
            } catch (error) {
                console.error('Error refreshing categories chart:', error);
            }
        };

        window.refreshPricesChart = async function() {
            try {
                const { products } = await productManager.getInventoryReport();
                if (products) {
                    loadPricesChart(products);
                }
            } catch (error) {
                console.error('Error refreshing prices chart:', error);
            }
        };

        window.refreshStockChart = async function() {
            try {
                const { products } = await productManager.getInventoryReport();
                if (products) {
                    loadStockChart(products);
                }
            } catch (error) {
                console.error('Error refreshing stock chart:', error);
            }
        };

        window.refreshRevenueChart = async function() {
            try {
                const { report } = await productManager.getInventoryReport();
                if (report) {
                    loadRevenueChart(report.categories);
                }
            } catch (error) {
                console.error('Error refreshing revenue chart:', error);
            }
        };

        window.refreshBoxCategoryChart = async function() {
            try {
                if (!boxManager) {
                    throw new Error('Box manager no inicializado');
                }
                const boxes = await boxManager.getAllBoxes();
                allBoxes = Array.isArray(boxes) ? boxes.slice() : [];
                await loadStats();
            } catch (error) {
                console.error('Error refreshing box categories chart:', error);
                showAlert('No se pudieron actualizar los gráficos de cajas.', 'danger');
            }
        };

        window.refreshBoxStatusChart = async function() {
            try {
                if (!boxManager) {
                    throw new Error('Box manager no inicializado');
                }
                const boxes = await boxManager.getAllBoxes();
                allBoxes = Array.isArray(boxes) ? boxes.slice() : [];
                await loadStats();
            } catch (error) {
                console.error('Error refreshing box status chart:', error);
                showAlert('No se pudo actualizar el estado de las cajas.', 'danger');
            }
        };

        window.refreshBoxValueChart = async function() {
            try {
                if (!boxManager) {
                    throw new Error('Box manager no inicializado');
                }
                const boxes = await boxManager.getAllBoxes();
                allBoxes = Array.isArray(boxes) ? boxes.slice() : [];
                await loadStats();
            } catch (error) {
                console.error('Error refreshing box value chart:', error);
                showAlert('No se pudo actualizar el valor de las cajas.', 'danger');
            }
        };

        // Product Management Functions
        window.showAddProductModal = function() {
            document.getElementById('addProductModal').style.display = 'block';
        };

        window.closeAddProductModal = function() {
            const modal = document.getElementById('addProductModal');
            const form = document.getElementById('addProductForm');
            
            modal.style.display = 'none';
            form.reset();
            
            // Reset modal to add mode
            delete form.dataset.editingId;
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Nuevo Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-plus"></i> Crear Producto';
        };

        // Handle add product form submission
        function setupFormHandlers() {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleAddProduct();
                });
                console.log('✅ Form handlers setup');
            } else {
                console.warn('⚠️ Add product form not found');
            }
        }

        async function handleAddProduct() {
            try {
                const form = document.getElementById('addProductForm');
                const formData = new FormData(form);
                const isEditing = form.dataset.editingId;
                
                const productData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    description: formData.get('description') || '',
                    image_url: formData.get('image') || '/images/products/placeholder.jpg',
                    price: parseFloat(formData.get('price')),
                    price_per_kg: parseFloat(formData.get('price')),
                    cost_per_kg: parseFloat(formData.get('cost')) || 0,
                    stock: parseFloat(formData.get('stock')) || 0,
                    stock_kg: parseFloat(formData.get('stock')) || 0,
                    min_stock: parseFloat(formData.get('minStock')) || 0,
                    min_stock_kg: parseFloat(formData.get('minStock')) || 0,
                    origin: formData.get('origin') || 'Colombia',
                    supplier: formData.get('supplier') || null,
                    rating: parseFloat(formData.get('rating')) || 4.0,
                    organic: formData.get('organic') === 'on',
                    available: formData.get('active') === 'on'
                };

                if (isEditing) {
                    console.log('Updating product:', productData);
                    showLoading('Actualizando producto...');
                    
                    // Usar la función global updateCompleteProduct del storeService
                    const result = await window.updateCompleteProduct(isEditing, {
                        name: productData.name,
                        category: productData.category,
                        description: productData.description,
                        image_url: productData.image_url,
                        price_per_kg: productData.price_per_kg,
                        cost_per_kg: productData.cost_per_kg,
                        stock_kg: productData.stock_kg,
                        min_stock_kg: productData.min_stock_kg,
                        origin: productData.origin,
                        supplier: productData.supplier,
                        rating: productData.rating,
                        is_organic: productData.organic,
                        is_active: productData.available
                    });
                    
                    if (result.success) {
                        showSuccess('✏️ Producto actualizado', `${productData.name} se actualizó correctamente`);
                        closeAddProductModal();
                        await loadInitialData(); // Refresh all data
                    } else {
                        showError('❌ Error al actualizar', result.error || 'No se pudo actualizar el producto');
                    }
                } else {
                    console.log('Creating product:', productData);
                    showLoading('Creando producto...');

                    // Usar la función global createProduct del storeService
                    const result = await window.createProduct({
                        name: productData.name,
                        category: productData.category,
                        description: productData.description,
                        image_url: productData.image_url,
                        price_per_kg: productData.price_per_kg,
                        cost_per_kg: productData.cost_per_kg,
                        stock_kg: productData.stock_kg,
                        min_stock_kg: productData.min_stock_kg,
                        origin: productData.origin,
                        supplier: productData.supplier,
                        rating: productData.rating,
                        is_organic: productData.organic,
                        is_active: productData.available
                    });
                    
                    if (result.success) {
                        showSuccess('🎉 Producto creado', `${productData.name} se agregó al catálogo exitosamente`);
                        closeAddProductModal();
                        await loadInitialData(); // Refresh all data
                    } else {
                        showError('❌ Error al crear producto', result.error || 'No se pudo crear el producto');
                    }
                }
            } catch (error) {
                console.error('Error in handleAddProduct:', error);
                showError('💥 Error del sistema', `Error inesperado: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Las funciones createProduct, updateCompleteProduct y deleteProduct 
        // ahora están disponibles globalmente desde storeService.js

        // Product management functions
        window.editSelectedProduct = function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showAlert('Por favor selecciona un producto para editar', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            // Pre-fill the modal with current product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price_per_kg;
            document.getElementById('productCost').value = product.cost_per_kg || '';
            document.getElementById('productStock').value = product.stock_kg || '';
            document.getElementById('productMinStock').value = product.min_stock_kg || '';
            document.getElementById('productOrigin').value = product.origin || 'Colombia';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productRating').value = product.rating || '4';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImage').value = product.image_url || '';
            document.getElementById('productOrganic').checked = product.organic || false;
            document.getElementById('productActive').checked = product.available;
            
            // Change modal title and button
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            
            // Store the product ID for updating
            document.getElementById('addProductForm').dataset.editingId = productId;
            
            showAddProductModal();
        };

        window.deleteSelectedProduct = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showAlert('Por favor selecciona un producto para eliminar', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            if (!confirm(`¿Estás seguro de que quieres eliminar "${product.name}"? Esta acción no se puede deshacer.`)) {
                return;
            }

            try {
                showLoading('Eliminando producto...');

                // Usar la función global deleteProduct del storeService
                const result = await window.deleteProduct(productId);

                if (result.success) {
                    showAlert('Producto eliminado exitosamente', 'success');
                    await loadInitialData(); // Refresh all data
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Error eliminando producto: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        window.updateProductStatus = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            const newStatus = document.getElementById('productStatus').value;
            
            if (!productId || !newStatus) {
                showAlert('Por favor selecciona un producto y un estado', 'warning');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showAlert('Producto no encontrado', 'danger');
                return;
            }
            
            const isActive = newStatus === 'active';
            const statusText = isActive ? 'activar' : 'desactivar';
            
            if (!confirm(`¿Estás seguro de que quieres ${statusText} "${product.name}"?`)) {
                return;
            }

            try {
                showLoading(`${statusText === 'activar' ? 'Activando' : 'Desactivando'} producto...`);

                if (!window.productsClient) {
                    throw new Error('Cliente de productos no inicializado');
                }

                const { error } = await window.productsClient
                    .from('current_products')
                    .update({ 
                        available: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showAlert(`Producto ${statusText === 'activar' ? 'activado' : 'desactivado'} exitosamente`, 'success');
                
                // Clear selections
                document.getElementById('manageProductSelect').value = '';
                document.getElementById('productStatus').value = '';
                
                await loadInitialData(); // Refresh all data
            } catch (error) {
                console.error('Error updating product status:', error);
                showAlert('Error actualizando estado del producto: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        };

        // Delete product function (legacy - for compatibility)
        window.deleteProduct = async function(productId, productName) {
            if (!confirm(`🗑️ ¿Estás seguro de que quieres eliminar "${productName}"?\n\nEsta acción desactivará el producto pero mantendrá los datos históricos.`)) {
                return;
            }

            try {
                showLoading('Eliminando producto...');

                if (!window.productsClient) {
                    throw new Error('Cliente de productos no inicializado');
                }

                const { error } = await window.productsClient
                    .from('current_products')
                    .update({ 
                        available: false,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showSuccess('🗑️ Producto eliminado', `${productName} se desactivó correctamente`);
                await loadInitialData(); // Refresh all data
            } catch (error) {
                console.error('Error deleting product:', error);
                showError('❌ Error al eliminar', `No se pudo eliminar ${productName}: ${error.message}`);
            } finally {
                hideLoading();
            }
        };

        // Export products function
        window.exportProducts = async function() {
            try {
                showLoading('Generando archivo de exportación...');
                
                const products = await productManager.getAllProducts();
                const csvContent = generateProductsCSV(products);
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `productos_fruvi_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('📊 Exportación completada', `Archivo CSV descargado con ${products.length} productos`);
            } catch (error) {
                console.error('Error exporting products:', error);
                showError('❌ Error en exportación', `No se pudo generar el archivo: ${error.message}`);
            } finally {
                hideLoading();
            }
        };

        function generateProductsCSV(products) {
            const headers = [
                'ID', 'Nombre', 'Categoría', 'Precio (COP/kg)', 'Costo (COP/kg)', 
                'Stock (kg)', 'Stock Mínimo (kg)', 'Orgánico', 'Calificación', 
                'Origen', 'Activo'
            ];
            
            const rows = products.map(product => [
                product.id,
                `"${product.name}"`,
                `"${product.category}"`,
                product.price_per_kg,
                product.cost_per_kg || 0,
                product.stock_kg || 0,
                product.min_stock_kg || 0,
                product.organic ? 'Sí' : 'No',
                product.rating || 4.0,
                `"${product.origin || 'Colombia'}"`,
                product.available ? 'Sí' : 'No'
            ]);
            
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }



        // Initialize when page loads
        window.addEventListener('load', function() {
            // Ensure modal is hidden on load
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
            
            const addModal = document.getElementById('addProductModal');
            if (addModal) {
                addModal.style.display = 'none';
            }
            
            console.log('🔄 Página de administración cargada, inicializando...');
            
            // Check Chart.js availability
            if (typeof Chart !== 'undefined') {
                console.log('✅ Chart.js loaded successfully:', Chart.version || 'unknown version');
            } else {
                console.warn('⚠️ Chart.js not loaded');
            }
            
            // Setup form handlers
            setupFormHandlers();
            
            // Check if Supabase library is loaded
            if (!window.supabase) {
                updateConnectionStatus(false, 'Cargando biblioteca de Supabase...');
                // Wait a bit for Supabase to load
                setTimeout(() => {
                    if (window.supabase) {
                        init();
                    } else {
                        updateConnectionStatus(false, 'Error cargando Supabase. Verifica tu conexión a internet.');
                    }
                }, 2000);
            } else {
                // Initialize immediately
                init();
            }
        });
    </script>
</body>
</html>