<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Fruvi Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
</head>
<body>
    <!-- üîî Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <div class="admin-container">
        <!-- Header with Navigation Menu -->
        <header class="header">
            <div class="navbar">
                <div class="logo">
                    <img src="/images/logo.png" alt="Fruvi Store" class="logo-mark" onerror="this.style.display='none'">
                    <span>Fruvi Store</span>
                </div>

                <!-- Main Navigation Menu -->
                                <nav class="nav-links">
                    <a href="#" class="nav-item active" onclick="event.preventDefault(); showSection('dashboard', this)">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                    <a href="#" class="nav-item" onclick="event.preventDefault(); showSection('store', this)">
                        <i class="fas fa-store"></i>
                        Gesti√≥n Tienda
                    </a>
                    <a href="#" class="nav-item" onclick="event.preventDefault(); showSection('boxes', this)">
                        <i class="fas fa-box"></i>
                        Gesti√≥n Cajas
                    </a>
                    <a href="#" class="nav-item" onclick="event.preventDefault(); showSection('credits', this)">
                        <i class="fas fa-coins"></i>
                        Gesti√≥n Cr√©ditos
                    </a>
                </nav>

                <div class="header-actions">
                    <div class="user-info" id="userInfo">
                        <!-- Se llena din√°micamente con JavaScript -->
                    </div>
                    <button class="btn-secondary logout-btn" onclick="logout()" title="Cerrar Sesi√≥n">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="btn-text">Salir</span>
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button class="mobile-menu" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Connection Status -->
            <div id="connectionStatus" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Verificando conexi√≥n con Supabase...
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section active">
                <div id="dashboard-content">
                    <!-- Dashboard content will be loaded here dynamically -->
                </div>
            </div>

            <!-- Store Management Section -->
            <div id="store-section" class="content-section">
                <div id="store-management-content">
                    <!-- Store management content will be loaded here -->
                </div>
            </div>

            <!-- Boxes Management Section -->
            <div id="boxes-section" class="content-section">
                <div id="boxes-management-content">
                    <!-- Boxes management content will be loaded here -->
                </div>
            </div>

            <!-- Credits Management Section -->
            <div id="credits-section" class="content-section">
                <div id="credits-management-content">
                    <!-- Credits management content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="/scripts/services/supabaseService.js"></script>
    <script type="module" src="/scripts/services/subscriptionService.js"></script>
    <script type="module" src="/scripts/services/storeService.js"></script>
    <script type="module" src="/scripts/services/productManager.js"></script>
    <script type="module" src="/scripts/services/adminDatabaseService.js"></script>
    <script type="module" src="/admin/adminDashboard.js"></script>
    <script type="module">
        // Section management
        let currentSection = 'dashboard';
        let modulesLoaded = {};

        window.showSection = async function(sectionName, clickedElement = null) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // If called from event, highlight the clicked nav item
            if (clickedElement) {
                const navItem = clickedElement.classList.contains('nav-item') 
                    ? clickedElement 
                    : clickedElement.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // Otherwise, find and highlight by section name
                const navLink = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navLink) {
                    navLink.classList.add('active');
                }
            }

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                currentSection = sectionName;

                // Load module if not already loaded
                if (sectionName !== 'dashboard' && !modulesLoaded[sectionName]) {
                    await loadManagementModule(sectionName);
                }
            }
        };

        async function loadManagementModule(moduleName) {
            try {
                const containerId = moduleName + '-management-content';
                const contentContainer = document.getElementById(containerId);
                if (!contentContainer) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }

                // Load the module without showing loading animation
                let module;
                switch(moduleName) {
                    case 'store':
                        module = await import('./storeManagement.js');
                        break;
                    case 'boxes':
                        module = await import('./boxesManagement.js');
                        break;
                    case 'credits':
                        module = await import('./creditsManagement.js');
                        break;
                }

                if (module && module.default) {
                    // Initialize the module with container ID - it will render its own content
                    await module.default.initialize(containerId);
                    modulesLoaded[moduleName] = true;
                    console.log(`‚úÖ ${moduleName} module loaded successfully`);
                }
            } catch (error) {
                console.error('Error loading management module:', error);
                const contentContainer = document.getElementById(moduleName + '-management-content');
                if (contentContainer) {
                    contentContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error cargando el m√≥dulo: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for all services to be initialized
            await waitForServices();

            // Initialize dashboard
            initializeDashboard();
        });

        async function waitForServices() {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds

            while (attempts < maxAttempts) {
                // Check if critical services are available
                if (window.productsClient && window.usersClient) {
                    console.log('‚úÖ All critical services initialized');
                    
                    // Wait a bit more for adminDatabaseService if not ready
                    if (!window.adminDatabaseService) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                    
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            console.warn('‚ö†Ô∏è Some services may not be fully initialized, continuing anyway...');
        }

        async function initializeDashboard() {
            try {
                // Update connection status
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.className = 'alert alert-success';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a Supabase';
                    setTimeout(() => statusElement.style.display = 'none', 3000);
                }

                // Initialize dashboard using the global function
                if (window.initAdminDashboard && typeof window.initAdminDashboard === 'function') {
                    await window.initAdminDashboard();
                } else {
                    console.warn('‚ö†Ô∏è initAdminDashboard function not available');
                }

                console.log('‚úÖ Dashboard initialized');
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
            }
        }

        // Dashboard functions
        window.refreshDashboard = async function() {
            console.log('üîÑ Refreshing dashboard...');
            // This would refresh dashboard data
            // For now, just show a message
            showNotification('Dashboard actualizado', 'success');
        };

        window.generateReport = function() {
            console.log('üìä Generating report...');
            showNotification('Funcionalidad de reporte pr√≥ximamente disponible', 'info');
        };

        window.logout = function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminUser');
                window.location.href = './secure-access.html';
            }
        };

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button onclick="this.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
