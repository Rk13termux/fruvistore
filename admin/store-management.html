<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Tienda - Fruvi Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="/scripts/services/storeService.js"></script>
    <script type="module" src="/scripts/services/productManager.js"></script>

    <style>
        .admin-main {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
            width: 100%;
            margin: 0 auto;
            display: block;
        }
        .admin-container {
            min-height: 100vh;
            background: #000000;
            width: 100%;
            margin: 0 auto;
            display: block;
        }

        /* Additional styles for enhanced functionality */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .status-badge.inactive {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        .stock-indicator {
            font-weight: 600;
        }

        .stock-indicator.in-stock {
            color: #28a745;
        }

        .stock-indicator.low-stock {
            color: #ffc107;
        }

        .stock-indicator.out-of-stock {
            color: #dc3545;
        }

        .badge.organic {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .admin-table th,
        .admin-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .admin-table th {
            background: linear-gradient(135deg, var(--surface), rgba(255, 255, 255, 0.05));
            font-weight: 700;
            color: var(--txt);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .admin-table tr:hover {
            background: rgba(255, 155, 64, 0.05);
        }

        .admin-table tr.low-stock {
            background: rgba(255, 193, 7, 0.1);
        }

        .admin-table tr.out-of-stock {
            background: rgba(220, 53, 69, 0.1);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }

        .btn-sm:hover {
            transform: translateY(-1px);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .price-display {
            font-weight: 700;
            font-size: 1.1em;
        }

        .price-display.positive {
            color: #28a745;
        }

        .price-display.zero {
            color: #6c757d;
        }

        .product-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .product-name i {
            color: var(--brand);
        }

        /* Responsive table */
        @media (max-width: 768px) {
            .admin-table {
                font-size: 0.875rem;
            }

            .admin-table th,
            .admin-table td {
                padding: 0.5rem;
            }

            .admin-table th:nth-child(6),
            .admin-table td:nth-child(6),
            .admin-table th:nth-child(8),
            .admin-table td:nth-child(8),
            .admin-table th:nth-child(9),
            .admin-table td:nth-child(9) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- üîî Contenedor de Notificaciones Push -->
    <div id="notificationContainer" class="notification-container"></div>

    <div class="admin-container">
        <!-- Header with Navigation Menu -->
        <header class="header">
            <div class="navbar">
                <div class="logo">
                    <img src="/images/logo.png" alt="Fruvi Store" class="logo-mark" onerror="this.style.display='none'">
                    <span>Fruvi Store</span>
                </div>

                <!-- Main Navigation Menu -->
                <nav class="nav-links">
                    <a href="admin-panel-secure.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="store-management.html" class="nav-item active">
                        <i class="fas fa-store"></i>
                        <span>Tienda</span>
                    </a>
                    <a href="boxes-management.html" class="nav-item">
                        <i class="fas fa-boxes-stacked"></i>
                        <span>Cajas</span>
                    </a>
                    <a href="credits-management.html" class="nav-item">
                        <i class="fas fa-brain"></i>
                        <span>Cr√©ditos</span>
                    </a>
                </nav>

                <div class="header-actions">
                    <div class="user-info" id="userInfo">
                        <!-- Se llena din√°micamente con JavaScript -->
                    </div>
                    <button class="btn-secondary logout-btn" onclick="logout()" title="Cerrar Sesi√≥n">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="btn-text">Salir</span>
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button class="mobile-menu" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="admin-main">

        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Verificando conexi√≥n con Supabase...
        </div>

        <!-- Product Management Section -->
        <div class="product-management">
            <!-- Main Management Header -->
            <div class="management-header">
                <h2><i class="fas fa-store"></i> Gesti√≥n Completa de Productos</h2>
                <div class="management-actions">
                    <button class="btn" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                    <button class="btn btn-info" onclick="showCategoriesModal()">
                        <i class="fas fa-tags"></i> Gestionar Categor√≠as
                    </button>
                    <button class="btn btn-warning" onclick="showSuppliersModal()">
                        <i class="fas fa-truck"></i> Proveedores
                    </button>
                    <button class="btn btn-success" onclick="showBulkActionsModal()">
                        <i class="fas fa-tasks"></i> Acciones Masivas
                    </button>
                </div>
            </div>

            <!-- Search and Filters Bar -->
            <div class="admin-card" style="margin-bottom: 1.5rem;">
                <div class="flex flex-wrap" style="gap: 1rem; align-items: center;">
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <label for="searchProducts" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Buscar productos:</label>
                        <input type="text" id="searchProducts" placeholder="Nombre, categor√≠a, proveedor..." onkeyup="filterProductsTable()">
                    </div>
                    <div class="input-group">
                        <label for="filterCategory" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Categor√≠a:</label>
                        <select id="filterCategory" onchange="filterProductsTable()">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="filterStatus" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Estado:</label>
                        <select id="filterStatus" onchange="filterProductsTable()">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                            <option value="low_stock">Stock Bajo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="admin-card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> Cat√°logo de Productos</h3>
                    <div class="flex" style="gap: 0.5rem;">
                        <button class="btn btn-sm btn-info" onclick="refreshProductsTable()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <span id="productsCount" class="text-muted">Cargando...</span>
                    </div>
                </div>

                <div id="productsTableContainer" style="max-height: 600px; overflow-y: auto;">
                    <table id="productsTable" class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Precio</th>
                                <th>Costo</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Proveedor</th>
                                <th>√öltima Modificaci√≥n</th>
                                <th style="width: 150px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando productos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions Grid -->
            <div class="admin-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Acciones R√°pidas</h3>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Price Management -->
                    <div class="admin-card" style="margin: 0; background: rgba(255, 155, 64, 0.1);">
                        <h4 style="color: #ff9b40; margin-bottom: 1rem;"><i class="fas fa-dollar-sign"></i> Gesti√≥n de Precios</h4>
                        <div class="input-group">
                            <label for="priceProductSelect">Producto:</label>
                            <select id="priceProductSelect">
                                <option value="">Seleccionar producto...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="newPrice">Nuevo precio (COP/kg):</label>
                            <input type="number" id="newPrice" step="100" min="0" placeholder="5000">
                        </div>
                        <div class="input-group">
                            <label for="priceReason">Raz√≥n del cambio:</label>
                            <input type="text" id="priceReason" placeholder="Ajuste de mercado">
                        </div>
                        <button class="btn btn-success" onclick="updateSinglePrice()">
                            <i class="fas fa-save"></i> Actualizar Precio
                        </button>
                    </div>

                    <!-- Bulk Price Update -->
                    <div class="admin-card" style="margin: 0; background: rgba(139, 218, 1, 0.1);">
                        <h4 style="color: #8bda01; margin-bottom: 1rem;"><i class="fas fa-percentage"></i> Aumento Masivo</h4>
                        <div class="input-group">
                            <label for="categorySelect">Categor√≠a:</label>
                            <select id="categorySelect">
                                <option value="">Todas las categor√≠as</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="increasePercent">Porcentaje de aumento:</label>
                            <input type="number" id="increasePercent" step="0.1" min="0" max="100" placeholder="5.0">
                        </div>
                        <button class="btn btn-success" onclick="applyBulkIncrease()">
                            <i class="fas fa-arrow-up"></i> Aplicar Aumento
                        </button>
                    </div>

                    <!-- Stock Management -->
                    <div class="admin-card" style="margin: 0; background: rgba(64, 196, 255, 0.1);">
                        <h4 style="color: #40c4ff; margin-bottom: 1rem;"><i class="fas fa-boxes"></i> Gesti√≥n de Stock</h4>
                        <div class="input-group">
                            <label for="stockProductSelect">Producto:</label>
                            <select id="stockProductSelect">
                                <option value="">Seleccionar producto...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="stockChange">Cambio en stock (kg):</label>
                            <input type="number" id="stockChange" step="0.1" placeholder="10.5 (positivo para agregar)">
                        </div>
                        <div class="input-group">
                            <label for="stockReason">Raz√≥n:</label>
                            <input type="text" id="stockReason" placeholder="Reabastecimiento">
                        </div>
                        <button class="btn btn-info" onclick="updateStock()">
                            <i class="fas fa-plus-minus"></i> Actualizar Stock
                        </button>
                    </div>

                    <!-- Product Status -->
                    <div class="admin-card" style="margin: 0; background: rgba(255, 193, 7, 0.1);">
                        <h4 style="color: #ffc107; margin-bottom: 1rem;"><i class="fas fa-toggle-on"></i> Estado de Productos</h4>
                        <div class="input-group">
                            <label for="manageProductSelect">Producto:</label>
                            <select id="manageProductSelect">
                                <option value="">Seleccionar producto...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="productStatus">Nuevo estado:</label>
                            <select id="productStatus">
                                <option value="">Seleccionar estado...</option>
                                <option value="active">Activar Producto</option>
                                <option value="inactive">Desactivar Producto</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="updateProductStatus()">
                            <i class="fas fa-toggle-on"></i> Cambiar Estado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Actions -->
            <div class="admin-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-cogs"></i> Herramientas Avanzadas</h3>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-info" onclick="showLowStock()">
                        <i class="fas fa-exclamation-triangle"></i> Ver Stock Bajo
                    </button>
                    <button class="btn btn-secondary" onclick="showAllProducts()">
                        <i class="fas fa-list"></i> Lista Completa
                    </button>
                    <button class="btn btn-primary" onclick="viewPriceHistory()">
                        <i class="fas fa-history"></i> Historial de Precios
                    </button>
                    <button class="btn btn-success" onclick="loadInventoryReport()">
                        <i class="fas fa-chart-bar"></i> Reporte Inventario
                    </button>
                    <button class="btn btn-warning" onclick="loadDailyReport()">
                        <i class="fas fa-calendar-day"></i> Reporte Diario
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Exportar Datos
                    </button>
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div>
                        <h4><i class="fas fa-upload"></i> Importar Precios desde CSV</h4>
                        <div class="input-group">
                            <input type="file" id="csvFile" accept=".csv">
                            <small style="color: #666; font-size: 0.85rem;">
                                Formato: product_id, new_price, reason
                            </small>
                        </div>
                        <button class="btn btn-secondary" onclick="importPricesFromCSV()">
                            <i class="fas fa-upload"></i> Importar CSV
                        </button>
                    </div>

                    <div>
                        <h4><i class="fas fa-database"></i> Backup y Restauraci√≥n</h4>
                        <div class="flex" style="gap: 0.5rem;">
                            <button class="btn btn-warning" onclick="createBackup()">
                                <i class="fas fa-save"></i> Crear Backup
                            </button>
                            <button class="btn btn-danger" onclick="showRestoreModal()">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div class="admin-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Reportes y Estad√≠sticas</h3>
                </div>

                <div id="reportContainer">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Selecciona una acci√≥n de reporte para ver los resultados aqu√≠</p>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="product-modal hidden">
        <div class="modal-overlay" onclick="closeAddProductModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h3>
                <button class="modal-close" onclick="closeAddProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addProductForm" class="product-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productName">Nombre del Producto:</label>
                        <input type="text" id="productName" name="name" required placeholder="Ej: Mango Tommy">
                    </div>

                    <div class="form-group">
                        <label for="productCategory">Categor√≠a:</label>
                        <select id="productCategory" name="category" required>
                            <option value="">Seleccionar categor√≠a...</option>
                            <option value="Bayas">Bayas</option>
                            <option value="Bananos">Bananos</option>
                            <option value="C√≠tricas">C√≠tricas</option>
                            <option value="Ex√≥ticas">Ex√≥ticas</option>
                            <option value="Frutas Dulces">Frutas Dulces</option>
                            <option value="Tropicales">Tropicales</option>
                            <option value="Uvas">Uvas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productPrice">Precio por kg (COP):</label>
                        <input type="number" id="productPrice" name="price" step="100" min="0" required placeholder="5000">
                    </div>

                    <div class="form-group">
                        <label for="productCost">Costo por kg (COP):</label>
                        <input type="number" id="productCost" name="cost" step="100" min="0" placeholder="3000">
                    </div>

                    <div class="form-group">
                        <label for="productStock">Stock Inicial (kg):</label>
                        <input type="number" id="productStock" name="stock" step="1" min="0" required placeholder="100">
                    </div>

                    <div class="form-group">
                        <label for="productMinStock">Stock M√≠nimo (kg):</label>
                        <input type="number" id="productMinStock" name="minStock" step="1" min="0" required placeholder="10">
                    </div>

                    <div class="form-group">
                        <label for="productOrigin">Origen:</label>
                        <input type="text" id="productOrigin" name="origin" value="Colombia" placeholder="Colombia">
                    </div>

                    <div class="form-group">
                        <label for="productSupplier">Proveedor:</label>
                        <input type="text" id="productSupplier" name="supplier" placeholder="Proveedor local">
                    </div>

                    <div class="form-group">
                        <label for="productRating">Calificaci√≥n (1-5):</label>
                        <input type="number" id="productRating" name="rating" step="0.1" min="1" max="5" value="4.0" placeholder="4.0">
                    </div>

                    <div class="form-group">
                        <label for="productImageName">Nombre de imagen:</label>
                        <input type="text" id="productImageName" name="imageName" placeholder="mango-tommy">
                        <small style="color: #666; font-size: 0.8rem;">Sin extensi√≥n (.jpg, .png, etc.)</small>
                    </div>

                    <div class="form-group">
                        <label for="productImageFormat">Formato de imagen:</label>
                        <select id="productImageFormat" name="imageFormat">
                            <option value="jpg">JPG</option>
                            <option value="png">PNG</option>
                            <option value="webp">WebP</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="productDescription">Descripci√≥n:</label>
                    <textarea id="productDescription" name="description" rows="3" placeholder="Describe las caracter√≠sticas del producto..."></textarea>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="productOrganic" name="organic">
                        Producto org√°nico
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="productActive" name="active" checked>
                        Producto activo
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Crear Producto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication check
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('adminAuthenticated') === 'true';
            const authTime = parseInt(localStorage.getItem('adminAuthTime') || '0');
            const now = Date.now();
            const sessionDuration = 8 * 60 * 60 * 1000; // 8 hours

            if (!isAuthenticated || (now - authTime) > sessionDuration) {
                localStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('adminAuthTime');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminUser');
                window.location.href = './secure-access.html';
                return false;
            }
            return true;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('adminAuthenticated');
            localStorage.removeItem('adminAuthTime');
            localStorage.removeItem('adminLoginTime');
            localStorage.removeItem('adminUser');
            window.location.href = './secure-access.html';
        }

        // Mobile menu functionality
        function initMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const navLinks = document.querySelector('.nav-links');

            if (mobileMenuBtn && navLinks) {
                mobileMenuBtn.addEventListener('click', function() {
                    navLinks.classList.toggle('show');
                });

                // Close menu when clicking on a nav item
                navLinks.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', function() {
                        navLinks.classList.remove('show');
                    });
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenuBtn.contains(event.target) && !navLinks.contains(event.target)) {
                        navLinks.classList.remove('show');
                    }
                });
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            if (!checkAuth()) return;

            // Initialize mobile menu
            initMobileMenu();

            // Setup form handlers
            setupFormHandlers();

            // Load initial data
            loadInitialData();
        });

        // Global variables
        let allProducts = [];

        // Initialize Supabase and load data
        async function init() {
            try {
                // Check if Supabase is available
                if (typeof supabase === 'undefined') {
                    updateConnectionStatus(false, 'Biblioteca de Supabase no encontrada');
                    return;
                }

                // Use the products client from storeService.js
                window.supabaseClient = window.productsClient;

                // Initialize product manager
                window.productManager = {
                    async getAllProducts() {
                        try {
                            const { data, error } = await window.supabaseClient
                                .from('current_products')
                                .select('*')
                                .order('name');

                            if (error) throw error;
                            return data || [];
                        } catch (error) {
                            console.error('Error getting products:', error);
                            return [];
                        }
                    },

                    async updateProductPrice(productId, newPrice, reason) {
                        try {
                            const { error } = await window.supabaseClient
                                .from('current_products')
                                .update({
                                    price_per_kg: newPrice,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', productId);

                            if (error) throw error;

                            // Log price change
                            await this.logPriceChange(productId, newPrice, reason);
                            return { success: true };
                        } catch (error) {
                            console.error('Error updating price:', error);
                            return { success: false, error: error.message };
                        }
                    },

                    async updateProductStock(productId, stockChange, reason) {
                        try {
                            // Get current stock
                            const { data: currentProduct, error: fetchError } = await window.supabaseClient
                                .from('current_products')
                                .select('stock_kg')
                                .eq('id', productId)
                                .single();

                            if (fetchError) throw fetchError;

                            const newStock = Math.max(0, (currentProduct.stock_kg || 0) + stockChange);

                            const { error } = await window.supabaseClient
                                .from('current_products')
                                .update({
                                    stock_kg: newStock,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', productId);

                            if (error) throw error;

                            // Log stock change
                            await this.logStockChange(productId, stockChange, reason);
                            return { success: true };
                        } catch (error) {
                            console.error('Error updating stock:', error);
                            return { success: false, error: error.message };
                        }
                    },

                    async logPriceChange(productId, newPrice, reason) {
                        try {
                            const { error } = await window.supabaseClient
                                .from('price_history')
                                .insert({
                                    product_id: productId,
                                    new_price: newPrice,
                                    reason: reason,
                                    changed_by: 'admin',
                                    created_at: new Date().toISOString()
                                });

                            if (error) throw error;
                        } catch (error) {
                            console.error('Error logging price change:', error);
                        }
                    },

                    async logStockChange(productId, stockChange, reason) {
                        try {
                            const { error } = await window.supabaseClient
                                .from('stock_history')
                                .insert({
                                    product_id: productId,
                                    stock_change: stockChange,
                                    reason: reason,
                                    changed_by: 'admin',
                                    created_at: new Date().toISOString()
                                });

                            if (error) throw error;
                        } catch (error) {
                            console.error('Error logging stock change:', error);
                        }
                    },

                    async getInventoryReport() {
                        try {
                            const products = await this.getAllProducts();

                            // Calculate categories
                            const categories = {};
                            let totalValue = 0;

                            products.forEach(product => {
                                if (!categories[product.category]) {
                                    categories[product.category] = {
                                        count: 0,
                                        totalValue: 0
                                    };
                                }
                                categories[product.category].count++;
                                const value = (product.stock_kg || 0) * (product.price_per_kg || 0);
                                categories[product.category].totalValue += value;
                                totalValue += value;
                            });

                            return {
                                products,
                                categories,
                                totalValue
                            };
                        } catch (error) {
                            console.error('Error getting inventory report:', error);
                            return { products: [], categories: {}, totalValue: 0 };
                        }
                    }
                };

                updateConnectionStatus(true, 'Conectado a Supabase exitosamente');
                console.log('‚úÖ Supabase initialized successfully');

            } catch (error) {
                console.error('‚ùå Error initializing Supabase:', error);
                updateConnectionStatus(false, 'Error conectando a Supabase: ' + error.message);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected, message) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                showLoading('Cargando productos...');

                // Initialize Supabase if not done yet
                if (!window.supabaseClient) {
                    await init();
                }

                // Wait for productManager to be available
                if (!window.productManager) {
                    console.warn('‚ö†Ô∏è ProductManager not available, waiting...');
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (!window.productManager) {
                        throw new Error('ProductManager no se inicializ√≥ correctamente');
                    }
                }

                // Load products
                allProducts = await window.productManager.getAllProducts();

                // Populate select elements
                populateProductSelects();

                // Render products table
                renderProductsTable();

                console.log('‚úÖ Initial data loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error);
                showError('Error cargando datos iniciales', error.message);
            } finally {
                hideLoading();
            }
        }

        // Populate product select elements
        function populateProductSelects() {
            const selects = ['priceProductSelect', 'stockProductSelect', 'manageProductSelect'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except first
                    select.innerHTML = '<option value="">Seleccionar producto...</option>';

                    // Add products
                    allProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.category}) - $${product.price_per_kg?.toLocaleString('es-CO')}/kg`;
                        select.appendChild(option);
                    });
                }
            });

            // Also populate category filter
            const categoryFilter = document.getElementById('filterCategory');
            const categorySelect = document.getElementById('categorySelect');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
                const categories = [...new Set(allProducts.map(p => p.category))].sort();
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
            }
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Todas las categor√≠as</option>';
                const categories = [...new Set(allProducts.map(p => p.category))].sort();
                categories.forEach(category => {
                    categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                });
            }
        }

        // Render products table
        function renderProductsTable(products = allProducts) {
            const container = document.getElementById('productsTableBody');
            const countElement = document.getElementById('productsCount');

            if (!container) return;

            if (!products || products.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-info-circle"></i> No hay productos para mostrar
                        </td>
                    </tr>
                `;
                if (countElement) countElement.textContent = '0 productos';
                return;
            }

            let html = '';
            products.forEach(product => {
                const stockStatus = product.stock_kg <= product.min_stock_kg ? 'low-stock' :
                                  product.stock_kg === 0 ? 'out-of-stock' : 'in-stock';
                const statusBadge = product.available ?
                    '<span class="status-badge active">Activo</span>' :
                    '<span class="status-badge inactive">Inactivo</span>';
                const lastUpdate = product.updated_at ?
                    new Date(product.updated_at).toLocaleDateString('es-CO') : 'Nunca';

                html += `
                    <tr class="${stockStatus}">
                        <td style="font-family: monospace; font-size: 0.85em;">${product.id}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="${product.image_url || '/images/products/placeholder.jpg'}"
                                     alt="${product.name}"
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
                                <div>
                                    <strong>${escapeHtml(product.name)}</strong>
                                    ${product.organic ? '<span class="badge organic" style="font-size: 0.7em;">üå± Org√°nico</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td>${escapeHtml(product.category)}</td>
                        <td><strong>${formatPrice(product.price_per_kg)}</strong></td>
                        <td>${formatPrice(product.cost_per_kg || 0)}</td>
                        <td>
                            <span class="stock-indicator ${stockStatus}">
                                ${formatNumber(product.stock_kg || 0)}kg
                                ${product.stock_kg <= product.min_stock_kg ?
                                    `<br><small style="color: #ff6b6b;">M√≠n: ${product.min_stock_kg}kg</small>` : ''}
                            </span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${escapeHtml(product.supplier || '-')}</td>
                        <td>${lastUpdate}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-info" onclick="quickEditProduct('${product.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="duplicateProduct('${product.id}')" title="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-sm ${product.available ? 'btn-secondary' : 'btn-success'}"
                                        onclick="toggleProductStatus('${product.id}')" title="Cambiar estado">
                                    <i class="fas fa-toggle-${product.available ? 'off' : 'on'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}', '${escapeHtml(product.name).replace(/'/g, "\\'")}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
            if (countElement) countElement.textContent = `${products.length} producto${products.length !== 1 ? 's' : ''}`;
        }

        // Filter products table
        function filterProductsTable() {
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filtered = allProducts.filter(product => {
                const matchesSearch = !searchTerm ||
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    (product.supplier && product.supplier.toLowerCase().includes(searchTerm));

                const matchesCategory = !categoryFilter || product.category === categoryFilter;

                let matchesStatus = true;
                if (statusFilter) {
                    switch (statusFilter) {
                        case 'active':
                            matchesStatus = product.available;
                            break;
                        case 'inactive':
                            matchesStatus = !product.available;
                            break;
                        case 'low_stock':
                            matchesStatus = product.stock_kg <= product.min_stock_kg;
                            break;
                    }
                }

                return matchesSearch && matchesCategory && matchesStatus;
            });

            renderProductsTable(filtered);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchProducts').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            renderProductsTable();
        }

        // Refresh products table
        function refreshProductsTable() {
            loadInitialData();
        }

        // Quick edit product (opens edit modal)
        function quickEditProduct(productId) {
            editSelectedProduct(productId);
        }

        // Duplicate product
        async function duplicateProduct(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showError('Producto no encontrado', 'El producto a duplicar no existe');
                return;
            }

            if (!confirm(`¬øDeseas crear una copia de "${product.name}"?`)) {
                return;
            }

            try {
                showLoading('Duplicando producto...');

                const duplicatedProduct = {
                    ...product,
                    name: `${product.name} (Copia)`,
                    id: undefined,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                delete duplicatedProduct.id;

                const { data, error } = await window.supabaseClient
                    .from('current_products')
                    .insert(duplicatedProduct)
                    .select()
                    .single();

                if (error) throw error;

                showSuccess('Producto duplicado', `"${product.name}" ha sido duplicado exitosamente`);
                await loadInitialData();

            } catch (error) {
                console.error('Error duplicating product:', error);
                showError('Error al duplicar', error.message);
            } finally {
                hideLoading();
            }
        }

        // Toggle product status
        async function toggleProductStatus(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showError('Producto no encontrado', 'El producto no existe');
                return;
            }

            const newStatus = !product.available;
            const statusText = newStatus ? 'activar' : 'desactivar';

            if (!confirm(`¬øEst√°s seguro de que quieres ${statusText} "${product.name}"?`)) {
                return;
            }

            try {
                showLoading(`${statusText === 'activar' ? 'Activando' : 'Desactivando'} producto...`);

                const { error } = await window.supabaseClient
                    .from('current_products')
                    .update({
                        available: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showSuccess(`Estado actualizado`, `"${product.name}" ha sido ${statusText === 'activar' ? 'activado' : 'desactivado'}`);
                await loadInitialData();

            } catch (error) {
                console.error('Error toggling product status:', error);
                showError('Error al cambiar estado', error.message);
            } finally {
                hideLoading();
            }
        }

        // Edit selected product (with specific ID)
        function editSelectedProduct(productId = null) {
            const selectedId = productId || document.getElementById('manageProductSelect').value;
            if (!selectedId) {
                showWarning('Producto requerido', 'Por favor selecciona un producto para editar');
                return;
            }

            const product = allProducts.find(p => p.id == selectedId);
            if (!product) {
                showWarning('Producto no encontrado', 'El producto seleccionado no existe');
                return;
            }

            // Pre-fill the modal with current product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price_per_kg;
            document.getElementById('productCost').value = product.cost_per_kg || '';
            document.getElementById('productStock').value = product.stock_kg || '';
            document.getElementById('productMinStock').value = product.min_stock_kg || '';
            document.getElementById('productOrigin').value = product.origin || 'Colombia';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productRating').value = product.rating || '4';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImageName').value = product.image_url ? product.image_url.split('/').pop().split('.')[0] : '';
            document.getElementById('productImageFormat').value = product.image_url ? product.image_url.split('.').pop() : 'jpg';
            document.getElementById('productOrganic').checked = product.organic || false;
            document.getElementById('productActive').checked = product.available;

            // Change modal title and button
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';

            // Store the product ID for updating
            document.getElementById('addProductForm').dataset.editingId = selectedId;

            showAddProductModal();
        }

        // Show loading indicator
        function showLoading(message = 'Cargando...') {
            const existing = document.querySelector('.loading');
            if (existing) existing.remove();

            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            document.querySelector('.admin-main').prepend(loading);
        }

        // Hide loading indicator
        function hideLoading() {
            const loading = document.querySelector('.loading');
            if (loading) loading.remove();
        }

        // Show success message
        function showSuccess(title, message) {
            showNotification(title, message, 'success');
        }

        // Show error message
        function showError(title, message) {
            showNotification(title, message, 'error');
        }

        // Show warning message
        function showWarning(title, message) {
            showNotification(title, message, 'warning');
        }

        // Show info message
        function showInfo(title, message) {
            showNotification(title, message, 'info');
        }

        // Show notification
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');

            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;

            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${getNotificationIcon(type)} notification-icon"></i>
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => notification.remove(), 400);
            }, 5000);
        }

        // Get notification icon based on type
        function getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-triangle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Show alert (legacy function for compatibility)
        function showAlert(message, type = 'info') {
            showNotification('Notificaci√≥n', message, type);
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(price);
        }

        // Format number
        function formatNumber(value) {
            const numeric = Number.isFinite(value) ? value : Number(value) || 0;
            return new Intl.NumberFormat('es-CO', {
                maximumFractionDigits: 0
            }).format(numeric);
        }

        // Update single product price
        window.updateSinglePrice = async function() {
            const productId = document.getElementById('priceProductSelect').value;
            const newPrice = parseFloat(document.getElementById('newPrice').value);
            const reason = document.getElementById('priceReason').value.trim();

            if (!productId) {
                showWarning('Producto requerido', 'Por favor selecciona un producto');
                return;
            }

            if (!newPrice || newPrice <= 0) {
                showWarning('Precio inv√°lido', 'Ingresa un precio v√°lido mayor a 0');
                return;
            }

            if (!reason) {
                showWarning('Raz√≥n requerida', 'Ingresa una raz√≥n para el cambio de precio');
                return;
            }

            try {
                showLoading('Actualizando precio...');

                const result = await window.productManager.updateProductPrice(productId, newPrice, reason);

                if (result.success) {
                    const product = allProducts.find(p => p.id == productId);
                    showSuccess(
                        'üí∞ Precio actualizado exitosamente',
                        `El precio de "${product.name}" se cambi√≥ a ${formatPrice(newPrice)} por kg`
                    );

                    // Clear form
                    document.getElementById('priceProductSelect').value = '';
                    document.getElementById('newPrice').value = '';
                    document.getElementById('priceReason').value = '';

                    // Refresh data
                    await loadInitialData();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error updating price:', error);
                showError('‚ùå Error actualizando precio', error.message);
            } finally {
                hideLoading();
            }
        };

        // Apply bulk price increase
        window.applyBulkIncrease = async function() {
            const category = document.getElementById('categorySelect').value;
            const percent = parseFloat(document.getElementById('increasePercent').value);

            if (!percent || percent <= 0) {
                showWarning('Porcentaje inv√°lido', 'Ingresa un porcentaje v√°lido mayor a 0');
                return;
            }

            if (percent > 50) {
                if (!confirm(`¬øEst√°s seguro de aumentar los precios en un ${percent}%? Este es un cambio muy grande.`)) {
                    return;
                }
            }

            try {
                showLoading(`Aplicando aumento del ${percent}%...`);

                let productsToUpdate;
                if (category) {
                    productsToUpdate = allProducts.filter(p => p.category === category);
                } else {
                    productsToUpdate = allProducts;
                }

                if (productsToUpdate.length === 0) {
                    showWarning('Sin productos', 'No hay productos en la categor√≠a seleccionada');
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                for (const product of productsToUpdate) {
                    const newPrice = product.price_per_kg * (1 + percent / 100);
                    const result = await window.productManager.updateProductPrice(
                        product.id,
                        Math.round(newPrice),
                        `Aumento masivo del ${percent}% en categor√≠a ${category || 'todas'}`
                    );

                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(
                        'üìà Aumento masivo aplicado',
                        `Se actualizaron ${successCount} productos${errorCount > 0 ? ` (${errorCount} errores)` : ''}`
                    );

                    // Clear form
                    document.getElementById('categorySelect').value = '';
                    document.getElementById('increasePercent').value = '';

                    // Refresh data
                    await loadInitialData();
                } else {
                    throw new Error('No se pudo actualizar ning√∫n producto');
                }
            } catch (error) {
                console.error('Error applying bulk increase:', error);
                showError('‚ùå Error aplicando aumento', error.message);
            } finally {
                hideLoading();
            }
        };

        // Update product stock
        window.updateStock = async function() {
            const productId = document.getElementById('stockProductSelect').value;
            const stockChange = parseFloat(document.getElementById('stockChange').value);
            const reason = document.getElementById('stockReason').value.trim();

            if (!productId) {
                showWarning('Producto requerido', 'Por favor selecciona un producto');
                return;
            }

            if (!stockChange) {
                showWarning('Cambio requerido', 'Ingresa un cambio en el stock');
                return;
            }

            if (!reason) {
                showWarning('Raz√≥n requerida', 'Ingresa una raz√≥n para el cambio de stock');
                return;
            }

            try {
                showLoading('Actualizando stock...');

                const result = await window.productManager.updateProductStock(productId, stockChange, reason);

                if (result.success) {
                    const product = allProducts.find(p => p.id == productId);
                    const action = stockChange > 0 ? 'agregado' : 'removido';
                    showSuccess(
                        'üì¶ Stock actualizado exitosamente',
                        `Se ${action} ${Math.abs(stockChange)}kg a "${product.name}"`
                    );

                    // Clear form
                    document.getElementById('stockProductSelect').value = '';
                    document.getElementById('stockChange').value = '';
                    document.getElementById('stockReason').value = '';

                    // Refresh data
                    await loadInitialData();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showError('‚ùå Error actualizando stock', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show low stock products
        window.showLowStock = async function() {
            try {
                showLoading('Buscando productos con stock bajo...');

                const lowStockProducts = allProducts.filter(product => {
                    const stock = product.stock_kg || 0;
                    const minStock = product.min_stock_kg || 0;
                    return stock <= minStock && stock > 0;
                });

                if (lowStockProducts.length === 0) {
                    showInfo('‚úÖ Sin productos con stock bajo', 'Todos los productos tienen stock suficiente');
                    return;
                }

                let message = `Se encontraron ${lowStockProducts.length} productos con stock bajo:\n\n`;
                lowStockProducts.forEach(product => {
                    message += `‚Ä¢ ${product.name}: ${product.stock_kg || 0}kg (m√≠nimo: ${product.min_stock_kg || 0}kg)\n`;
                });

                showWarning('‚ö†Ô∏è Productos con stock bajo', message);
            } catch (error) {
                console.error('Error checking low stock:', error);
                showError('‚ùå Error verificando stock bajo', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show all products
        window.showAllProducts = async function() {
            try {
                showLoading('Generando lista de productos...');

                if (allProducts.length === 0) {
                    showInfo('Sin productos', 'No hay productos registrados');
                    return;
                }

                let message = `üìã Lista completa de productos (${allProducts.length}):\n\n`;
                allProducts.forEach(product => {
                    const status = product.available ? '‚úÖ' : '‚ùå';
                    message += `${status} ${product.name} (${product.category})\n`;
                    message += `   Precio: ${formatPrice(product.price_per_kg)}/kg\n`;
                    message += `   Stock: ${product.stock_kg || 0}kg\n\n`;
                });

                showInfo('üìã Lista de Productos', message);
            } catch (error) {
                console.error('Error showing products:', error);
                showError('‚ùå Error mostrando productos', error.message);
            } finally {
                hideLoading();
            }
        };

        // View price history
        window.viewPriceHistory = async function() {
            try {
                showLoading('Cargando historial de precios...');

                const { data, error } = await window.supabaseClient
                    .from('price_history')
                    .select(`
                        *,
                        current_products (name, category)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                if (!data || data.length === 0) {
                    showInfo('Sin historial', 'No hay cambios de precio registrados');
                    return;
                }

                let message = `üìä √öltimos ${data.length} cambios de precio:\n\n`;
                data.forEach(entry => {
                    const date = new Date(entry.created_at).toLocaleString('es-CO');
                    const productName = entry.current_products?.name || 'Producto desconocido';
                    message += `${date}: ${productName}\n`;
                    message += `   Nuevo precio: ${formatPrice(entry.new_price)}\n`;
                    message += `   Raz√≥n: ${entry.reason}\n\n`;
                });

                showInfo('üìà Historial de Precios', message);
            } catch (error) {
                console.error('Error loading price history:', error);
                showError('‚ùå Error cargando historial', error.message);
            } finally {
                hideLoading();
            }
        };

        // Load inventory report
        window.loadInventoryReport = async function() {
            try {
                showLoading('Generando reporte de inventario...');

                const { products, categories, totalValue } = await window.productManager.getInventoryReport();

                let report = `üìä REPORTE DE INVENTARIO - FRUVI STORE\n`;
                report += `Fecha: ${new Date().toLocaleString('es-CO')}\n\n`;

                report += `üí∞ VALOR TOTAL DEL INVENTARIO: ${formatPrice(totalValue)}\n\n`;

                report += `üì¶ PRODUCTOS POR CATEGOR√çA:\n`;
                Object.entries(categories).forEach(([category, data]) => {
                    report += `‚Ä¢ ${category}: ${data.count} productos, valor: ${formatPrice(data.totalValue)}\n`;
                });

                report += `\nüìã DETALLE DE PRODUCTOS:\n`;
                products.forEach(product => {
                    const status = product.available ? '‚úÖ' : '‚ùå';
                    report += `${status} ${product.name}\n`;
                    report += `   Categor√≠a: ${product.category}\n`;
                    report += `   Precio: ${formatPrice(product.price_per_kg)}/kg\n`;
                    report += `   Stock: ${product.stock_kg || 0}kg\n`;
                    report += `   Valor inventario: ${formatPrice((product.stock_kg || 0) * (product.price_per_kg || 0))}\n\n`;
                });

                // Show in report container
                document.getElementById('reportContainer').innerHTML = `
                    <div style="background: var(--surface); padding: 1.5rem; border-radius: 12px; font-family: monospace; white-space: pre-line; max-height: 400px; overflow-y: auto;">
                        ${report.replace(/\n/g, '<br>')}
                    </div>
                `;

                showSuccess('üìä Reporte generado', 'El reporte de inventario se muestra abajo');
            } catch (error) {
                console.error('Error generating inventory report:', error);
                showError('‚ùå Error generando reporte', error.message);
            } finally {
                hideLoading();
            }
        };

        // Load daily report
        window.loadDailyReport = async function() {
            try {
                showLoading('Generando reporte diario...');

                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);

                // Get price changes for today
                const { data: priceChanges, error: priceError } = await window.supabaseClient
                    .from('price_history')
                    .select(`
                        *,
                        current_products (name, category)
                    `)
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString());

                // Get stock changes for today
                const { data: stockChanges, error: stockError } = await window.supabaseClient
                    .from('stock_history')
                    .select(`
                        *,
                        current_products (name, category)
                    `)
                    .gte('created_at', startOfDay.toISOString())
                    .lte('created_at', endOfDay.toISOString());

                if (priceError) console.error('Error getting price changes:', priceError);
                if (stockError) console.error('Error getting stock changes:', stockError);

                let report = `üìÖ REPORTE DIARIO - ${today.toLocaleDateString('es-CO')}\n\n`;

                report += `üí∞ CAMBIOS DE PRECIO HOY: ${priceChanges?.length || 0}\n`;
                if (priceChanges && priceChanges.length > 0) {
                    priceChanges.forEach(change => {
                        const time = new Date(change.created_at).toLocaleTimeString('es-CO');
                        report += `‚Ä¢ ${time}: ${change.current_products?.name || 'Producto'} - ${formatPrice(change.new_price)}\n`;
                    });
                }
                report += '\n';

                report += `üì¶ CAMBIOS DE STOCK HOY: ${stockChanges?.length || 0}\n`;
                if (stockChanges && stockChanges.length > 0) {
                    stockChanges.forEach(change => {
                        const time = new Date(change.created_at).toLocaleTimeString('es-CO');
                        const action = change.stock_change > 0 ? 'agregado' : 'removido';
                        report += `‚Ä¢ ${time}: ${change.current_products?.name || 'Producto'} - ${action} ${Math.abs(change.stock_change)}kg\n`;
                    });
                }

                // Show in report container
                document.getElementById('reportContainer').innerHTML = `
                    <div style="background: var(--surface); padding: 1.5rem; border-radius: 12px; font-family: monospace; white-space: pre-line; max-height: 400px; overflow-y: auto;">
                        ${report.replace(/\n/g, '<br>')}
                    </div>
                `;

                showSuccess('üìÖ Reporte diario generado', 'El reporte del d√≠a se muestra abajo');
            } catch (error) {
                console.error('Error generating daily report:', error);
                showError('‚ùå Error generando reporte diario', error.message);
            } finally {
                hideLoading();
            }
        };

        // Export data
        window.exportData = async function() {
            try {
                showLoading('Exportando datos...');

                const products = allProducts;
                const csvContent = generateProductsCSV(products);

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `productos_fruvi_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSuccess('üìä Datos exportados', `Se descarg√≥ un archivo CSV con ${products.length} productos`);
            } catch (error) {
                console.error('Error exporting data:', error);
                showError('‚ùå Error exportando datos', error.message);
            } finally {
                hideLoading();
            }
        };

        // Generate products CSV
        function generateProductsCSV(products) {
            const headers = [
                'ID', 'Nombre', 'Categor√≠a', 'Precio (COP/kg)', 'Costo (COP/kg)',
                'Stock (kg)', 'Stock M√≠nimo (kg)', 'Org√°nico', 'Calificaci√≥n',
                'Origen', 'Activo'
            ];

            const rows = products.map(product => [
                product.id,
                `"${product.name}"`,
                `"${product.category}"`,
                product.price_per_kg,
                product.cost_per_kg || 0,
                product.stock_kg || 0,
                product.min_stock_kg || 0,
                product.organic ? 'S√≠' : 'No',
                product.rating || 4.0,
                `"${product.origin || 'Colombia'}"`,
                product.available ? 'S√≠' : 'No'
            ]);

            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        // Import prices from CSV
        window.importPricesFromCSV = async function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                showWarning('Archivo requerido', 'Por favor selecciona un archivo CSV');
                return;
            }

            try {
                showLoading('Importando precios desde CSV...');

                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    throw new Error('El archivo CSV debe tener al menos una fila de datos');
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = ['product_id', 'new_price', 'reason'];

                // Check if headers match expected format
                const headersMatch = expectedHeaders.every(header =>
                    headers.some(h => h.toLowerCase().includes(header.toLowerCase()))
                );

                if (!headersMatch) {
                    throw new Error('El formato del CSV no es v√°lido. Se espera: product_id, new_price, reason');
                }

                let successCount = 0;
                let errorCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));

                    if (values.length < 3) {
                        errorCount++;
                        continue;
                    }

                    const productId = values[0];
                    const newPrice = parseFloat(values[1]);
                    const reason = values[2];

                    if (!productId || !newPrice || isNaN(newPrice)) {
                        errorCount++;
                        continue;
                    }

                    const result = await window.productManager.updateProductPrice(productId, newPrice, reason);
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(
                        'üìä Importaci√≥n completada',
                        `Se importaron ${successCount} precios${errorCount > 0 ? ` (${errorCount} errores)` : ''}`
                    );

                    // Clear file input
                    fileInput.value = '';

                    // Refresh data
                    await loadInitialData();
                } else {
                    throw new Error('No se pudo importar ning√∫n precio');
                }
            } catch (error) {
                console.error('Error importing CSV:', error);
                showError('‚ùå Error importando CSV', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show add product modal
        window.showAddProductModal = function() {
            document.getElementById('addProductModal').classList.remove('hidden');
        };

        // Close add product modal
        window.closeAddProductModal = function() {
            document.getElementById('addProductModal').classList.add('hidden');
            document.getElementById('addProductForm').reset();
            // Reset modal title and button
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Nuevo Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-plus"></i> Crear Producto';
            // Clear editing ID
            delete document.getElementById('addProductForm').dataset.editingId;
        };

        // Show categories modal
        window.showCategoriesModal = function() {
            showModal(`
                <h3><i class="fas fa-tags"></i> Gesti√≥n de Categor√≠as</h3>
                <div style="margin-top: 1rem;">
                    <p>Esta funci√≥n permite gestionar las categor√≠as de productos disponibles en la tienda.</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <strong>Categor√≠as actuales:</strong>
                        <ul style="margin-top: 0.5rem;">
                            <li>Bayas</li>
                            <li>Bananos</li>
                            <li>C√≠tricas</li>
                            <li>Ex√≥ticas</li>
                            <li>Frutas Dulces</li>
                            <li>Tropicales</li>
                            <li>Uvas</li>
                        </ul>
                    </div>
                    <p style="color: #666; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> Para agregar nuevas categor√≠as, contacta al desarrollador del sistema.
                    </p>
                </div>
            `);
        };

        // Show suppliers modal
        window.showSuppliersModal = function() {
            showModal(`
                <h3><i class="fas fa-truck"></i> Gesti√≥n de Proveedores</h3>
                <div style="margin-top: 1rem;">
                    <p>Esta funci√≥n permite gestionar los proveedores de productos.</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <strong>Proveedores registrados:</strong>
                        <div id="suppliersList" style="margin-top: 0.5rem;">
                            Cargando proveedores...
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="showAddSupplierModal()">
                        <i class="fas fa-plus"></i> Agregar Proveedor
                    </button>
                </div>
            `);
            loadSuppliersList();
        };

        // Load suppliers list
        async function loadSuppliersList() {
            try {
                const suppliers = [...new Set(allProducts.map(p => p.supplier).filter(s => s))];
                const suppliersList = document.getElementById('suppliersList');

                if (suppliers.length === 0) {
                    suppliersList.innerHTML = '<p style="color: #666;">No hay proveedores registrados</p>';
                    return;
                }

                suppliersList.innerHTML = '<ul style="margin: 0; padding-left: 1rem;">' +
                    suppliers.map(supplier => `<li>${escapeHtml(supplier)}</li>`).join('') +
                    '</ul>';
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        };

        // Show add supplier modal
        window.showAddSupplierModal = function() {
            const supplierName = prompt('Nombre del nuevo proveedor:');
            if (supplierName && supplierName.trim()) {
                showInfo('Proveedor agregado', `El proveedor "${supplierName.trim()}" ha sido registrado en el sistema.`);
            }
        };

        // Show bulk actions modal
        window.showBulkActionsModal = function() {
            showModal(`
                <h3><i class="fas fa-tasks"></i> Acciones Masivas</h3>
                <div style="margin-top: 1rem;">
                    <div style="display: grid; gap: 1rem;">
                        <div class="admin-card" style="margin: 0;">
                            <h4><i class="fas fa-percentage"></i> Aumento Masivo de Precios</h4>
                                <label for="bulkCategory">Categor√≠a:</label>
                                <select id="bulkCategory">
                                    <option value="">Todas las categor√≠as</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="bulkPercent">Porcentaje de aumento:</label>
                                <input type="number" id="bulkPercent" step="0.1" min="0" max="100" placeholder="5.0">
                            </div>
                            <button class="btn btn-success" onclick="applyBulkPriceIncrease()">
                                <i class="fas fa-arrow-up"></i> Aplicar Aumento
                            </button>
                        </div>

                        <div class="admin-card" style="margin: 0;">
                            <h4><i class="fas fa-toggle-on"></i> Cambiar Estado Masivo</h4>
                            <div class="input-group">
                                <label for="bulkStatusCategory">Categor√≠a:</label>
                                <select id="bulkStatusCategory">
                                    <option value="">Todas las categor√≠as</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="bulkNewStatus">Nuevo estado:</label>
                                <select id="bulkNewStatus">
                                    <option value="active">Activar productos</option>
                                    <option value="inactive">Desactivar productos</option>
                                </select>
                            </div>
                            <button class="btn btn-warning" onclick="applyBulkStatusChange()">
                                <i class="fas fa-toggle-on"></i> Cambiar Estado
                            </button>
                        </div>

                        <div class="admin-card" style="margin: 0;">
                            <h4><i class="fas fa-trash"></i> Eliminaci√≥n Masiva</h4>
                            <p style="color: #dc3545; font-size: 0.9rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                                Esta acci√≥n eliminar√° permanentemente los productos seleccionados.
                            </p>
                            <button class="btn btn-danger" onclick="showBulkDeleteModal()">
                                <i class="fas fa-trash"></i> Eliminar M√∫ltiples Productos
                            </button>
                        </div>
                    </div>
                </div>
            `);

            // Populate category selects
            const categories = [...new Set(allProducts.map(p => p.category))].sort();
            ['bulkCategory', 'bulkStatusCategory'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Todas las categor√≠as</option>';
                    categories.forEach(category => {
                        select.innerHTML += `<option value="${category}">${category}</option>`;
                    });
                }
            });
        };

        // Apply bulk price increase
        window.applyBulkPriceIncrease = async function() {
            const category = document.getElementById('bulkCategory').value;
            const percent = parseFloat(document.getElementById('bulkPercent').value);

            if (!percent || percent <= 0) {
                showWarning('Porcentaje inv√°lido', 'Ingresa un porcentaje v√°lido mayor a 0');
                return;
            }

            if (percent > 50) {
                if (!confirm(`¬øEst√°s seguro de aumentar los precios en un ${percent}%? Este es un cambio muy grande.`)) {
                    return;
                }
            }

            try {
                showLoading(`Aplicando aumento del ${percent}%...`);

                let productsToUpdate;
                if (category) {
                    productsToUpdate = allProducts.filter(p => p.category === category);
                } else {
                    productsToUpdate = allProducts;
                }

                if (productsToUpdate.length === 0) {
                    showWarning('Sin productos', 'No hay productos en la categor√≠a seleccionada');
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                for (const product of productsToUpdate) {
                    const newPrice = product.price_per_kg * (1 + percent / 100);
                    const result = await window.productManager.updateProductPrice(
                        product.id,
                        Math.round(newPrice),
                        `Aumento masivo del ${percent}% en categor√≠a ${category || 'todas'}`
                    );

                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(
                        'üìà Aumento masivo aplicado',
                        `Se actualizaron ${successCount} productos${errorCount > 0 ? ` (${errorCount} errores)` : ''}`
                    );
                    closeModal();
                    await loadInitialData();
                } else {
                    throw new Error('No se pudo actualizar ning√∫n producto');
                }
            } catch (error) {
                console.error('Error applying bulk increase:', error);
                showError('‚ùå Error aplicando aumento', error.message);
            } finally {
                hideLoading();
            }
        };

        // Apply bulk status change
        window.applyBulkStatusChange = async function() {
            const category = document.getElementById('bulkStatusCategory').value;
            const newStatus = document.getElementById('bulkNewStatus').value;

            if (!newStatus) {
                showWarning('Estado requerido', 'Selecciona un nuevo estado');
                return;
            }

            const isActive = newStatus === 'active';
            const statusText = isActive ? 'activar' : 'desactivar';

            let productsToUpdate;
            if (category) {
                productsToUpdate = allProducts.filter(p => p.category === category);
            } else {
                productsToUpdate = allProducts;
            }

            if (productsToUpdate.length === 0) {
                showWarning('Sin productos', 'No hay productos en la categor√≠a seleccionada');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de ${statusText} ${productsToUpdate.length} productos${category ? ` en la categor√≠a "${category}"` : ''}?`)) {
                return;
            }

            try {
                showLoading(`${statusText === 'activar' ? 'Activando' : 'Desactivando'} productos...`);

                let successCount = 0;
                let errorCount = 0;

                for (const product of productsToUpdate) {
                    const { error } = await window.supabaseClient
                        .from('current_products')
                        .update({
                            available: isActive,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', product.id);

                    if (!error) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(
                        `Estado actualizado`,
                        `Se ${statusText === 'activar' ? 'activaron' : 'desactivaron'} ${successCount} productos${errorCount > 0 ? ` (${errorCount} errores)` : ''}`
                    );
                    closeModal();
                    await loadInitialData();
                } else {
                    throw new Error('No se pudo actualizar ning√∫n producto');
                }
            } catch (error) {
                console.error('Error applying bulk status change:', error);
                showError('‚ùå Error cambiando estado', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show bulk delete modal
        window.showBulkDeleteModal = function() {
            const categories = [...new Set(allProducts.map(p => p.category))].sort();

            showModal(`
                <h3><i class="fas fa-trash"></i> Eliminaci√≥n Masiva de Productos</h3>
                <div style="margin-top: 1rem;">
                    <div style="background: #ffe6e6; border: 1px solid #ffcccc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #dc3545;">
                            <i class="fas fa-exclamation-triangle"></i> ADVERTENCIA
                        </strong>
                        <p style="margin: 0.5rem 0 0 0; color: #721c24;">
                            Esta acci√≥n eliminar√° permanentemente los productos seleccionados de la base de datos.
                            No se puede deshacer.
                        </p>
                    </div>

                    <div class="input-group">
                        <label for="deleteCategory">Eliminar productos de categor√≠a:</label>
                        <select id="deleteCategory">
                            <option value="">Seleccionar categor√≠a...</option>
                            ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="deleteConfirm">Escribe "ELIMINAR" para confirmar:</label>
                        <input type="text" id="deleteConfirm" placeholder="ELIMINAR">
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button class="btn btn-danger" onclick="executeBulkDelete()">
                            <i class="fas fa-trash"></i> Eliminar Productos
                        </button>
                    </div>
                </div>
            `);
        };

        // Execute bulk delete
        window.executeBulkDelete = async function() {
            const category = document.getElementById('deleteCategory').value;
            const confirmation = document.getElementById('deleteConfirm').value;

            if (!category) {
                showWarning('Categor√≠a requerida', 'Selecciona una categor√≠a para eliminar');
                return;
            }

            if (confirmation !== 'ELIMINAR') {
                showWarning('Confirmaci√≥n requerida', 'Escribe "ELIMINAR" para confirmar la acci√≥n');
                return;
            }

            const productsToDelete = allProducts.filter(p => p.category === category);

            if (productsToDelete.length === 0) {
                showWarning('Sin productos', 'No hay productos en la categor√≠a seleccionada');
                return;
            }

            if (!confirm(`¬øEst√°s ABSOLUTAMENTE seguro de eliminar ${productsToDelete.length} productos de la categor√≠a "${category}"?\n\nEsta acci√≥n NO SE PUEDE DESHACER.`)) {
                return;
            }

            try {
                showLoading('Eliminando productos...');

                let successCount = 0;
                let errorCount = 0;

                for (const product of productsToDelete) {
                    const { error } = await window.supabaseClient
                        .from('current_products')
                        .delete()
                        .eq('id', product.id);

                    if (!error) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showSuccess(
                        'Productos eliminados',
                        `Se eliminaron ${successCount} productos de la categor√≠a "${category}"${errorCount > 0 ? ` (${errorCount} errores)` : ''}`
                    );
                    closeModal();
                    await loadInitialData();
                } else {
                    throw new Error('No se pudo eliminar ning√∫n producto');
                }
            } catch (error) {
                console.error('Error bulk deleting products:', error);
                showError('‚ùå Error eliminando productos', error.message);
            } finally {
                hideLoading();
            }
        };

        // Create backup
        window.createBackup = async function() {
            try {
                showLoading('Creando respaldo...');

                const backupData = {
                    timestamp: new Date().toISOString(),
                    products: allProducts,
                    metadata: {
                        totalProducts: allProducts.length,
                        categories: [...new Set(allProducts.map(p => p.category))],
                        version: '1.0'
                    }
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_productos_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess('Respaldo creado', 'El archivo de respaldo se ha descargado exitosamente');
            } catch (error) {
                console.error('Error creating backup:', error);
                showError('Error creando respaldo', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show restore modal
        window.showRestoreModal = function() {
            showModal(`
                <h3><i class="fas fa-undo"></i> Restaurar desde Respaldo</h3>
                <div style="margin-top: 1rem;">
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #856404;">
                            <i class="fas fa-info-circle"></i> Informaci√≥n Importante
                        </strong>
                        <p style="margin: 0.5rem 0 0 0; color: #856404;">
                            La restauraci√≥n sobrescribir√° los datos actuales. Aseg√∫rate de tener un respaldo reciente.
                        </p>
                    </div>

                    <div class="input-group">
                        <label for="restoreFile">Seleccionar archivo de respaldo:</label>
                        <input type="file" id="restoreFile" accept=".json">
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button class="btn btn-warning" onclick="executeRestore()">
                            <i class="fas fa-upload"></i> Restaurar Datos
                        </button>
                    </div>
                </div>
            `);
        };

        // Execute restore
        window.executeRestore = async function() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];

            if (!file) {
                showWarning('Archivo requerido', 'Selecciona un archivo de respaldo');
                return;
            }

            if (!confirm('¬øEst√°s seguro de restaurar los datos? Esto sobrescribir√° la informaci√≥n actual.')) {
                return;
            }

            try {
                showLoading('Restaurando datos...');

                const text = await file.text();
                const backupData = JSON.parse(text);

                if (!backupData.products || !Array.isArray(backupData.products)) {
                    throw new Error('El archivo de respaldo no tiene un formato v√°lido');
                }

                // Clear current products
                const { error: deleteError } = await window.supabaseClient
                    .from('current_products')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all

                if (deleteError) throw deleteError;

                // Insert backup products
                const { error: insertError } = await window.supabaseClient
                    .from('current_products')
                    .insert(backupData.products);

                if (insertError) throw insertError;

                showSuccess('Restauraci√≥n completada', `Se restauraron ${backupData.products.length} productos`);
                closeModal();
                await loadInitialData();

            } catch (error) {
                console.error('Error restoring backup:', error);
                showError('Error restaurando respaldo', error.message);
            } finally {
                hideLoading();
            }
        };

        // Show modal function
        function showModal(content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            modal.innerHTML = `
                <div style="
                    background: var(--surface);
                    border: 1px solid var(--border);
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    color: var(--txt);
                    width: 90%;
                ">
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: var(--surface);
                        border: 1px solid var(--border);
                        font-size: 1.2rem;
                        cursor: pointer;
                        color: var(--txt);
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s ease;
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                    <div>${content}</div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Close modal function
        function closeModal() {
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => modal.remove());
        }

        // Setup form handlers
        function setupFormHandlers() {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleAddProduct();
                });
            }
        }

        // Handle add product
        async function handleAddProduct() {
            try {
                const form = document.getElementById('addProductForm');
                const formData = new FormData(form);

                const productData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    description: formData.get('description') || '',
                    price_per_kg: parseFloat(formData.get('price')),
                    cost_per_kg: parseFloat(formData.get('cost')) || 0,
                    stock_kg: parseFloat(formData.get('stock')) || 0,
                    min_stock_kg: parseFloat(formData.get('minStock')) || 0,
                    origin: formData.get('origin') || 'Colombia',
                    supplier: formData.get('supplier') || null,
                    rating: parseFloat(formData.get('rating')) || 4.0,
                    is_organic: formData.get('organic') === 'on',
                    is_active: formData.get('active') === 'on',
                    image_url: formData.get('imageName') ?
                        `public/images/products/${formData.get('imageName')}.${formData.get('imageFormat') || 'jpg'}` :
                        '/images/products/placeholder.jpg',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                showLoading('Creando producto...');

                const { data, error } = await window.supabaseClient
                    .from('current_products')
                    .insert(productData)
                    .select()
                    .single();

                if (error) throw error;

                showSuccess(
                    'üéâ Producto creado exitosamente',
                    `"${productData.name}" ha sido agregado al cat√°logo`
                );

                closeAddProductModal();
                await loadInitialData();

            } catch (error) {
                console.error('Error creating product:', error);
                showError('‚ùå Error creando producto', error.message);
            } finally {
                hideLoading();
            }
        }

        // Edit selected product
        window.editSelectedProduct = function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showWarning('Producto requerido', 'Por favor selecciona un producto para editar');
                return;
            }

            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showWarning('Producto no encontrado', 'El producto seleccionado no existe');
                return;
            }

            // Pre-fill the modal with current product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price_per_kg;
            document.getElementById('productCost').value = product.cost_per_kg || '';
            document.getElementById('productStock').value = product.stock_kg || '';
            document.getElementById('productMinStock').value = product.min_stock_kg || '';
            document.getElementById('productOrigin').value = product.origin || 'Colombia';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productRating').value = product.rating || '4';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImageName').value = product.image_url ? product.image_url.split('/').pop().split('.')[0] : '';
            document.getElementById('productImageFormat').value = product.image_url ? product.image_url.split('.').pop() : 'jpg';
            document.getElementById('productOrganic').checked = product.organic || false;
            document.getElementById('productActive').checked = product.available;

            // Change modal title and button
            document.querySelector('#addProductModal .modal-header h3').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
            document.querySelector('#addProductModal .btn-success').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';

            // Store the product ID for updating
            document.getElementById('addProductForm').dataset.editingId = productId;

            showAddProductModal();
        };

        // Delete selected product
        window.deleteSelectedProduct = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            if (!productId) {
                showWarning('Producto requerido', 'Por favor selecciona un producto para eliminar');
                return;
            }

            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showWarning('Producto no encontrado', 'El producto seleccionado no existe');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${product.name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                showLoading('Eliminando producto...');

                const { error } = await window.supabaseClient
                    .from('current_products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;

                showSuccess(
                    'üóëÔ∏è Producto eliminado',
                    `"${product.name}" ha sido removido del cat√°logo`
                );

                // Clear selection
                document.getElementById('manageProductSelect').value = '';

                // Refresh data
                await loadInitialData();

            } catch (error) {
                console.error('Error deleting product:', error);
                showError('‚ùå Error eliminando producto', error.message);
            } finally {
                hideLoading();
            }
        };

        // Update product status
        window.updateProductStatus = async function() {
            const productId = document.getElementById('manageProductSelect').value;
            const newStatus = document.getElementById('productStatus').value;

            if (!productId || !newStatus) {
                showWarning('Selecci√≥n requerida', 'Por favor selecciona un producto y un estado');
                return;
            }

            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showWarning('Producto no encontrado', 'El producto seleccionado no existe');
                return;
            }

            const isActive = newStatus === 'active';
            const statusText = isActive ? 'activar' : 'desactivar';

            if (!confirm(`¬øEst√°s seguro de que quieres ${statusText} "${product.name}"?`)) {
                return;
            }

            try {
                showLoading(`${statusText === 'activar' ? 'Activando' : 'Desactivando'} producto...`);

                const { error } = await window.supabaseClient
                    .from('current_products')
                    .update({
                        available: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);

                if (error) throw error;

                showSuccess(
                    `üìä Estado actualizado`,
                    `"${product.name}" ha sido ${statusText === 'activar' ? 'activado' : 'desactivado'} en el cat√°logo`
                );

                // Clear selections
                document.getElementById('manageProductSelect').value = '';
                document.getElementById('productStatus').value = '';

                // Refresh data
                await loadInitialData();

            } catch (error) {
                console.error('Error updating product status:', error);
                showError('‚ùå Error actualizando estado', error.message);
            } finally {
                hideLoading();
            }
        };

        // Initialize Supabase on page load
        window.addEventListener('load', async function() {
            if (!checkAuth()) return;

            // Initialize mobile menu
            initMobileMenu();

            // Setup form handlers
            setupFormHandlers();

            // Initialize Supabase and load data
            await init();

            // Load initial data immediately since storeService should be ready
            await loadInitialData();
        });
    </script>
</body>
</html>