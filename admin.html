<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Fruvi Store</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

</head>
<body class="admin-body is-hidden">
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-store"></i>
                        Panel de Administración - Fruvi Store
                    </h1>
                    <p>Gestión completa de productos, precios e inventario</p>
                </div>
                <div class="header-right">
                    <div class="user-info" id="userInfo">
                        <!-- Se llena dinámicamente con JavaScript -->
                    </div>
                    <button class="logout-btn" onclick="logout()" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
            <!-- Emergency close button -->
            <button onclick="closeModal()" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: #dc3545;
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
            " title="Cerrar cualquier modal abierto">
                <i class="fas fa-times"></i> Cerrar Modal
            </button>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Verificando conexión con Supabase...
        </div>



        <!-- Professional Dashboard Analytics -->
        <div class="dashboard-analytics">
            <!-- Main Stats Overview -->
            <div id="statsContainer" class="stats-grid">
                <!-- Stats will be populated here -->
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="charts-grid">
                    <!-- Categories Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Distribución por Categorías</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshCategoriesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoriesChart"></canvas>
                        </div>
                    </div>

                    <!-- Prices Trend Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Tendencia de Precios</h3>
                            <div class="chart-controls">
                                <select id="pricesPeriod" class="chart-select">
                                    <option value="week">Última Semana</option>
                                    <option value="month" selected>Último Mes</option>
                                    <option value="quarter">Último Trimestre</option>
                                </select>
                                <button class="btn-chart" onclick="refreshPricesChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="pricesChart"></canvas>
                        </div>
                    </div>

                    <!-- Stock Levels Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Niveles de Stock</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshStockChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-dollar-sign"></i> Valor de Inventario</h3>
                            <div class="chart-controls">
                                <button class="btn-chart" onclick="refreshRevenueChart()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Management Section -->
        <div class="product-management">
            <div class="management-header">
                <h2><i class="fas fa-cogs"></i> Gestión de Productos</h2>
                <div class="management-actions">
                    <button class="btn btn-success" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                    <button class="btn" onclick="showAllProducts()">
                        <i class="fas fa-list"></i> Ver Todos
                    </button>
                    <button class="btn btn-secondary" onclick="exportProducts()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="admin-grid">
            <!-- Price Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-dollar-sign"></i>
                    <h3>Gestión de Precios</h3>
                </div>
                
                <div class="input-group">
                    <label for="priceProductSelect">Producto:</label>
                    <select id="priceProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="newPrice">Nuevo Precio (COP):</label>
                    <input type="number" id="newPrice" step="100" min="0" placeholder="5000">
                </div>
                
                <div class="input-group">
                    <label for="priceReason">Razón del cambio:</label>
                    <input type="text" id="priceReason" placeholder="Actualización de mercado">
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn" onclick="updateSinglePrice()">
                        <i class="fas fa-edit"></i> Actualizar Precio
                    </button>
                    <button class="btn btn-secondary" onclick="viewPriceHistory()">
                        <i class="fas fa-history"></i> Ver Historial
                    </button>
                </div>

                <!-- Bulk Price Updates -->
                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">
                
                <div class="input-group">
                    <label for="categorySelect">Categoría para aumento masivo:</label>
                    <select id="categorySelect">
                        <option value="">Todas las categorías</option>
                        <option value="Bayas">Bayas</option>
                        <option value="Bananos">Bananos</option>
                        <option value="Cítricas">Cítricas</option>
                        <option value="Exóticas">Exóticas</option>
                        <option value="Frutas Dulces">Frutas Dulces</option>
                        <option value="Tropicales">Tropicales</option>
                        <option value="Uvas">Uvas</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="increasePercent">Porcentaje de aumento:</label>
                    <input type="number" id="increasePercent" step="0.1" min="0" max="50" placeholder="5.0">
                </div>
                
                <button class="btn btn-danger" onclick="applyBulkIncrease()">
                    <i class="fas fa-percentage"></i> Aplicar Aumento
                </button>
            </div>

            <!-- Inventory Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-boxes"></i>
                    <h3>Gestión de Inventario</h3>
                </div>
                
                <div class="input-group">
                    <label for="stockProductSelect">Producto:</label>
                    <select id="stockProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="stockChange">Cambio en stock (kg):</label>
                    <input type="number" id="stockChange" step="1" placeholder="+50 o -25">
                </div>
                
                <div class="input-group">
                    <label for="stockReason">Razón del cambio:</label>
                    <input type="text" id="stockReason" placeholder="Reposición de inventario">
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn btn-success" onclick="updateStock()">
                        <i class="fas fa-plus"></i> Actualizar Stock
                    </button>
                    <button class="btn btn-secondary" onclick="showLowStock()">
                        <i class="fas fa-exclamation-triangle"></i> Stock Bajo
                    </button>
                    <button class="btn" onclick="showAllProducts()">
                        <i class="fas fa-list"></i> Ver Todos los Productos
                    </button>
                </div>

                <div id="currentStock" class="mt-2">
                    <!-- Current stock info will appear here -->
                </div>
            </div>

            <!-- Product Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-cogs"></i>
                    <h3>Gestión de Productos</h3>
                </div>
                
                <div class="input-group">
                    <label for="manageProductSelect">Producto:</label>
                    <select id="manageProductSelect">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn btn-success" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                    <button class="btn" onclick="editSelectedProduct()">
                        <i class="fas fa-edit"></i> Editar Producto
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedProduct()">
                        <i class="fas fa-trash"></i> Eliminar Producto
                    </button>
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                <div class="input-group">
                    <label for="productStatus">Cambiar estado:</label>
                    <select id="productStatus">
                        <option value="">Seleccionar estado...</option>
                        <option value="active">Activar Producto</option>
                        <option value="inactive">Desactivar Producto</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="updateProductStatus()">
                    <i class="fas fa-toggle-on"></i> Cambiar Estado
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-lightning-bolt"></i>
                    <h3>Acciones Rápidas</h3>
                </div>
                
                <div class="flex flex-wrap">
                    <button class="btn" onclick="loadInventoryReport()">
                        <i class="fas fa-chart-bar"></i> Reporte Inventario
                    </button>
                    <button class="btn btn-secondary" onclick="loadDailyReport()">
                        <i class="fas fa-calendar-day"></i> Reporte Diario
                    </button>
                    <button class="btn btn-success" onclick="exportProducts()">
                        <i class="fas fa-download"></i> Exportar Datos
                    </button>
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid #e0e0e0;">

                <!-- CSV Import -->
                <div class="input-group">
                    <label for="csvFile">Importar precios desde CSV:</label>
                    <input type="file" id="csvFile" accept=".csv">
                    <small style="color: #666; font-size: 0.85rem;">
                        Formato: product_id, new_price, reason
                    </small>
                </div>
                
                <button class="btn btn-secondary" onclick="importPricesFromCSV()">
                    <i class="fas fa-upload"></i> Importar CSV
                </button>
            </div>

            <!-- Reports and Analytics -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    <h3>Reportes y Análisis</h3>
                </div>
                
                <div id="reportContainer">
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        <i class="fas fa-info-circle"></i>
                        Selecciona una acción para ver reportes
                    </p>
                </div>
            </div>
        </div>

        <!-- Modal for detailed views -->
        <div id="modal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        ">
            <div style="
                background: var(--glass-bg);
                backdrop-filter: saturate(140%) blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                padding: 2rem;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
                color: var(--txt);
            ">
                <button onclick="closeModal()" style="
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: var(--surface);
                    border: 1px solid var(--border);
                    font-size: 1.2rem;
                    cursor: pointer;
                    color: var(--txt);
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                ">
                    <i class="fas fa-times"></i>
                </button>
                <div id="modalContent">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="addProductModal" class="product-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeAddProductModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h3>
                    <button onclick="closeAddProductModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addProductForm" class="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productName">Nombre del Producto *</label>
                            <input type="text" id="productName" name="name" required 
                                   placeholder="Ej: Mango Tommy">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Categoría *</label>
                            <select id="productCategory" name="category" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="Cítricas">Cítricas</option>
                                <option value="Tropicales">Tropicales</option>
                                <option value="Bayas">Bayas</option>
                                <option value="Bananos">Bananos</option>
                                <option value="Exóticas">Exóticas</option>
                                <option value="Frutas Dulces">Frutas Dulces</option>
                                <option value="Uvas">Uvas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Precio por Kg (COP) *</label>
                            <input type="number" id="productPrice" name="price" required 
                                   min="100" step="100" placeholder="5000">
                        </div>
                        <div class="form-group">
                            <label for="productCost">Costo por Kg (COP)</label>
                            <input type="number" id="productCost" name="cost" 
                                   min="0" step="100" placeholder="3000">
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Inicial (Kg)</label>
                            <input type="number" id="productStock" name="stock" 
                                   min="0" step="1" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="productMinStock">Stock Mínimo (Kg)</label>
                            <input type="number" id="productMinStock" name="minStock" 
                                   min="0" step="1" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label for="productOrigin">Origen</label>
                            <input type="text" id="productOrigin" name="origin" 
                                   placeholder="Colombia" value="Colombia">
                        </div>
                        <div class="form-group">
                            <label for="productSupplier">Proveedor</label>
                            <input type="text" id="productSupplier" name="supplier" 
                                   placeholder="Nombre del proveedor">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productRating">Calificación</label>
                            <select id="productRating" name="rating">
                                <option value="5">⭐⭐⭐⭐⭐ (5.0)</option>
                                <option value="4.5">⭐⭐⭐⭐⭐ (4.5)</option>
                                <option value="4" selected>⭐⭐⭐⭐ (4.0)</option>
                                <option value="3.5">⭐⭐⭐⭐ (3.5)</option>
                                <option value="3">⭐⭐⭐ (3.0)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" name="description" rows="3" 
                                  placeholder="Descripción del producto..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="productImage">URL de la Imagen</label>
                        <input type="url" id="productImage" name="image" 
                               placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productOrganic" name="organic">
                            <span class="checkmark"></span>
                            Producto Orgánico
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="productActive" name="active" checked>
                            <span class="checkmark"></span>
                            Producto Activo
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddProductModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crear Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script type="module" src="./scripts/pages/adminDashboard.js"></script>
</body>
</html>