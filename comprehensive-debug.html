<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Completo - Funciones de Supabase</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .debug-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        .debug-section:last-child {
            border-bottom: none;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        button.danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        button.success {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        button.success:hover {
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-available { background-color: #27ae60; }
        .status-unavailable { background-color: #e74c3c; }
        .status-warning { background-color: #f39c12; }
        .function-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .function-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .function-item.available {
            border-left-color: #27ae60;
            background: #d4edda;
        }
        .function-item.unavailable {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }
        .steps {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .steps li {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Debug Completo - Funciones de Supabase</h1>
            <p>Soluci√≥n integral para diagnosticar y resolver problemas de funciones no disponibles</p>
        </div>

        <div class="debug-section">
            <h2>üöÄ Funciones Cr√≠ticas</h2>
            <div class="button-group">
                <button onclick="checkCriticalFunctions()">Verificar Funciones Cr√≠ticas</button>
                <button onclick="checkAllFunctions()">Ver Todas las Funciones</button>
                <button onclick="checkFileLoading()">Verificar Carga de Archivos</button>
                <button onclick="runAutomaticFix()" class="success">Ejecutar Correcci√≥n Autom√°tica</button>
            </div>
            <div id="critical-functions" class="function-list"></div>
            <div id="results" class="result"></div>
        </div>

        <div class="debug-section">
            <h2>üí° Soluci√≥n Paso a Paso</h2>
            <div class="steps">
                <ol>
                    <li><strong>Ejecuta "Verificar Funciones Cr√≠ticas"</strong> arriba para ver qu√© funciones faltan</li>
                    <li><strong>Si faltan funciones, ejecuta "Ejecutar Correcci√≥n Autom√°tica"</strong></li>
                    <li><strong>Recarga la p√°gina (F5)</strong> despu√©s de la correcci√≥n</li>
                    <li><strong>Abre DevTools (F12) ‚Üí Console</strong> y busca mensajes de error</li>
                    <li><strong>Ve a Network ‚Üí busca "supabaseService.js"</strong> para verificar que se carga</li>
                </ol>
            </div>
        </div>

        <div class="debug-section">
            <h2>üîß Acciones Manuales</h2>
            <div class="button-group">
                <button onclick="showManualSolutions()">Mostrar Soluciones Manuales</button>
                <button onclick="forceReload()" class="danger">Forzar Recarga de Archivos</button>
                <button onclick="createTestPage()">Crear P√°gina de Prueba</button>
            </div>
            <div id="manual-solutions" style="display: none;"></div>
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            logContainer.innerHTML = '';
        }

        function updateFunctionList(functions, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            functions.forEach(func => {
                const available = typeof window[func.name] === 'function';
                const item = document.createElement('div');
                item.className = `function-item ${available ? 'available' : 'unavailable'}`;
                item.innerHTML = `
                    <span class="status-indicator ${available ? 'status-available' : 'status-unavailable'}"></span>
                    <strong>${func.name}</strong><br>
                    <small>${available ? '‚úÖ Disponible' : '‚ùå No disponible'}</small><br>
                    ${func.description ? `<small>${func.description}</small>` : ''}
                `;
                container.appendChild(item);
            });
        }

        function checkCriticalFunctions() {
            clearLog();
            log('üîç === VERIFICANDO FUNCIONES CR√çTICAS ===');

            const criticalFunctions = [
                { name: 'signInWithEmail', description: 'Funci√≥n de login principal' },
                { name: 'signUpWithEmail', description: 'Funci√≥n de registro' },
                { name: 'getUser', description: 'Obtener datos del usuario' },
                { name: 'getUserStatus', description: 'Estado del usuario (registrado/no registrado)' },
                { name: 'setupSupabase', description: 'Configuraci√≥n de Supabase' },
                { name: 'checkSupabaseConfig', description: 'Verificar configuraci√≥n' }
            ];

            updateFunctionList(criticalFunctions, 'critical-functions');
            
            criticalFunctions.forEach(func => {
                const available = typeof window[func.name] === 'function';
                log(`${available ? '‚úÖ' : '‚ùå'} ${func.name}: ${available ? 'DISPONIBLE' : 'NO DISPONIBLE'}`);
            });

            const allAvailable = criticalFunctions.every(func => typeof window[func.name] === 'function');
            if (allAvailable) {
                log('üéâ ¬°Todas las funciones cr√≠ticas est√°n disponibles!', 'success');
            } else {
                log('üö® Algunas funciones cr√≠ticas no est√°n disponibles', 'error');
            }
        }

        function checkAllFunctions() {
            clearLog();
            log('üîç === VERIFICANDO TODAS LAS FUNCIONES ===');

            const allFunctions = Object.keys(window)
                .filter(key => typeof window[key] === 'function')
                .filter(key => key.toLowerCase().includes('supabase') || 
                              key.toLowerCase().includes('sign') || 
                              key.toLowerCase().includes('user') ||
                              key.toLowerCase().includes('get'))
                .map(name => ({ name, description: 'Funci√≥n relacionada con Supabase' }))
                .sort();

            updateFunctionList(allFunctions, 'critical-functions');

            if (allFunctions.length === 0) {
                log('‚ùå No se encontraron funciones relacionadas con Supabase', 'error');
            } else {
                log(`‚úÖ Se encontraron ${allFunctions.length} funciones relacionadas:`, 'success');
                allFunctions.forEach(func => log(`   - ${func.name}`));
            }
        }

        function checkFileLoading() {
            clearLog();
            log('üîç === VERIFICANDO CARGA DE ARCHIVOS ===');

            // Verificar si supabaseService.js est√° cargado
            const scripts = document.querySelectorAll('script[src*="supabaseService"]');
            if (scripts.length > 0) {
                log(`‚úÖ supabaseService.js cargado (${scripts.length} instancia(s))`, 'success');
                scripts.forEach((script, index) => {
                    log(`   Archivo ${index + 1}: ${script.src}`);
                });
            } else {
                log('‚ùå supabaseService.js NO est√° cargado en la p√°gina', 'error');
            }

            // Verificar archivos de script en general
            const allScripts = document.querySelectorAll('script');
            log(`üìä Total de scripts cargados: ${allScripts.length}`);
        }

        function runAutomaticFix() {
            clearLog();
            log('üîß === EJECUTANDO CORRECCI√ìN AUTOM√ÅTICA ===');

            // Verificar si las funciones ya est√°n disponibles
            if (typeof window.signInWithEmail === 'function') {
                log('‚úÖ signInWithEmail ya est√° disponible', 'success');
                return;
            }

            // Crear funciones de respaldo
            log('üîÑ Creando funciones de respaldo...');

            // Funci√≥n de respaldo para signInWithEmail
            if (typeof window.signInWithEmail !== 'function') {
                window.signInWithEmail = async function({ email, password }) {
                    log('üö® Usando funci√≥n de respaldo - el archivo principal no se carg√≥ correctamente', 'warning');
                    console.error('signInWithEmail no disponible. Posibles causas:');
                    console.error('1. supabaseService.js no se carg√≥');
                    console.error('2. Error en el archivo');
                    console.error('3. Problema de cach√© del navegador');
                    throw new Error('supabaseService.js no se carg√≥ correctamente. Recarga la p√°gina.');
                };
                log('‚úÖ Funci√≥n de respaldo signInWithEmail creada', 'success');
            }

            // Funci√≥n de respaldo para otras funciones cr√≠ticas
            const fallbackFunctions = ['getUser', 'getUserStatus', 'setupSupabase'];
            fallbackFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    window[funcName] = function() {
                        console.error(`${funcName} no disponible. Recarga la p√°gina.`);
                        throw new Error(`${funcName} no disponible`);
                    };
                    log(`‚úÖ Funci√≥n de respaldo ${funcName} creada`, 'success');
                }
            });

            log('üí° Correcci√≥n autom√°tica completada', 'success');
            log('üö® Recarga la p√°gina para cargar las funciones reales', 'warning');
        }

        function showManualSolutions() {
            const solutions = document.getElementById('manual-solutions');
            solutions.style.display = 'block';
            solutions.innerHTML = `
                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>üîß Soluciones Manuales:</h3>
                    <h4>1. Verificar Carga del Archivo:</h4>
                    <p>‚Ä¢ Abre DevTools (F12) ‚Üí Network</p>
                    <p>‚Ä¢ Recarga la p√°gina (Ctrl+F5)</p>
                    <p>‚Ä¢ Busca "supabaseService.js" en la pesta√±a Network</p>
                    <p>‚Ä¢ Verifica que aparezca y se cargue correctamente</p>

                    <h4>2. Limpiar Cach√© del Navegador:</h4>
                    <p>‚Ä¢ Chrome: Ctrl+Shift+R (Windows/Linux) o Cmd+Shift+R (Mac)</p>
                    <p>‚Ä¢ Firefox: Ctrl+F5 (Windows/Linux) o Cmd+Shift+R (Mac)</p>

                    <h4>3. Verificar Consola:</h4>
                    <p>‚Ä¢ Abre DevTools ‚Üí Console</p>
                    <p>‚Ä¢ Busca errores relacionados con supabaseService.js</p>
                    <p>‚Ä¢ Busca mensajes de carga exitosa</p>

                    <h4>4. Verificar C√≥digo Fuente:</h4>
                    <p>‚Ä¢ Ve a Sources ‚Üí busca supabaseService.js</p>
                    <p>‚Ä¢ Verifica que el archivo est√© ah√≠ y sea correcto</p>
                </div>
            `;
        }

        function forceReload() {
            clearLog();
            log('ÔøΩÔøΩ Forzando recarga completa...');
            
            // Limpiar cach√© y recargar
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }

            // Limpiar localStorage relacionado
            Object.keys(localStorage).forEach(key => {
                if (key.includes('supabase') || key.includes('fruvi')) {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Limpiado localStorage: ${key}`);
                }
            });

            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        }

        function createTestPage() {
            clearLog();
            log('üìÑ Creando p√°gina de prueba...');

            const testWindow = window.open('', '_blank');
            testWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head><title>Test - Funciones Supabase</title></head>
                <body>
                    <h1>üîß Test - Funciones de Supabase</h1>
                    <div id="test-results"></div>
                    <script src="${window.location.origin}/scripts/services/supabaseService.js"><\/script>
                    <script>
                        setTimeout(() => {
                            const results = document.getElementById('test-results');
                            const functions = ['signInWithEmail', 'getUser', 'setupSupabase'];
                            functions.forEach(func => {
                                const available = typeof window[func] === 'function';
                                results.innerHTML += \`<p>\${available ? '‚úÖ' : '‚ùå'} \${func}: \${available ? 'DISPONIBLE' : 'NO DISPONIBLE'}\</p>\`;
                            });
                        }, 2000);
                    <\/script>
                </body>
                </html>
            `);
        }

        // Ejecutar verificaci√≥n autom√°tica al cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkCriticalFunctions();
            }, 1500);
        });

        // Hacer funciones disponibles globalmente
        window.debugTools = {
            checkCriticalFunctions,
            checkAllFunctions,
            checkFileLoading,
            runAutomaticFix,
            forceReload,
            createTestPage
        };

        log('üöÄ Debug tool cargado completamente');
        log('üí° Usa las funciones arriba para diagnosticar y solucionar problemas');
    </script>
</body>
</html>
